============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.2.0, pluggy-1.6.0 -- /home/francoisosmozis/hippique-orchestrator/.venv/bin/python
cachedir: .pytest_cache
rootdir: /home/francoisosmozis/hippique-orchestrator
configfile: pytest.ini
testpaths: tests
plugins: anyio-4.12.1, pyfakefs-6.0.0, cov-7.0.0, mock-3.14.0, asyncio-0.23.7
asyncio: mode=Mode.STRICT
collecting ... collected 1144 items

tests/hippique/utils/test_probabilities.py::test_implied_prob_from_odds_valid_input PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_implied_prob_from_odds_invalid_input PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_no_vig_probs_valid_input PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_no_vig_probs_empty_list PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_no_vig_probs_invalid_odds_in_list PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_expected_value_simple_positive_ev PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_expected_value_simple_negative_ev PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_expected_value_simple_zero_ev PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_expected_value_simple_various_stakes PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_expected_value_simple_edge_cases PASSED [  0%]
tests/providers/test_geny_provider.py::test_geny_provider_initialization 
-------------------------------- live log setup --------------------------------
2026-01-11 22:09:40 [INFO] GenyProvider initialized.
PASSED                                                                   [  0%]
tests/providers/test_geny_provider.py::test_fetch_stats_for_runner_returns_stats 
-------------------------------- live log setup --------------------------------
2026-01-11 22:09:40 [INFO] GenyProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 22:09:40 [INFO] Fetching Geny stats for: Y. LEBOURGEOIS
2026-01-11 22:09:40 [INFO] Stats parsées depuis Geny: {'driver_rate': 0.155}
PASSED                                                                   [  1%]
tests/providers/test_geny_provider.py::test_fetch_stats_for_runner_handles_no_driver 
-------------------------------- live log setup --------------------------------
2026-01-11 22:09:40 [INFO] GenyProvider initialized.
PASSED                                                                   [  1%]
tests/providers/test_geny_provider.py::test_fetch_stats_for_runner_handles_fetch_failure 
-------------------------------- live log setup --------------------------------
2026-01-11 22:09:40 [INFO] GenyProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 22:09:40 [INFO] Fetching Geny stats for: Y. LEBOURGEOIS
2026-01-11 22:09:40 [WARNING] Impossible de récupérer la page pour Y. LEBOURGEOIS sur Geny.
PASSED                                                                   [  1%]
tests/providers/test_geny_provider.py::test_fetch_stats_uses_cache 
-------------------------------- live log setup --------------------------------
2026-01-11 22:09:40 [INFO] GenyProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 22:09:40 [INFO] Fetching Geny stats for: Y. LEBOURGEOIS
2026-01-11 22:09:40 [INFO] Stats parsées depuis Geny: {'driver_rate': 0.155}
PASSED                                                                   [  1%]
tests/providers/test_zeturf_provider.py::test_zeturf_provider_initialization PASSED [  1%]
tests/providers/test_zeturf_provider.py::test_fetch_snapshot_returns_normalized_data 
-------------------------------- live log call ---------------------------------
2026-01-11 22:09:40 [INFO] Début du scraping ZEturf: https://www.zeturf.fr/fr/course/2024-01-11/R1C1-prix-de-la-course
PASSED                                                                   [  1%]
tests/providers/test_zeturf_provider.py::test_fetch_snapshot_handles_http_error 
-------------------------------- live log call ---------------------------------
2026-01-11 22:09:40 [INFO] Début du scraping ZEturf: https://www.zeturf.fr/fr/course/2024-01-11/R1C1-prix-de-la-course
2026-01-11 22:09:40 [ERROR] Failed to create RaceSnapshotNormalized for https://www.zeturf.fr/fr/course/2024-01-11/R1C1-prix-de-la-course: HTTP 404
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/sources/zeturf_provider.py", line 48, in _fetch_race_snapshot_sync
    html_content = self._http_get_sync(race_url)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
RuntimeError: HTTP 404
PASSED                                                                   [  1%]
tests/providers/test_zeturf_provider.py::test_fetch_snapshot_handles_empty_runners 
-------------------------------- live log call ---------------------------------
2026-01-11 22:09:40 [INFO] Début du scraping ZEturf: https://www.zeturf.fr/fr/course/2024-01-11/R1C1-prix-de-la-course
2026-01-11 22:09:40 [ERROR] Failed to create RaceSnapshotNormalized for https://www.zeturf.fr/fr/course/2024-01-11/R1C1-prix-de-la-course: No runners found in snapshot data.
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/sources/zeturf_provider.py", line 52, in _fetch_race_snapshot_sync
    raise ValueError("No runners found in snapshot data.")
ValueError: No runners found in snapshot data.
PASSED                                                                   [  1%]
tests/providers/test_zeturf_provider.py::test_fetch_stats_for_runner_returns_empty_stats PASSED [  1%]
tests/scripts/test_monitor_roi.py::test_load_json_safe_success PASSED    [  1%]
tests/scripts/test_monitor_roi.py::test_load_json_safe_failure PASSED    [  1%]
tests/scripts/test_monitor_roi.py::test_parse_tracking_csv_success PASSED [  2%]
tests/scripts/test_monitor_roi.py::test_collect_analyses_no_date_filter PASSED [  2%]
tests/scripts/test_monitor_roi.py::test_collect_analyses_with_date_filter PASSED [  2%]
tests/scripts/test_monitor_roi.py::test_compute_statistics PASSED        [  2%]
tests/scripts/test_monitor_roi.py::test_compute_statistics_no_races_played PASSED [  2%]
tests/scripts/test_monitor_roi.py::test_print_report PASSED              [  2%]
tests/scripts/test_monitor_roi.py::test_export_json PASSED               [  2%]
tests/scripts/test_monitor_roi.py::test_main_run_once PASSED             [  2%]
tests/scripts/test_online_fetch_zeturf.py::test_fallback_parse_html_extracts_data PASSED [  2%]
tests/scripts/test_online_fetch_zeturf.py::test_normalise_rc_tag[R1-C1-R1C1] PASSED [  2%]
tests/scripts/test_online_fetch_zeturf.py::test_normalise_rc_tag[1-2-R1C2] PASSED [  2%]
tests/scripts/test_online_fetch_zeturf.py::test_normalise_rc_tag[R4C5-None-R4C5] PASSED [  2%]
tests/scripts/test_online_fetch_zeturf.py::test_normalise_rc_tag_raises_error PASSED [  3%]
tests/scripts/test_online_fetch_zeturf.py::test_coerce_runner_entry PASSED [  3%]
tests/scripts/test_online_fetch_zeturf.py::test_build_snapshot_payload PASSED [  3%]
tests/scripts/test_online_fetch_zeturf.py::test_fetch_race_snapshot_cli 
-------------------------------- live log call ---------------------------------
2026-01-11 22:09:40 [INFO] [CLI] snapshot chargé depuis snapshot.json
PASSED                                                                   [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalise_rc_tag_valid[1-2-R1C2] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalise_rc_tag_valid[R1-C2-R1C2] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalise_rc_tag_valid[R3-10-R3C10] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalise_rc_tag_valid[4-5-R4C5] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_slugify_hippodrome PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalize_decimal[12,5-12.5] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalize_decimal[15.5-15.5] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalize_decimal[20-20.0] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalize_decimal[abc-None] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalize_decimal[None-None] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_fallback_parse_html_extracts_data PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_fallback_parse_html_data_odd_attribute PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_fallback_parse_html_no_cotes_infos_script PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_fallback_parse_html_missing_cheval PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_fallback_parse_html_no_tbody PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw0-expected0] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw1-expected1] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw2-expected2] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw3-expected3] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw4-expected4] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw5-None] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw6-None] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw7-expected7] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_fallback_parse_html_no_runners_table PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_fallback_parse_html_runner_missing_data PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw0-expected0] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw1-expected1] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw2-expected2] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw3-expected3] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw4-expected4] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw5-expected5] PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw6-expected6] PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw7-expected7] PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw8-None] PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw9-expected9] PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_invalid_input PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_normalise_snapshot_result_merges_h30_odds PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_normalise_snapshot_result_no_market PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_http_get_raises_on_403 PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_http_get_raises_on_suspicious_html PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_parsing.py::test_double_extract_parses_real_html_fixture 
-------------------------------- live log call ---------------------------------
2026-01-11 22:09:41 [WARNING] [ZEturf] Extraction fallback utilisée pour https://www.zeturf.fr/fr/course/2025-11-20/R1C1 (snapshot=H-30)
2026-01-11 22:09:41 [INFO] [ZEturf] phase=H30 url=https://www.zeturf.fr/fr/course/2025-11-20/R1C1-saint-galmier partants=12
PASSED                                                                   [  6%]
tests/scripts/test_online_fetch_zeturf_parsing.py::test_fallback_parse_no_runners_table_finds_no_runners PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_parsing.py::test_fallback_parse_no_script_finds_no_odds PASSED [  7%]
tests/scripts/test_online_fetch_zeturf_parsing.py::test_fallback_parse_no_data_finds_nothing PASSED [  7%]
tests/scripts/test_online_fetch_zeturf_parsing.py::test_double_extract_uses_fallback 
-------------------------------- live log call ---------------------------------
2026-01-11 22:09:43 [WARNING] [ZEturf] Champ clé manquant: meeting (url=http://example.com, snapshot=H-30)
2026-01-11 22:09:43 [WARNING] [ZEturf] Champ clé manquant: discipline (url=http://example.com, snapshot=H-30)
2026-01-11 22:09:43 [WARNING] [ZEturf] Champ clé manquant: partants (url=http://example.com, snapshot=H-30)
2026-01-11 22:09:43 [WARNING] [ZEturf] Aucun partant détecté (url=http://example.com, snapshot=H-30) — retournera une liste vide
2026-01-11 22:09:43 [WARNING] [ZEturf] Extraction fallback utilisée pour http://example.com (snapshot=H-30)
PASSED                                                                   [  7%]
tests/scripts/test_simulate_ev_script.py::test_implied_prob_valid PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_implied_prob_invalid PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_normalize_overround_basic PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_normalize_overround_with_invalids PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_normalize_overround_zero_total PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_normalize_overround_empty PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_implied_probs_list PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_implied_probs_with_invalid_odds PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_allocate_dutching_sp_ideal PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_allocate_dutching_sp_fallback_prob PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_allocate_dutching_sp_stake_capping PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_allocate_dutching_sp_min_stake_filter PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_allocate_dutching_sp_no_valid_runners PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_gate_ev_all_pass PASSED   [  8%]
tests/scripts/test_simulate_ev_script.py::test_gate_ev_sp_fails PASSED   [  8%]
tests/scripts/test_simulate_ev_script.py::test_gate_ev_combo_fails PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_gate_ev_risk_fails_both PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_gate_ev_sharpe_fails_both PASSED [  8%]
tests/scripts/test_simulate_wrapper_script.py::test_load_calibration_reloads_on_file_change PASSED [  8%]
tests/scripts/test_simulate_wrapper_script.py::test_empty_or_invalid_calibration_file 
-------------------------------- live log call ---------------------------------
2026-01-11 22:09:43 [WARNING] Could not load or parse calibration file /etc/config/probabilities.yaml: mapping values are not allowed here
  in "/etc/config/probabilities.yaml", line 1, column 11
PASSED                                                                   [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_simulate_wrapper_fallback_no_correlation PASSED [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_correlation_penalty_defaults_gracefully PASSED [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_simulate_wrapper_applies_correlation_penalty PASSED [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_monte_carlo_is_used_when_numpy_present PASSED [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_monte_carlo_is_skipped_when_numpy_missing PASSED [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_evaluate_combo_calls_dependencies_and_returns_results PASSED [  9%]
tests/scripts/test_update_excel_with_results.py::test_as_float PASSED    [  9%]
tests/scripts/test_update_excel_with_results.py::test_normalise_notes PASSED [  9%]
tests/scripts/test_update_excel_with_results.py::test_upsert_row PASSED  [  9%]
tests/scripts/test_update_excel_with_results_script.py::test_update_creates_new_excel_and_sheets PASSED [  9%]
tests/scripts/test_update_excel_with_results_script.py::test_update_upserts_existing_row PASSED [  9%]
tests/test__debug_mock_firestore.py::test__debug_mock_firestore_types PASSED [ 10%]
tests/test_analysis_drift.py::test_drift_is_detected_and_applied FAILED  [ 10%]

=================================== FAILURES ===================================
______________________ test_drift_is_detected_and_applied ______________________

mocker = <pytest_mock.plugin.MockerFixture object at 0x7c3915bdf830>

    @pytest.mark.asyncio
    async def test_drift_is_detected_and_applied(mocker):
        """
        Ensures that when an H-5 analysis is run, it finds the H-30 snapshot,
        loads it, and the final analysis shows a non-stable drift status.
        """
        # 1. Mock GCS client
        mock_gcs_client = mocker.patch("hippique_orchestrator.analysis_pipeline.gcs_client")
    
        # Mock file listing to find the H-30 snapshot
        mock_gcs_client.list_files.return_value = ["data/R1C1/snapshots/20250101_120000_H-30.json"]
    
        # Mock file reading to return different content based on path
        def mock_read_file(path):
            if "_H-30.json" in path:
                return json.dumps(H30_SNAPSHOT)
            if "gpi_v52.yml" in path:
                return GPI_CONFIG_YAML
            # For the H-5 snapshot itself and stats, return the H-5 data
            return json.dumps(H5_SNAPSHOT)
    
        mock_gcs_client.read_file_from_gcs.side_effect = mock_read_file
    
>       mocker.patch(
            "hippique_orchestrator.analysis_pipeline.source_registry.fetch_stats_for_runner",
            return_value={"mock_stats": "stats.json"},
        )

tests/test_analysis_drift.py:76: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/pytest_mock/plugin.py:440: in __call__
    return self._start_patch(
.venv/lib/python3.12/site-packages/pytest_mock/plugin.py:258: in _start_patch
    mocked: MockType = p.start()
/usr/lib/python3.12/unittest/mock.py:1606: in start
    result = self.__enter__()
/usr/lib/python3.12/unittest/mock.py:1458: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7c3915b94f50>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <hippique_orchestrator.source_registry.SourceRegistry object at 0x7c392d775430> does not have the attribute 'fetch_stats_for_runner'

/usr/lib/python3.12/unittest/mock.py:1431: AttributeError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768165783.5558238, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768165784.103947, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
=========================== short test summary info ============================
FAILED tests/test_analysis_drift.py::test_drift_is_detected_and_applied - AttributeError: <hippique_orchestrator.source_registry.SourceRegistry object at 0x7c392d775430> does not have the attribute 'fetch_stats_for_runner'
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
======================== 1 failed, 115 passed in 8.28s =========================
