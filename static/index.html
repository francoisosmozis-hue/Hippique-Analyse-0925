<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Pronostics Hippiques</title>
</head>
<body>
  <h1>Pronostics Hippiques</h1>

  <div>
    <label for="date-input">Date :</label>
    <input type="date" id="date-input" />
    <button id="btn-load">Charger</button>
  </div>

  <div id="results">Chargement des pronostics...</div>

  <script>
    let lastUpdated = null;
    let lastTotalRaces = 0;
    let currentDate = null;

    function renderPronostics(data, date) {
      const container = document.getElementById("results");
      const races = data.pronostics || [];
      if (!races.length) {
        container.textContent = "Aucun pronostic disponible pour la date " + (data.date || date || "inconnue") + ".";
        return;
      }

      container.innerHTML = "";

      const title = document.createElement("h2");
      title.textContent = "Pronostics du " + (data.date || date || "inconnue") + " (dernière mise à jour: " + new Date(data.last_updated).toLocaleTimeString() + ")";
      container.appendChild(title);

      races.forEach((race) => {
        const block = document.createElement("div");
        block.style.border = "1px solid #ccc";
        block.style.margin = "8px 0";
        block.style.padding = "8px";

        const header = document.createElement("h3");
        header.textContent =
          "Course " + (race.rc || "") +
          " – décision : " + (race.gpi_decision || race.decision || "N/A");
        block.appendChild(header);

        const pre = document.createElement("pre");
        pre.textContent = JSON.stringify(race.tickets || race, null, 2);
        block.appendChild(pre);

        container.appendChild(block);
      });
    }

    async function loadPronostics(date) {
      const container = document.getElementById("results");
      container.textContent = "Chargement des pronostics...";
      currentDate = date; 

      let url = "/pronostics";
      if (date) {
        url += "?date=" + encodeURIComponent(date);
      }

      try {
        const res = await fetch(url);
        if (!res.ok) {
          container.textContent = "Erreur lors du chargement des pronostics (HTTP " + res.status + ").";
          return;
        }

        const data = await res.json();
        if (!data || data.ok === false) {
          container.textContent = "Erreur : la réponse de l'API est invalide.";
          return;
        }
        
        lastUpdated = data.last_updated;
        lastTotalRaces = data.total_races;
        renderPronostics(data, date);

      } catch (err) {
        console.error(err);
        container.textContent = "Erreur technique lors du chargement des pronostics.";
      }
    }

    async function checkForUpdates() {
      let url = "/pronostics";
      if (currentDate) {
        url += "?date=" + encodeURIComponent(currentDate);
      }
      
      try {
        const res = await fetch(url);
        if (!res.ok) {
          console.warn("Check for updates failed (HTTP " + res.status + ")");
          return;
        }
        const data = await res.json();
        if (data && data.ok && (data.last_updated !== lastUpdated || data.total_races !== lastTotalRaces)) {
          console.log("Mise à jour détectée. Rechargement des pronostics.", {new_ts: data.last_updated, old_ts: lastUpdated, new_total: data.total_races, old_total: lastTotalRaces });
          loadPronostics(currentDate);
        }
      } catch (err) {
        console.error("Error checking for updates:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("date-input");
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const todayStr = `${year}-${month}-${day}`;
      
      input.value = todayStr;
      currentDate = todayStr;
      
      loadPronostics(currentDate);

      const btn = document.getElementById("btn-load");
      if (btn && input) {
        btn.addEventListener("click", () => {
          const value = input.value;
          loadPronostics(value || null);
        });
      }

      setInterval(checkForUpdates, 15000); // Vérifie toutes les 15 secondes
    });
  </script>
</body>
</html>