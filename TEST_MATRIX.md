# Matrice de Tests et Couverture - Hippique Orchestrator

Ce document détaille la couverture de code actuelle des principaux composants du projet `hippique-orchestrator`, identifie les risques associés et propose des priorités d'amélioration.

**Date de l'analyse :** 2026-01-06
**Couverture globale du package `hippique_orchestrator` :** 77% (sur une exécution unique)

## Observations Préliminaires

*   **Stabilité des tests :** La vérification de la stabilité des tests sur 10 exécutions consécutives (anti-flakiness) n'a pas pu être finalisée en raison de contraintes de délai d'exécution. Bien que tous les tests aient réussi lors de l'exécution unique, la détection de tests "flaky" reste une inconnue à ce stade.
*   **Objectifs atteints :** Les modules `plan.py`, `firestore_client.py` et `analysis_pipeline.py`, ainsi que les scrapers (`boturfers.py`, `geny.py`, `zeturf.py`), atteignent ou dépassent l'objectif de >80% de couverture, ce qui est un excellent point de départ.

## Matrice Détaillée

| Composant (chemin relatif depuis `hippique_orchestrator/`)           | Risque   | Tests existants (% couverture) | Tests manquants                                                                                                | KPI Cible | Effort d'Amélioration | Priorité |
| :------------------------------------------------------------------- | :------- | :----------------------------- | :------------------------------------------------------------------------------------------------------------- | :-------- | :-------------------- | :------- |
| `analysis_pipeline.py`                                               | Faible   | 99%                            | Scénarios d'erreur marginaux (1 ligne non couverte).                                                         | >80%      | Faible                | Haute    |
| `plan.py`                                                            | Faible   | 100%                           | Aucun.                                                                                                         | >80%      | N/A                   | Haute    |
| `firestore_client.py`                                                | Faible   | 100%                           | Aucun.                                                                                                         | >80%      | N/A                   | Haute    |
| `ev_calculator.py`                                                   | Faible   | 91%                            | Cas limites de calcul, branches conditionnelles non explorées.                                                 | >80%      | Faible                | Moyenne  |
| `fetch_je_stats.py`                                                  | Faible   | 89%                            | Branches conditionnelles, gestion d'erreurs spécifiques.                                                       | >80%      | Faible                | Moyenne  |
| `pipeline_run.py`                                                    | Faible   | 96%                            | Branches complexes de la logique de pipeline.                                                                  | >80%      | Faible                | Haute    |
| `runner.py`                                                          | Faible   | 93%                            | Scénarios d'erreur spécifiques, gestion des exceptions.                                                        | >80%      | Faible                | Moyenne  |
| `scheduler.py`                                                       | Faible   | 100%                           | Aucun.                                                                                                         | >80%      | N/A                   | Moyenne  |
| `snapshot_manager.py`                                                | Faible   | 100%                           | Aucun.                                                                                                         | >80%      | N/A                   | Moyenne  |
| `stats_fetcher.py`                                                   | Faible   | 99%                            | Branches conditionnelles très spécifiques.                                                                     | >80%      | Faible                | Moyenne  |
| `stats_provider.py`                                                  | Faible   | 91%                            | Branches de traitement des données, cas d'erreurs non explorés.                                                | >80%      | Faible                | Moyenne  |
| `tickets_store.py`                                                   | Faible   | 99%                            | 1 ligne non couverte.                                                                                          | >80%      | Faible                | Basse    |
| `validator_ev.py`                                                    | Faible   | 88%                            | Validations complexes, chemins d'erreur.                                                                       | >80%      | Faible                | Moyenne  |
| `zoneturf_client.py`                                                 | Faible   | 93%                            | Scénarios d'échec de scraping spécifiques.                                                                     | >80%      | Faible                | Moyenne  |
| `scrapers/boturfers.py`                                              | Faible   | 95%                            | Branches conditionnelles, gestion d'erreurs lors du parsing HTML.                                              | >80%      | Faible                | Haute    |
| `scrapers/geny.py`                                                   | Faible   | 96%                            | Scénarios d'erreur de scraping.                                                                                | >80%      | Faible                | Haute    |
| `scrapers/zeturf.py`                                                 | Faible   | 100%                           | Aucun.                                                                                                         | >80%      | N/A                   | Haute    |
| `scripts/backup_restore.py`                                          | Moyen    | 92%                            | Logique de restauration, gestion d'erreurs.                                                                    | >80%      | Faible                | Moyenne  |
| `scripts/concat_je_month.py`                                         | Faible   | 94%                            | Traitement des fichiers CSV, cas limites de parsing.                                                           | >80%      | Faible                | Basse    |
| `scripts/cron_decider.py`                                            | Faible   | 98%                            | Logique de décision pour les tâches planifiées.                                                                | >80%      | Faible                | Moyenne  |
| `scripts/monitor_roi.py`                                             | Moyen    | 88%                            | Branches de reporting, gestion des analyses vides.                                                             | >80%      | Faible                | Moyenne  |
| `scripts/online_fetch_zeturf.py`                                     | Élevé    | 60%                            | Très faible couverture. **Potentiellement obsolète ?** À évaluer.                                            | >80%      | Élevé                 | Basse    |
| `scripts/p_finale_export.py`                                         | Élevé    | 56%                            | Logique d'exportation CSV/Excel, gestion d'erreurs.                                                            | >80%      | Élevé                 | Moyenne  |
| `scripts/resolve_course_id.py`                                       | Élevé    | 59%                            | Logique de résolution d'IDs, parsing d'URLs.                                                                   | >80%      | Élevé                 | Moyenne  |
| `scripts/simulate_ev.py`                                             | Moyen    | 72%                            | Logique de simulation EV, chemins alternatifs.                                                                 | >80%      | Moyen                 | Moyenne  |
| `scripts/simulate_wrapper.py`                                        | Moyen    | 67%                            | Logique de simulation complexe, gestion des paramètres, cas d'erreurs.                                         | >80%      | Élevé                 | Moyenne  |
| `scripts/update_excel_planning.py`                                   | Moyen    | 86%                            | Divers scénarios de mise à jour Excel, gestion des formats.                                                    | >80%      | Faible                | Moyenne  |
| `scripts/update_excel_with_results.py`                               | Moyen    | 82%                            | Gestion des résultats, écriture Excel.                                                                         | >80%      | Faible                | Moyenne  |
| `service.py`                                                         | Faible   | 88%                            | Branches API, gestion des requêtes, chemins d'erreur.                                                          | >80%      | Faible                | Haute    |
| `time_utils.py`                                                      | Élevé    | 69%                            | Fonctions de manipulation de temps, cas limites de formats.                                                    | >80%      | Moyen                 | Basse    |
| Modules de scripts à 0% (`drive_sync.py`, `enrich_requirements.py`, `fetch_je_chrono.py`, `fetch_je_stats.py`, `gcs_utils.py`, `lint_sources.py`, `merge_all_data.py`, `snapshot_enricher.py`, `restore_from_drive.py`) | Élevé    | 0%                             | Totalement non testé.                                                                                          | N/A       | À Évaluer             | Basse    |
| `config/env_utils.py` (hors `hippique_orchestrator/`)                 | N/A      | N/A                            | **Hors du scope** de la commande de couverture `pytest --cov=hippique_orchestrator`. Sa couverture n'a pas été évaluée dans ce rapport.                                                                                               | >80%      | Moyen                 | Moyenne  |

## Recommandations Immédiates

1.  **Validation de la Stabilité :** La priorité absolue est de mettre en place un mécanisme fiable pour confirmer l'absence de tests "flaky". Cela pourrait impliquer l'exécution de la suite de tests N fois via un script CI/CD dédié qui ne sera pas soumis aux mêmes contraintes de timeout interactives.
2.  **Évaluation des Scripts à Faible/0% de Couverture :** Avant d'investir dans l'écriture de tests, il est essentiel de déterminer la pertinence et l'usage actuel des scripts affichant une couverture très faible ou nulle. Certains pourraient être obsolètes et être supprimés, d'autres nécessiteraient une couverture prioritaire s'ils sont essentiels au fonctionnement.
3.  **Amélioration de la Couverture ciblée :** Après l'évaluation des scripts, cibler les modules à risque moyen/élevé mais d'importance moyenne/haute, notamment `scripts/online_fetch_zeturf.py`, `scripts/p_finale_export.py`, `scripts/resolve_course_id.py`, `scripts/simulate_ev.py`, `scripts/simulate_wrapper.py` et `time_utils.py` pour atteindre l'objectif de 80%.
