# Matrice de Test - Hippique Orchestrator

Cette matrice identifie les composants clés du système, les risques associés, les stratégies de test pour mitiger ces risques, les indicateurs de succès (KPI), et la priorité de chaque test.

| Composant | Risque Principal | Tests Proposés | KPI de Succès | Mode | Effort | Priorité |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **UI - Frontend** | L'interface utilisateur est cassée ou ne communique pas correctement avec l'API. | 1. **Accès page principale** : `GET /pronostics` renvoie 200 avec un contenu HTML valide. <br> 2. **Cohérence API** : Le code JS dans `index.html` cible bien `/api/pronostics`. <br> 3. **Redirections legacy** : `GET /pronostics/ui` et `/api/pronostics/ui` redirigent (307/308) et ne renvoient pas de 404. | 100% des tests UI passent. | Intégration (TestClient) / E2E (smoke) | Faible | **Élevée** |
| **API - `GET /api/pronostics`** | L'endpoint principal renvoie des données incorrectes, mal formées, ou lève une erreur inattendue. | 1. **Succès nominal** : `GET /api/pronostics?date=YYYY-MM-DD` renvoie 200 avec un schéma JSON valide. <br> 2. **Gestion date invalide** : `GET /api/pronostics?date=bad-date` renvoie 422. <br> 3. **Cache ETag** : Un deuxième appel avec `If-None-Match` renvoie 304. <br> 4. **Fusion données** : Le résultat agrège correctement les données du "plan" et de Firestore (mocké). | 100% des tests API passent. Schéma de réponse validé. | Intégration | Moyen | **Critique** |
| **Orchestration - `POST /schedule`** | La planification des tâches échoue ou est non sécurisée. | 1. **Sécurité (sans clé)** : `POST /schedule` sans `X-API-KEY` renvoie 401/403. <br> 2. **Sécurité (clé invalide)** : `POST /schedule` avec une clé API incorrecte renvoie 401/403. <br> 3. **Succès nominal (DRY_RUN)** : Avec une clé valide et `dry_run=true`, renvoie 200 et un rapport des tâches qui auraient été créées. <br> 4. **Validation de la charge utile** : Le client Cloud Tasks (mocké) est appelé avec les bons paramètres (service_url, phase, etc.). | 100% des scénarios de sécurité et de succès nominal passent. | Intégration / E2E (smoke) | Moyen | **Critique** |
| **Worker - `POST /tasks/run-phase`** | Le traitement d'une tâche d'analyse échoue silencieusement ou est non sécurisé. | 1. **Sécurité (sans token)** : Appel sans token OIDC renvoie 401/403. <br> 2. **Succès nominal** : Avec un token OIDC valide (mocké), l'appel déclenche `analysis_pipeline` et met à jour Firestore (mocké). <br> 3. **Gestion d'erreur** : Si `analysis_pipeline` échoue, l'endpoint renvoie 500 et enregistre un statut d'erreur dans Firestore (mocké). | 100% des scénarios de sécurité et de traitement passent. | Intégration | Moyen | **Élevée** |
| **Pipeline d'Analyse** | La logique métier (calculs, décisions) est incorrecte. | 1. **Drift H-30/H-5** : Avec des fixtures de cotes différentes, le statut de drift est correctement calculé. <br> 2. **GPI/config** : Le pipeline respecte les seuils de la configuration (budget, caps). <br> 3. **Robustesse scraper** : Si le parsing des données d'entrée (fixture HTML) échoue, le résultat est un statut "error" explicite. <br> 4. **Mapping ID** : L'ID de document (`{date}_R?C?`) est généré de manière stable et prédictible (en figeant le temps). | 100% des tests unitaires de la logique métier passent. | Unitaire | Élevé | **Élevée** |
| **Dépendances Externes** | Le code est trop couplé aux services externes (scraping, Firestore, Tasks), rendant les tests non déterministes. | 1. **Isolation Scraper** : Créer un mode `DRY_RUN` qui force la lecture de fixtures HTML locales. <br> 2. **Isolation BDD** : Mocker `firestore_client` pour retourner des données contrôlées et intercepter les écritures. <br> 3. **Isolation Scheduler** : Mocker le client Cloud Tasks pour intercepter la création de tâches. | 100% des tests peuvent être exécutés sans accès réseau. | Unitaire / Intégration | Moyen | **Critique** |
| **Opérations - `/ops/*`**| Les endpoints d'opérations manuelles sont non sécurisés ou ne fonctionnent pas comme prévu. | 1. **Sécurité `ops/run`** : `POST /ops/run` sans `X-API-KEY` renvoie 401/403. <br> 2. **Cible non trouvée** : `POST /ops/run` avec un `rc` inexistant renvoie 404. <br> 3. **Succès `ops/run`** : Appel valide déclenche l'analyse et renvoie un statut de succès. <br> 4. **Statut `ops/status`** : `GET /ops/status` renvoie un statut de traitement cohérent avec les données mockées. | 100% des tests ops passent. | Intégration | Faible | Moyenne |
