# Matrice de Tests - Hippique Orchestrator

Ce document détaille la stratégie de test pour chaque composant majeur du projet, en identifiant les risques, les tests existants, les tests manquants et les indicateurs de performance clés (KPIs).

| Composant | Risque Principal | Tests Existants (Résumé) | Tests Manquants Critiques | KPI de Qualité | Effort | Priorité |
|---|---|---|---|---|---|---|
| **API Publique (/api/pronostics)** | - Contrat de données instable<br>- Régression sur le format de sortie | - `test_api_pronostics_date_validation`<br>- `test_api_pronostics_default_date_is_today`<br>- `test_api_pronostics_empty_response`<br>- `test_api_pronostics_rich_response_structure`<br>- `test_api_pronostics_etag_304_not_modified` | - **Validation de schéma JSON stricte** sur la réponse pour détecter toute régression. | - 100% de conformité au schéma | Faible | **5** |
| **UI (/pronostics)** | - Dépendance forte à l'API<br>- Erreur JS non interceptée | - `test_pronostics_ui_endpoint`<br>- `test_ui_contains_critical_elements_and_api_call` | - Test d'intégration qui mock l'API et vérifie l'affichage correct des données (succès, échec, vide). | - Taux d'erreur JS < 0.1% | Moyen | 3 |
| **Endpoints Sensibles (ops/\*)** | - Accès non autorisé (contournement API Key/OIDC) | - `test_api_key_required_and_missing`<br>- `test_ops_run_endpoint_security`<br>- `test_task_worker_endpoint_security` | - Test de charge simple pour valider la robustesse de l'authentification (non-fonctionnel).<br>- Test de non-régression sur le header `X-API-KEY`. | - 100% des endpoints sensibles audités et testés contre les accès non authentifiés | Faible | **5** |
| **Pipeline d'Analyse** | - Décision erronée sur data invalide<br>- Effet de bord entre les phases (H30/H5) | - Couverture > 99% sur `analysis_pipeline.py`<br>- Tests unitaires robustes sur `analysis_utils.py` | - Test d'intégration avec un snapshot de course de bout en bout (de `load_snapshot` à `generate_tickets`). | - > 98% de couverture | Moyen | 4 |
| **Persistance (Firestore)** | - Mauvais format de doc_id<br>- Gestion des collections vides ou absentes | - `firestore_client.py` couvert à 95% (CRUD de base) | - Tests sur les cas limites : document non trouvé, erreur de connexion, pagination. | - 100% des écritures/lectures critiques testées unitairement | Faible | 2 |
| **Scrapers (Boturfers, Geny)** | - Changement de structure HTML<br>- Parsing de données incorrect (NaN, None) | - Tests de parsing basés sur des fixtures HTML locales.<br>- `test_fallback_parse_html_extracts_data` | - **Test "Canary"** : script non-versionné pour lancer les scrapers sur les URL live et détecter les changements de structure (alerte si 0 course trouvée).<br>- Fixtures HTML pour les cas d'erreur (page 404, course annulée). | - > 90% de couverture<br>- Alerte Canary fonctionnelle | Moyen | 3 |
| **Scheduler (Cloud Tasks)** | - Tâche non créée ou dupliquée<br>- Mauvais calcul de l'heure de planification | - Couverture de 100% avec mocks (`test_scheduler.py`) | - Test d'intégration en `DRY_RUN` qui vérifie le `task_id` unique et l'`eta` calculé. | - 0 duplication de tâche en simulation | Faible | 4 |
| **Gestion de l'Environnement** | - Variable critique manquante en prod (silent fail) | - `test_get_env_required_missing_in_prod_exits` | - **Test explicite du mode "fail-fast"** en production si une variable requise est absente. | - Démarrage de l'application impossible si `PROD` et variable requise manquante | Faible | 5 |
