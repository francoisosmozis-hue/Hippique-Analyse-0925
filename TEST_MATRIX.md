# Matrice de Tests - hippique-orchestrator

Ce document détaille la stratégie de test par composant, en évaluant les risques et les actions nécessaires pour garantir la qualité avant la mise en production.

| Composant | Risque (1-5) | Tests Existants (Couverture) | Tests Manquants Critiques | KPI de Qualité | Effort (1-3) | Priorité (1-3) |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **API Publique (/pronostics)** | 4 | `test_api_endpoints.py` (validation date, structure, ETag). | - Test de charge (non-fonctionnel, hors périmètre).<br>- Test de contrat sur le schéma JSON de sortie. | Latence < 500ms (P95), Taux erreur < 0.1%. | 1 | 2 |
| **UI (/pronostics)** | 3 | `test_ui.py` (rendu de base). `test_api_endpoints.py` (réponse 200 OK). | - Test d'intégration qui vérifie que le JS front appelle bien l'API et affiche un résultat. | Lighthouse > 80, Taux d'erreur JS < 0.01%. | 2 | 3 |
| **Endpoints Sécurisés (/schedule, /tasks/*)** | 5 | `test_api_security.py` (mocks auth OIDC & API Key). | - **Smoke test** en conditions réelles (avec une vraie clé via env). | 100% des endpoints sensibles retournent 401/403 sans authentification valide. | 2 | 1 |
| **Pipeline d'Analyse (`analysis_pipeline.py`)** | 4 | `test_analysis_drift.py`, `test_pipeline_run.py` (89% de couverture). | - Test des cas où GCS est indisponible (écriture snapshot).<br>- Test des cas de corruption de données dans le snapshot. | >90% couverture. 0 régression sur les cas nominaux. | 2 | 2 |
| **Persistance (Firestore & GCS)** | 4 | `test_firestore_client.py` (95%), `test_gcs_client_extended.py` (91%). Mocks complets. | - Test de `firestore_client` avec une collection vide.<br>- Test de `firestore_client` sur la gestion des timeouts. | >95% couverture sur `firestore_client`. | 2 | 2 |
| **Scrapers (`scrapers/`, `zoneturf_client.py`)** | 5 | `test_scraper_*.py` (tests unitaires avec fixtures HTML). | - Test de détection de changement de structure HTML (alerte).<br>- Test sur des fixtures HTML plus variées (erreurs, formats inhabituels). | Taux de succès scraping > 99%. 100% des parsing critiques testés unitairement. | 3 | 1 |
| **Scheduler (`scheduler.py`)** | 5 | `test_scheduler.py` (72% de couverture). Tests sur `dry_run` et création de tâches mockées. | - Test du calcul de l'heure de planification (fuseaux horaires, heure d'été/hiver).<br>- Test du comportement en cas d'échec de l'API Cloud Tasks. | >85% couverture. Taux de planification manquée < 1%. | 3 | 1 |
| **Gestion de l'Environnement (`config/env_utils.py`)** | 3 | `test_env_utils.py` (100% de couverture). Prouve le comportement "log and continue". | - Test optionnel d'un mode "fail-fast" si une variable requise est manquante en production. | 100% des variables critiques documentées et testées pour leur absence. | 1 | 3 |