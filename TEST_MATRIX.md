# Matrice de Tests - Hippique Orchestrator

Ce document détaille la stratégie de test pour chaque composant majeur du projet, en identifiant les risques, les tests existants et manquants, ainsi que les indicateurs de performance clés (KPIs) pour valider la robustesse de l'application.

| Composant | Risque Principal | Tests Existants | Tests Manquants | KPI de Qualité | Effort | Priorité |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **API Publique (/api/pronostics)** | Contrat de données instable, régression. | - `test_api_pronostics_...` (structure de base, date) | - Validation stricte du schéma JSON (Pydantic).<br>- Test de non-régression sur un payload de référence. | Schéma stable à 100% sur 5 versions. | Faible | 2 |
| **UI (/pronostics)** | indisponibilité, lien API cassé | - `test_pronostics_ui_endpoint`<br>- `test_read_main` | - Test de présence du marqueur `id="api-url"` pointant vers la bonne URL. | 100% de disponibilité sur les tests UI. | Faible | 3 |
| **Endpoints Sécurisés** | Accès non autorisé, fuite de logique. | - `test_api_security.py` (API Key, OIDC) | - Vérifier que `REQUIRE_AUTH=true` bloque bien tous les endpoints ops.<br>- Scénario `schedule` sans clé API (403 attendu). | 100% des endpoints sensibles retournent 401/403 sans auth. | Moyen | 1 |
| **Pipeline d'Analyse** | Décision erronée (faux positifs/négatifs). | - `test_analysis_pipeline.py` (89%)<br>-`test_pipeline_run.py` (80%)<br>-`validator_ev.py` (32%) | - **`validator_ev.py`**: tests sur cas limites (EV très faibles/élevés, ROI négatifs).<br>- Scénarios de données manquantes ou corrompues. | Couverture > 80% sur `validator_ev.py`. | Élevé | 1 |
| **Persistance (Firestore/GCS)** | Données invalides, perte de données. | - `test_firestore_client.py` (95%)<br>- `test_gcs_client.py` (33%) | - **`gcs_client.py`**: tests `upload_json` et `download_latest_snapshot` avec des cas d'erreur (bucket non trouvé, 404).<br>- Test de formatage des `doc_id` Firestore. | Couverture > 80% sur `gcs_client.py`. | Moyen | 2 |
| **Scrapers (Boturfers/Zeturf)** | Changement de structure HTML, données erronées. | - `test_scraper_boturfers.py` (parsing partiel)<br>- `test_scraper_zeturf.py` (parsing partiel) | - Tests de parsing sur fixtures HTML statiques pour chaque type de page (programme, course, etc.).<br>- Test de détection de changement de structure (ex: un sélecteur CSS clé non trouvé).<br>- **`online_fetch_zeturf.py`**: à couvrir massivement. | 100% des champs clés parsés correctement sur les fixtures. | Élevé | 1 |
| **Scheduler (Cloud Tasks)** | Tâches non créées ou invalides. | - `test_scheduler.py` (72%) | - Test des cas où le "plan" est vide ou ne contient aucune course future.<br>- Test de la gestion d'erreur si le client Cloud Tasks échoue. | Couverture > 85% sur `scheduler.py`. | Moyen | 2 |
| **Gestion de l'environnement** | Configuration de production erronée non détectée. | - `test_env_utils.py` (100%) | - Test explicite pour `get_env` en mode "fail-fast" (ex: `is_prod=True` et variable manquante). | Le mode "fail-fast" lève une exception (test unitaire). | Faible | 3 |
