From 7777777777777777777777777777777777777777 Mon Sep 17 00:00:00 2001
From: GPI-Orchestrator Bot <noreply@example.com>
Date: Sun, 26 Oct 2025 14:05:00 +0100
Subject: [PATCH] feat(service): add /pipeline/run endpoint returning top-level
 fields

---
 src/service.py | 27 +++++++++++++++++++++++++++
 1 file changed, 27 insertions(+)

diff --git a/src/service.py b/src/service.py
index 0000000..1111111 100644
--- a/src/service.py
+++ b/src/service.py
@@ -1,3 +1,4 @@
+ 
@@ -9999,3 +10000,29 @@
 
+@app.post("/pipeline/run")
+def pipeline_run_endpoint(req: RunReq):
+    """Retourne les r√©sultats de la phase H30/H5/RESULT (abstain/tickets/validation)."""
+    try:
+        data_dir = _PROJECT_ROOT / "data" / f"{(req.reunion or 'R1')}{(req.course or 'C1')}"
+        analysis_file = data_dir / f"analysis_{req.phase}.json"
+        if analysis_file.exists():
+            with open(analysis_file) as f:
+                data = json.load(f)
+            return {
+                "status": "ok",
+                "abstain": data.get("abstain", False),
+                "tickets": data.get("tickets", []),
+                "validation": data.get("validation", {}),
+            }
+        else:
+            return {
+                "status": "ok",
+                "abstain": True,
+                "message": f"Snapshot not found: {analysis_file}",
+                "tickets": [],
+            }
+    except Exception as e:
+        raise HTTPException(500, f"pipeline_run failed: {e}")
+
 if __name__ == "__main__":
     import uvicorn
     uvicorn.run("src.service:app", host="0.0.0.0", port=int(os.getenv("PORT", 8080)))
-- 
2.43.0
