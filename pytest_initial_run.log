============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.2.0, pluggy-1.6.0
rootdir: /home/francoisosmozis/hippique-orchestrator
configfile: pytest.ini
testpaths: tests
plugins: anyio-4.12.1, pyfakefs-6.0.0, cov-7.0.0, mock-3.14.0, asyncio-0.23.7
asyncio: mode=Mode.STRICT
collected 1144 items

tests/hippique/utils/test_probabilities.py::test_implied_prob_from_odds_valid_input PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_implied_prob_from_odds_invalid_input PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_no_vig_probs_valid_input PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_no_vig_probs_empty_list PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_no_vig_probs_invalid_odds_in_list PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_expected_value_simple_positive_ev PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_expected_value_simple_negative_ev PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_expected_value_simple_zero_ev PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_expected_value_simple_various_stakes PASSED [  0%]
tests/hippique/utils/test_probabilities.py::test_expected_value_simple_edge_cases PASSED [  0%]
tests/providers/test_geny_provider.py::test_geny_provider_initialization 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:50 [INFO] GenyProvider initialized.
PASSED                                                                   [  0%]
tests/providers/test_geny_provider.py::test_fetch_stats_for_runner_returns_stats 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:50 [INFO] GenyProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:50 [INFO] Fetching Geny stats for: Y. LEBOURGEOIS
2026-01-11 21:38:50 [INFO] Stats parsées depuis Geny: {'driver_rate': 0.155}
PASSED                                                                   [  1%]
tests/providers/test_geny_provider.py::test_fetch_stats_for_runner_handles_no_driver 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:50 [INFO] GenyProvider initialized.
PASSED                                                                   [  1%]
tests/providers/test_geny_provider.py::test_fetch_stats_for_runner_handles_fetch_failure 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:50 [INFO] GenyProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:50 [INFO] Fetching Geny stats for: Y. LEBOURGEOIS
2026-01-11 21:38:50 [WARNING] Impossible de récupérer la page pour Y. LEBOURGEOIS sur Geny.
PASSED                                                                   [  1%]
tests/providers/test_geny_provider.py::test_fetch_stats_uses_cache 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:50 [INFO] GenyProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:50 [INFO] Fetching Geny stats for: Y. LEBOURGEOIS
2026-01-11 21:38:50 [INFO] Stats parsées depuis Geny: {'driver_rate': 0.155}
PASSED                                                                   [  1%]
tests/providers/test_zeturf_provider.py::test_zeturf_provider_initialization PASSED [  1%]
tests/providers/test_zeturf_provider.py::test_fetch_snapshot_returns_normalized_data 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:50 [INFO] Début du scraping ZEturf: https://www.zeturf.fr/fr/course/2024-01-11/R1C1-prix-de-la-course
PASSED                                                                   [  1%]
tests/providers/test_zeturf_provider.py::test_fetch_snapshot_handles_http_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:50 [INFO] Début du scraping ZEturf: https://www.zeturf.fr/fr/course/2024-01-11/R1C1-prix-de-la-course
2026-01-11 21:38:50 [ERROR] Failed to create RaceSnapshotNormalized for https://www.zeturf.fr/fr/course/2024-01-11/R1C1-prix-de-la-course: HTTP 404
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/sources/zeturf_provider.py", line 48, in _fetch_race_snapshot_sync
    html_content = self._http_get_sync(race_url)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
RuntimeError: HTTP 404
PASSED                                                                   [  1%]
tests/providers/test_zeturf_provider.py::test_fetch_snapshot_handles_empty_runners 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:50 [INFO] Début du scraping ZEturf: https://www.zeturf.fr/fr/course/2024-01-11/R1C1-prix-de-la-course
2026-01-11 21:38:50 [ERROR] Failed to create RaceSnapshotNormalized for https://www.zeturf.fr/fr/course/2024-01-11/R1C1-prix-de-la-course: No runners found in snapshot data.
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/sources/zeturf_provider.py", line 52, in _fetch_race_snapshot_sync
    raise ValueError("No runners found in snapshot data.")
ValueError: No runners found in snapshot data.
PASSED                                                                   [  1%]
tests/providers/test_zeturf_provider.py::test_fetch_stats_for_runner_returns_empty_stats PASSED [  1%]
tests/scripts/test_monitor_roi.py::test_load_json_safe_success PASSED    [  1%]
tests/scripts/test_monitor_roi.py::test_load_json_safe_failure PASSED    [  1%]
tests/scripts/test_monitor_roi.py::test_parse_tracking_csv_success PASSED [  2%]
tests/scripts/test_monitor_roi.py::test_collect_analyses_no_date_filter PASSED [  2%]
tests/scripts/test_monitor_roi.py::test_collect_analyses_with_date_filter PASSED [  2%]
tests/scripts/test_monitor_roi.py::test_compute_statistics PASSED        [  2%]
tests/scripts/test_monitor_roi.py::test_compute_statistics_no_races_played PASSED [  2%]
tests/scripts/test_monitor_roi.py::test_print_report PASSED              [  2%]
tests/scripts/test_monitor_roi.py::test_export_json PASSED               [  2%]
tests/scripts/test_monitor_roi.py::test_main_run_once PASSED             [  2%]
tests/scripts/test_online_fetch_zeturf.py::test_fallback_parse_html_extracts_data ERROR [  2%]
tests/scripts/test_online_fetch_zeturf.py::test_normalise_rc_tag[R1-C1-R1C1] PASSED [  2%]
tests/scripts/test_online_fetch_zeturf.py::test_normalise_rc_tag[1-2-R1C2] PASSED [  2%]
tests/scripts/test_online_fetch_zeturf.py::test_normalise_rc_tag[R4C5-None-R4C5] PASSED [  2%]
tests/scripts/test_online_fetch_zeturf.py::test_normalise_rc_tag_raises_error PASSED [  3%]
tests/scripts/test_online_fetch_zeturf.py::test_coerce_runner_entry PASSED [  3%]
tests/scripts/test_online_fetch_zeturf.py::test_build_snapshot_payload PASSED [  3%]
tests/scripts/test_online_fetch_zeturf.py::test_fetch_race_snapshot_cli 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:51 [INFO] [CLI] snapshot chargé depuis snapshot.json
PASSED                                                                   [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalise_rc_tag_valid[1-2-R1C2] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalise_rc_tag_valid[R1-C2-R1C2] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalise_rc_tag_valid[R3-10-R3C10] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalise_rc_tag_valid[4-5-R4C5] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_slugify_hippodrome PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalize_decimal[12,5-12.5] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalize_decimal[15.5-15.5] PASSED [  3%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalize_decimal[20-20.0] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalize_decimal[abc-None] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_normalize_decimal[None-None] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_fallback_parse_html_extracts_data PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_fallback_parse_html_data_odd_attribute PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_fallback_parse_html_no_cotes_infos_script PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_fallback_parse_html_missing_cheval PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_fallback_parse_html_no_tbody PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw0-expected0] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw1-expected1] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw2-expected2] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw3-expected3] PASSED [  4%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw4-expected4] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw5-None] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw6-None] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_coverage.py::test_coerce_runner_entry_variations[raw7-expected7] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_fallback_parse_html_no_runners_table ERROR [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_fallback_parse_html_runner_missing_data ERROR [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw0-expected0] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw1-expected1] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw2-expected2] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw3-expected3] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw4-expected4] PASSED [  5%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw5-expected5] PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw6-expected6] PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw7-expected7] PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw8-None] PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_variations[raw9-expected9] PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_coerce_runner_entry_invalid_input PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_normalise_snapshot_result_merges_h30_odds PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_normalise_snapshot_result_no_market PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_http_get_raises_on_403 PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_extended.py::test_http_get_raises_on_suspicious_html PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_parsing.py::test_double_extract_parses_real_html_fixture 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:52 [WARNING] [ZEturf] Extraction fallback utilisée pour https://www.zeturf.fr/fr/course/2025-11-20/R1C1 (snapshot=H-30)
2026-01-11 21:38:52 [INFO] [ZEturf] phase=H30 url=https://www.zeturf.fr/fr/course/2025-11-20/R1C1-saint-galmier partants=12
PASSED                                                                   [  6%]
tests/scripts/test_online_fetch_zeturf_parsing.py::test_fallback_parse_no_runners_table_finds_no_runners PASSED [  6%]
tests/scripts/test_online_fetch_zeturf_parsing.py::test_fallback_parse_no_script_finds_no_odds PASSED [  7%]
tests/scripts/test_online_fetch_zeturf_parsing.py::test_fallback_parse_no_data_finds_nothing PASSED [  7%]
tests/scripts/test_online_fetch_zeturf_parsing.py::test_double_extract_uses_fallback 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:54 [WARNING] [ZEturf] Champ clé manquant: meeting (url=http://example.com, snapshot=H-30)
2026-01-11 21:38:54 [WARNING] [ZEturf] Champ clé manquant: discipline (url=http://example.com, snapshot=H-30)
2026-01-11 21:38:54 [WARNING] [ZEturf] Champ clé manquant: partants (url=http://example.com, snapshot=H-30)
2026-01-11 21:38:54 [WARNING] [ZEturf] Aucun partant détecté (url=http://example.com, snapshot=H-30) — retournera une liste vide
2026-01-11 21:38:54 [WARNING] [ZEturf] Extraction fallback utilisée pour http://example.com (snapshot=H-30)
PASSED                                                                   [  7%]
tests/scripts/test_simulate_ev_script.py::test_implied_prob_valid PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_implied_prob_invalid PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_normalize_overround_basic PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_normalize_overround_with_invalids PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_normalize_overround_zero_total PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_normalize_overround_empty PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_implied_probs_list PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_implied_probs_with_invalid_odds PASSED [  7%]
tests/scripts/test_simulate_ev_script.py::test_allocate_dutching_sp_ideal PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_allocate_dutching_sp_fallback_prob PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_allocate_dutching_sp_stake_capping PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_allocate_dutching_sp_min_stake_filter PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_allocate_dutching_sp_no_valid_runners PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_gate_ev_all_pass PASSED   [  8%]
tests/scripts/test_simulate_ev_script.py::test_gate_ev_sp_fails PASSED   [  8%]
tests/scripts/test_simulate_ev_script.py::test_gate_ev_combo_fails PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_gate_ev_risk_fails_both PASSED [  8%]
tests/scripts/test_simulate_ev_script.py::test_gate_ev_sharpe_fails_both PASSED [  8%]
tests/scripts/test_simulate_wrapper_script.py::test_load_calibration_reloads_on_file_change PASSED [  8%]
tests/scripts/test_simulate_wrapper_script.py::test_empty_or_invalid_calibration_file 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:54 [WARNING] Could not load or parse calibration file /etc/config/probabilities.yaml: mapping values are not allowed here
  in "/etc/config/probabilities.yaml", line 1, column 11
PASSED                                                                   [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_simulate_wrapper_fallback_no_correlation PASSED [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_correlation_penalty_defaults_gracefully PASSED [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_simulate_wrapper_applies_correlation_penalty PASSED [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_monte_carlo_is_used_when_numpy_present PASSED [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_monte_carlo_is_skipped_when_numpy_missing PASSED [  9%]
tests/scripts/test_simulate_wrapper_script.py::test_evaluate_combo_calls_dependencies_and_returns_results PASSED [  9%]
tests/scripts/test_update_excel_with_results.py::test_as_float PASSED    [  9%]
tests/scripts/test_update_excel_with_results.py::test_normalise_notes PASSED [  9%]
tests/scripts/test_update_excel_with_results.py::test_upsert_row PASSED  [  9%]
tests/scripts/test_update_excel_with_results_script.py::test_update_creates_new_excel_and_sheets PASSED [  9%]
tests/scripts/test_update_excel_with_results_script.py::test_update_upserts_existing_row PASSED [  9%]
tests/test__debug_mock_firestore.py::test__debug_mock_firestore_types PASSED [ 10%]
tests/test_analysis_drift.py::test_drift_is_detected_and_applied FAILED  [ 10%]
tests/test_analysis_drift.py::test_pipeline_raises_if_doc_id_missing PASSED [ 10%]
tests/test_analysis_drift.py::test_pipeline_abstains_if_snapshot_is_empty 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:54 [INFO] Starting analysis pipeline for phase.
2026-01-11 21:38:54 [WARNING] Snapshot invalid or runners empty -> abstention.
PASSED                                                                   [ 10%]
tests/test_analysis_drift.py::test_pipeline_handles_generic_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:55 [INFO] Starting analysis pipeline for phase.
2026-01-11 21:38:55 [ERROR] Analysis pipeline failed: Unexpected GCS error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/analysis_pipeline.py", line 203, in run_analysis_for_phase
    snapshot_data, gcs_path = await _fetch_and_save_snapshot(
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
Exception: Unexpected GCS error

PASSED                                                                   [ 10%]
tests/test_analysis_pipeline_extended.py::test_find_and_load_h30_snapshot_no_snapshots_found 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:55 [WARNING] No snapshots found in directory.
PASSED                                                                   [ 10%]
tests/test_analysis_pipeline_extended.py::test_find_and_load_h30_snapshot_no_h30_snapshots_found 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:55 [WARNING] No H-30 snapshot found for drift calculation.
PASSED                                                                   [ 10%]
tests/test_analysis_pipeline_extended.py::test_find_and_load_h30_snapshot_list_files_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:55 [ERROR] Failed to find or load H-30 snapshot: GCS List Error
PASSED                                                                   [ 10%]
tests/test_analysis_pipeline_extended.py::test_find_and_load_h30_snapshot_read_file_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:55 [ERROR] Failed to find or load H-30 snapshot: GCS Read Error
PASSED                                                                   [ 10%]
tests/test_analysis_pipeline_extended.py::test_run_analysis_for_phase_abstains_on_empty_snapshot_from_data_source 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:55 [INFO] Starting analysis pipeline for phase.
2026-01-11 21:38:55 [INFO] Fetching race details from data source.
2026-01-11 21:38:55 [WARNING] Snapshot invalid or runners empty -> abstention.
PASSED                                                                   [ 10%]
tests/test_analysis_pipeline_extended.py::test_run_analysis_for_phase_abstains_on_snapshot_with_no_runners 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:55 [INFO] Starting analysis pipeline for phase.
2026-01-11 21:38:55 [INFO] Fetching race details from data source.
2026-01-11 21:38:55 [WARNING] Snapshot invalid or runners empty -> abstention.
PASSED                                                                   [ 10%]
tests/test_analysis_utils.py::test_normalise_text[None-] PASSED          [ 11%]
tests/test_analysis_utils.py::test_normalise_text[  \xc9curie Sp\xe9ciale  -ecurie speciale] PASSED [ 11%]
tests/test_analysis_utils.py::test_normalise_text[  -] PASSED            [ 11%]
tests/test_analysis_utils.py::test_normalise_text[TROT-trot] PASSED      [ 11%]
tests/test_analysis_utils.py::test_normalise_text[handicap-handicap] PASSED [ 11%]
tests/test_analysis_utils.py::test_coerce_partants[14-14] PASSED         [ 11%]
tests/test_analysis_utils.py::test_coerce_partants[14.0-14] PASSED       [ 11%]
tests/test_analysis_utils.py::test_coerce_partants[14 partants-14] PASSED [ 11%]
tests/test_analysis_utils.py::test_coerce_partants[environ 14-14] PASSED [ 11%]
tests/test_analysis_utils.py::test_coerce_partants[None-None] PASSED     [ 11%]
tests/test_analysis_utils.py::test_coerce_partants[True-None] PASSED     [ 11%]
tests/test_analysis_utils.py::test_coerce_partants[N/A-None] PASSED      [ 11%]
tests/test_analysis_utils.py::test_coerce_partants[-5-None] PASSED       [ 12%]
tests/test_analysis_utils.py::test_compute_overround_cap_default PASSED  [ 12%]
tests/test_analysis_utils.py::test_compute_overround_cap_flat_handicap_large_field PASSED [ 12%]
tests/test_analysis_utils.py::test_compute_overround_cap_flat_large_field_from_label PASSED [ 12%]
tests/test_analysis_utils.py::test_compute_overround_cap_small_field_uses_default PASSED [ 12%]
tests/test_analysis_utils.py::test_compute_overround_cap_updates_context PASSED [ 12%]
tests/test_analysis_utils_extended.py::test_parse_musique[1p2p(23)3p4hDAI-expected0] PASSED [ 12%]
tests/test_analysis_utils_extended.py::test_parse_musique[0a9a8a-expected1] PASSED [ 12%]
tests/test_analysis_utils_extended.py::test_parse_musique[None-expected2] PASSED [ 12%]
tests/test_analysis_utils_extended.py::test_parse_musique[   -expected3] PASSED [ 12%]
tests/test_analysis_utils_extended.py::test_calculate_volatility[musique_data0-VOLATIL] PASSED [ 12%]
tests/test_analysis_utils_extended.py::test_calculate_volatility[musique_data1-VOLATIL] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_calculate_volatility[musique_data2-VOLATIL] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_calculate_volatility[musique_data3-S\xdbR] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_calculate_volatility[musique_data4-VOLATIL] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_calculate_volatility[musique_data5-NEUTRE] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_convert_odds_to_implied_probabilities[odds_list0-expected_probs0-1.0] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_convert_odds_to_implied_probabilities[odds_list1-expected_probs1-0.0] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_convert_odds_to_implied_probabilities[odds_list2-expected_probs2-0.25] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_convert_odds_to_implied_probabilities[odds_list3-expected_probs3-0.5] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_identify_outsider_reparable[runner_data0-True] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_identify_outsider_reparable[runner_data1-False] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_identify_outsider_reparable[runner_data2-False] PASSED [ 13%]
tests/test_analysis_utils_extended.py::test_identify_outsider_reparable[runner_data3-False] PASSED [ 14%]
tests/test_analysis_utils_extended.py::test_identify_outsider_reparable[runner_data4-False] PASSED [ 14%]
tests/test_analysis_utils_extended.py::test_identify_profil_oublie[runner_data0-True] PASSED [ 14%]
tests/test_analysis_utils_extended.py::test_identify_profil_oublie[runner_data1-False] PASSED [ 14%]
tests/test_analysis_utils_extended.py::test_identify_profil_oublie[runner_data2-False] PASSED [ 14%]
tests/test_analysis_utils_extended.py::test_identify_profil_oublie[runner_data3-False] PASSED [ 14%]
tests/test_analysis_utils_extended.py::test_identify_profil_oublie[runner_data4-False] PASSED [ 14%]
tests/test_analysis_utils_extended.py::test_score_musique_form[musique_data0-expected_score0] PASSED [ 14%]
tests/test_analysis_utils_extended.py::test_score_musique_form[musique_data1-expected_score1] PASSED [ 14%]
tests/test_analysis_utils_extended.py::test_score_musique_form[musique_data2-0.0] PASSED [ 14%]
tests/test_api_endpoints.py::test_health_check_endpoint 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:55 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:55 [INFO] Request started
2026-01-11 21:38:55 [INFO] Request finished
2026-01-11 21:38:55 [INFO] HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
PASSED                                                                   [ 14%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:55 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_endpoints.py::test_pronostics_ui_endpoint 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:55 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:55 [INFO] Request started
2026-01-11 21:38:55 [INFO] Request finished
2026-01-11 21:38:55 [INFO] HTTP Request: GET http://testserver/pronostics "HTTP/1.1 200 OK"
PASSED                                                                   [ 15%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:55 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_endpoints.py::test_root_redirect 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:55 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:55 [INFO] Request started
2026-01-11 21:38:55 [INFO] Request finished
2026-01-11 21:38:55 [INFO] HTTP Request: GET http://testserver/ "HTTP/1.1 307 Temporary Redirect"
PASSED                                                                   [ 15%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:55 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_endpoints.py::test_api_pronostics_date_validation 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:55 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:55 [INFO] Request started
2026-01-11 21:38:55 [INFO] Request finished
2026-01-11 21:38:55 [INFO] HTTP Request: GET http://testserver/api/pronostics?date=not-a-real-date "HTTP/1.1 422 Unprocessable Entity"
PASSED                                                                   [ 15%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:55 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_endpoints.py::test_api_pronostics_default_date_is_today FAILED [ 15%]
tests/test_api_endpoints.py::test_api_pronostics_empty_response 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:56 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:56 [INFO] Request started
2026-01-11 21:38:56 [INFO] Building plan for 2025-01-01 using ProgrammeProvider.
2026-01-11 21:38:56 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:38:56 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2025-01-01 (implémentation factice).
2026-01-11 21:38:57 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:38:57 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2025-01-01 (implémentation factice).
2026-01-11 21:38:57 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:38:57 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:38:57 [WARNING] Failed to fetch programme for 2025-01-01 from any source.
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: GET http://testserver/api/pronostics?date=2025-01-01 "HTTP/1.1 200 OK"
PASSED                                                                   [ 15%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_endpoints.py::test_api_pronostics_etag_304_not_modified FAILED [ 15%]
tests/test_api_endpoints.py::test_api_pronostics_rich_response_structure FAILED [ 15%]
tests/test_api_integration.py::test_health_check_returns_ok 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
PASSED                                                                   [ 15%]
tests/test_api_integration.py::test_debug_config_returns_ok_and_has_expected_keys 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: GET http://testserver/debug/config "HTTP/1.1 200 OK"
PASSED                                                                   [ 15%]
tests/test_api_integration.py::test_get_pronostics_api_with_mocked_data 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: GET http://testserver/api/pronostics?date=2023-01-20 "HTTP/1.1 200 OK"
PASSED                                                                   [ 15%]
tests/test_api_security.py::test_schedule_endpoint_is_protected_by_api_key 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/schedule "HTTP/1.1 403 Forbidden"
PASSED                                                                   [ 15%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_api_key_authentication 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/schedule "HTTP/1.1 403 Forbidden"
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/schedule "HTTP/1.1 403 Forbidden"
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received request to schedule day races. Force: False, Dry Run: True
2026-01-11 21:38:57 [WARNING] No races found in plan for 2025-01-01. Nothing to schedule.
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/schedule "HTTP/1.1 200 OK"
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/schedule "HTTP/1.1 403 Forbidden"
PASSED                                                                   [ 15%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_ops_run_endpoint_security 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/ops/run?rc=R1C1 "HTTP/1.1 403 Forbidden"
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/ops/run?rc=R1C1 "HTTP/1.1 403 Forbidden"
PASSED                                                                   [ 16%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_ops_status_endpoint_security 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: GET http://testserver/ops/status?date=2025-01-01 "HTTP/1.1 403 Forbidden"
PASSED                                                                   [ 16%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_api_key_not_required 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received request to schedule day races. Force: False, Dry Run: True
2026-01-11 21:38:57 [WARNING] No races found in plan for 2025-01-01. Nothing to schedule.
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/schedule "HTTP/1.1 200 OK"
PASSED                                                                   [ 16%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_task_worker_endpoint_security 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/run-phase "HTTP/1.1 403 Forbidden"
PASSED                                                                   [ 16%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_task_worker_valid_token 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received run-phase request for http://example.com/2025-01-01/R1C1-test (phase: H-5)
2026-01-11 21:38:57 [INFO] Firestore client initialized for project 'test-project'.
2026-01-11 21:38:57 [INFO] Updating Firestore document
2026-01-11 21:38:57 [INFO] Run phase completed successfully for http://example.com/2025-01-01/R1C1-test (phase: H-5)
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/run-phase "HTTP/1.1 200 OK"
PASSED                                                                   [ 16%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_task_worker_google_auth_fails 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/run-phase "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 16%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_task_worker_invalid_token_scheme 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/run-phase "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 16%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_snapshot_9h_endpoint_security 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/snapshot-9h "HTTP/1.1 403 Forbidden"
PASSED                                                                   [ 16%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_bootstrap_day_endpoint_security 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/bootstrap-day "HTTP/1.1 403 Forbidden"
PASSED                                                                   [ 16%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_ops_run_endpoint_accessible_when_auth_not_required 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Manual run triggered for race R1C1 on 2026-01-11
2026-01-11 21:38:57 [INFO] Successfully processed and saved manual run for 2026-01-11_R1C1
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/ops/run?rc=R1C1 "HTTP/1.1 200 OK"
PASSED                                                                   [ 16%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_security.py::test_ops_status_endpoint_accessible_when_auth_not_required 
-------------------------------- live log setup --------------------------------
2026-01-11 21:38:57 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: GET http://testserver/ops/status?date=2025-01-01 "HTTP/1.1 200 OK"
PASSED                                                                   [ 16%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:38:57 [INFO] Shutting down Hippique Orchestrator.

tests/test_api_tasks.py::test_snapshot_9h_task_success 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received snapshot-9h request for 2026-01-11 with URLs: [], RC Labels: []
2026-01-11 21:38:57 [INFO] Snapshot-9h completed successfully for 2026-01-11.
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/snapshot-9h "HTTP/1.1 200 OK"
PASSED                                                                   [ 17%]
tests/test_api_tasks.py::test_snapshot_9h_task_with_specific_date_and_urls 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received snapshot-9h request for 2025-10-26 with URLs: ['http://example.com/r1c1', 'http://example.com/r1c2'], RC Labels: []
2026-01-11 21:38:57 [INFO] Snapshot-9h completed successfully for 2025-10-26.
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/snapshot-9h "HTTP/1.1 200 OK"
PASSED                                                                   [ 17%]
tests/test_api_tasks.py::test_run_phase_task_success 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received run-phase request for http://example.com/race/2025-12-29/R1C1-prix-de-la-course (phase: H30)
2026-01-11 21:38:57 [INFO] Run phase completed successfully for http://example.com/race/2025-12-29/R1C1-prix-de-la-course (phase: H30)
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/run-phase "HTTP/1.1 200 OK"
PASSED                                                                   [ 17%]
tests/test_api_tasks.py::test_run_phase_task_runner_returns_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received run-phase request for http://example.com/R1C1 (phase: H5)
2026-01-11 21:38:57 [INFO] Updating Firestore document
2026-01-11 21:38:57 [INFO] Run phase completed successfully for http://example.com/R1C1 (phase: H5)
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/run-phase "HTTP/1.1 200 OK"
PASSED                                                                   [ 17%]
tests/test_api_tasks.py::test_run_phase_task_exception_handling 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received run-phase request for http://example.com/R1C1 (phase: H5)
2026-01-11 21:38:57 [ERROR] Exception during run-phase for http://example.com/R1C1 (phase: H5): unexpected_error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/api/tasks.py", line 58, in run_phase_task
    analysis_result = await run_course(
                      ^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
Exception: unexpected_error
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/run-phase "HTTP/1.1 500 Internal Server Error"
PASSED                                                                   [ 17%]
tests/test_api_tasks.py::test_snapshot_9h_task_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received snapshot-9h request for 2025-10-26 with URLs: [], RC Labels: []
2026-01-11 21:38:57 [ERROR] Exception during snapshot-9h for 2025-10-26: Storage error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/api/tasks.py", line 111, in snapshot_9h_task
    await write_snapshot_for_day_async(
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
Exception: Storage error
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/snapshot-9h "HTTP/1.1 500 Internal Server Error"
PASSED                                                                   [ 17%]
tests/test_api_tasks.py::test_bootstrap_day_task_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received request to bootstrap day 2025-10-26
2026-01-11 21:38:57 [INFO] Building daily plan for 2025-10-26...
2026-01-11 21:38:57 [ERROR] Exception during bootstrap-day for 2025-10-26: Plan build failed
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/api/tasks.py", line 166, in bootstrap_day_task
    plan = await build_plan_async(target_date_str)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
Exception: Plan build failed
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/bootstrap-day "HTTP/1.1 500 Internal Server Error"
PASSED                                                                   [ 17%]
tests/test_api_tasks.py::test_run_phase_task_infers_doc_id 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received run-phase request for http://example.com/2025-01-01/R1C1-race (phase: H5)
2026-01-11 21:38:57 [INFO] Run phase completed successfully for http://example.com/2025-01-01/R1C1-race (phase: H5)
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/run-phase "HTTP/1.1 200 OK"
PASSED                                                                   [ 17%]
tests/test_api_tasks.py::test_bootstrap_day_task_success 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received request to bootstrap day 2026-01-11
2026-01-11 21:38:57 [INFO] Building daily plan for 2026-01-11...
2026-01-11 21:38:57 [INFO] Plan built: 2 races for 2026-01-11.
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/bootstrap-day "HTTP/1.1 200 OK"
PASSED                                                                   [ 17%]
tests/test_api_tasks.py::test_bootstrap_day_task_empty_plan 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:57 [INFO] Request started
2026-01-11 21:38:57 [INFO] Received request to bootstrap day 2026-01-11
2026-01-11 21:38:57 [INFO] Building daily plan for 2026-01-11...
2026-01-11 21:38:57 [WARNING] Empty plan for 2026-01-11. No tasks to schedule.
2026-01-11 21:38:57 [INFO] Request finished
2026-01-11 21:38:57 [INFO] HTTP Request: POST http://testserver/tasks/bootstrap-day "HTTP/1.1 404 Not Found"
PASSED                                                                   [ 17%]
tests/test_concat_je_month.py::test_normalize_columns PASSED             [ 17%]
tests/test_concat_je_month.py::test_normalize_columns_missing_cols PASSED [ 18%]
tests/test_concat_je_month.py::test_infer_date_from_path[data/2026-01-01/some_file.csv-expected_date0] PASSED [ 18%]
tests/test_concat_je_month.py::test_infer_date_from_path[data/2025_12_31/other_file.csv-expected_date1] PASSED [ 18%]
tests/test_concat_je_month.py::test_infer_date_from_path[data/no_date_here.csv-None] PASSED [ 18%]
tests/test_concat_je_month.py::test_infer_date_from_path[data/20240229_special.csv-expected_date3] PASSED [ 18%]
tests/test_concat_je_month.py::test_load_and_filter PASSED               [ 18%]
tests/test_concat_je_month.py::test_summarize_month PASSED               [ 18%]
tests/test_concat_je_month.py::test_summarize_month_no_jockey_trainer_data PASSED [ 18%]
tests/test_concat_je_month.py::test_main_success PASSED                  [ 18%]
tests/test_concat_je_month.py::test_main_data_dir_not_found PASSED       [ 18%]
tests/test_concat_je_month.py::test_main_no_csv_files_found PASSED       [ 18%]
tests/test_cron_decider.py::test_load_meetings_from_dict_key_meetings PASSED [ 18%]
tests/test_cron_decider.py::test_load_meetings_from_dict_key_reunions PASSED [ 19%]
tests/test_cron_decider.py::test_load_meetings_from_dict_key_data PASSED [ 19%]
tests/test_cron_decider.py::test_load_meetings_from_list PASSED          [ 19%]
tests/test_cron_decider.py::test_load_meetings_invalid_json_raises_error PASSED [ 19%]
tests/test_cron_decider.py::test_parse_start_iso_timestamp PASSED        [ 19%]
tests/test_cron_decider.py::test_parse_start_hh_mm_with_date_hint PASSED [ 19%]
tests/test_cron_decider.py::test_parse_start_invalid_format PASSED       [ 19%]
tests/test_cron_decider.py::test_parse_start_hh_mm_no_date_hint PASSED   [ 19%]
tests/test_cron_decider.py::test_invoke_runner 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:58 [WARNING] Environment variable ALLOW_HEURISTIC not set; using default '0'
PASSED                                                                   [ 19%]
tests/test_cron_decider.py::test_main_meetings_file_not_found PASSED     [ 19%]
tests/test_cron_decider.py::test_main_happy_path_h5 PASSED               [ 19%]
tests/test_cron_decider.py::test_main_happy_path_h30 PASSED              [ 20%]
tests/test_cron_decider.py::test_main_no_trigger_outside_window PASSED   [ 20%]
tests/test_cron_decider.py::test_main_no_trigger_if_missing_info PASSED  [ 20%]
tests/test_cron_decider.py::test_main_empty_meetings_file PASSED         [ 20%]
tests/test_cron_decider.py::test_main_trigger_at_window_edge PASSED      [ 20%]
tests/test_data_contract.py::test_quality_score_ok PASSED                [ 20%]
tests/test_data_contract.py::test_quality_score_degraded_missing_odds PASSED [ 20%]
tests/test_data_contract.py::test_quality_score_failed_too_many_missing_odds PASSED [ 20%]
tests/test_data_contract.py::test_quality_score_failed_no_runners PASSED [ 20%]
tests/test_data_contract.py::test_quality_score_degraded_missing_musique PASSED [ 20%]
tests/test_data_source.py::test_fetch_programme_routes_to_boturfers 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:58 [INFO] Fetching programme via SourceRegistry using URL: http://example.com
PASSED                                                                   [ 20%]
tests/test_data_source.py::test_fetch_race_details_routes_to_boturfers[https://www.boturfers.fr/c/2025-01-01/r1c1-hippique_orchestrator.data_source.source_registry.fetch_snapshot] FAILED [ 20%]
tests/test_data_source.py::test_fetch_race_details_routes_to_boturfers[http://some-other-site.com/race-hippique_orchestrator.data_source.source_registry.fetch_snapshot] FAILED [ 21%]
tests/test_data_source.py::test_fetch_race_details_routes_to_zeturf[https://www.zeturf.fr/fr/course/2025-12-25/R1C2-test-hippique_orchestrator.data_source.source_registry.fetch_snapshot] FAILED [ 21%]
tests/test_data_source.py::test_fetch_race_details_routes_to_zeturf[http://zeturf.com/R1C1-hippique_orchestrator.data_source.source_registry.fetch_snapshot] FAILED [ 21%]
tests/test_dutching_allocation.py::test_equal_profit_stakes_sum PASSED   [ 21%]
tests/test_dutching_utils.py::test_equal_profit_stakes_valid_input PASSED [ 21%]
tests/test_dutching_utils.py::test_equal_profit_stakes_empty_odds_list PASSED [ 21%]
tests/test_dutching_utils.py::test_equal_profit_stakes_invalid_odds_list[odds_list0] PASSED [ 21%]
tests/test_dutching_utils.py::test_equal_profit_stakes_invalid_odds_list[odds_list1] PASSED [ 21%]
tests/test_dutching_utils.py::test_equal_profit_stakes_invalid_odds_list[odds_list2] PASSED [ 21%]
tests/test_dutching_utils.py::test_equal_profit_stakes_invalid_odds_list[odds_list3] PASSED [ 21%]
tests/test_dutching_utils.py::test_diversify_guard_no_correlation PASSED [ 21%]
tests/test_dutching_utils.py::test_diversify_guard_correlated_same_stable_driver_within_threshold PASSED [ 22%]
tests/test_dutching_utils.py::test_diversify_guard_correlated_same_stable_driver_outside_threshold PASSED [ 22%]
tests/test_dutching_utils.py::test_diversify_guard_different_stable_same_driver PASSED [ 22%]
tests/test_dutching_utils.py::test_diversify_guard_same_stable_different_driver PASSED [ 22%]
tests/test_dutching_utils.py::test_diversify_guard_missing_ecurie_or_driver_lenient PASSED [ 22%]
tests/test_dutching_utils.py::test_diversify_guard_missing_chrono_lenient PASSED [ 22%]
tests/test_dutching_utils.py::test_diversify_guard_empty_list PASSED     [ 22%]
tests/test_dutching_utils.py::test_diversify_guard_single_horse PASSED   [ 22%]
tests/test_dutching_utils.py::test_require_mid_odds_found PASSED         [ 22%]
tests/test_dutching_utils.py::test_require_mid_odds_not_found_all_low PASSED [ 22%]
tests/test_dutching_utils.py::test_require_mid_odds_not_found_all_high PASSED [ 22%]
tests/test_dutching_utils.py::test_require_mid_odds_empty_list PASSED    [ 22%]
tests/test_dutching_utils.py::test_require_mid_odds_missing_odds PASSED  [ 23%]
tests/test_dutching_utils.py::test_require_mid_odds_non_numeric_odds_ignored PASSED [ 23%]
tests/test_env_utils.py::test_get_env_missing_warns 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [WARNING] Environment variable MISSING_VAR not set; using default 'fallback'
PASSED                                                                   [ 23%]
tests/test_env_utils.py::test_get_env_required_missing_logs_critical 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [CRITICAL] Missing required environment variable 'REQUIRED_MISSING'. App may not function correctly.
PASSED                                                                   [ 23%]
tests/test_env_utils.py::test_get_env_required_missing_in_prod_exits 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [CRITICAL] Missing required environment variable 'MY_VAR'. App may not function correctly.
2026-01-11 21:38:59 [CRITICAL] IS_PROD=True. Exiting.
PASSED                                                                   [ 23%]
tests/test_env_utils.py::test_get_env_required_missing_in_prod_exits_variations[true] 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [CRITICAL] Missing required environment variable 'MY_VAR'. App may not function correctly.
2026-01-11 21:38:59 [CRITICAL] IS_PROD=True. Exiting.
PASSED                                                                   [ 23%]
tests/test_env_utils.py::test_get_env_required_missing_in_prod_exits_variations[True] 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [CRITICAL] Missing required environment variable 'MY_VAR'. App may not function correctly.
2026-01-11 21:38:59 [CRITICAL] IS_PROD=True. Exiting.
PASSED                                                                   [ 23%]
tests/test_env_utils.py::test_get_env_required_missing_in_prod_exits_variations[1] 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [CRITICAL] Missing required environment variable 'MY_VAR'. App may not function correctly.
2026-01-11 21:38:59 [CRITICAL] IS_PROD=True. Exiting.
PASSED                                                                   [ 23%]
tests/test_env_utils.py::test_get_env_required_missing_in_prod_exits_variations[t] 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [CRITICAL] Missing required environment variable 'MY_VAR'. App may not function correctly.
2026-01-11 21:38:59 [CRITICAL] IS_PROD=True. Exiting.
PASSED                                                                   [ 23%]
tests/test_env_utils.py::test_get_env_required_missing_in_prod_exits_variations[yes] 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [CRITICAL] Missing required environment variable 'MY_VAR'. App may not function correctly.
2026-01-11 21:38:59 [CRITICAL] IS_PROD=True. Exiting.
PASSED                                                                   [ 23%]
tests/test_env_utils.py::test_get_env_required_missing_in_prod_exits_variations[y] 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [CRITICAL] Missing required environment variable 'MY_VAR'. App may not function correctly.
2026-01-11 21:38:59 [CRITICAL] IS_PROD=True. Exiting.
PASSED                                                                   [ 23%]
tests/test_env_utils.py::test_get_env_alias_support 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [INFO] Environment variable ALIAS_VAR='alias_value' used as alias for PRIMARY_VAR
PASSED                                                                   [ 24%]
tests/test_env_utils.py::test_get_env_casting_error_returns_default 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [ERROR] Invalid value for environment variable 'INT_VAR': 'not-an-int'. Returning default.
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/config/env_utils.py", line 84, in get_env
    value = cast(raw_value)
            ^^^^^^^^^^^^^^^
ValueError: invalid literal for int() with base 10: 'not-an-int'
PASSED                                                                   [ 24%]
tests/test_env_utils.py::test_get_env_value_equals_default_no_override_log PASSED [ 24%]
tests/test_env_utils.py::test_get_env_required_missing_non_prod_logs_critical_no_exit 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [CRITICAL] Missing required environment variable 'NON_PROD_REQUIRED'. App may not function correctly.
PASSED                                                                   [ 24%]
tests/test_env_utils.py::test_get_env_fail_fast_on_config_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [CRITICAL] Missing required environment variable 'MY_VAR'. App may not function correctly.
2026-01-11 21:38:59 [CRITICAL] FAIL_FAST_ON_CONFIG_ERROR is true. Exiting.
PASSED                                                                   [ 24%]
tests/test_ev_calculator.py::test_make_hashable_hashable_types PASSED    [ 24%]
tests/test_ev_calculator.py::test_make_hashable_list PASSED              [ 24%]
tests/test_ev_calculator.py::test_make_hashable_dict PASSED              [ 24%]
tests/test_ev_calculator.py::test_make_hashable_nested_structures PASSED [ 24%]
tests/test_ev_calculator.py::test_make_hashable_unhashable_fallback PASSED [ 24%]
tests/test_ev_calculator.py::test_kelly_fraction_valid_inputs PASSED     [ 24%]
tests/test_ev_calculator.py::test_kelly_fraction_probability_out_of_range PASSED [ 25%]
tests/test_ev_calculator.py::test_kelly_fraction_odds_out_of_range PASSED [ 25%]
tests/test_ev_calculator.py::test_apply_dutching_single_group PASSED     [ 25%]
tests/test_ev_calculator.py::test_apply_dutching_multiple_groups PASSED  [ 25%]
tests/test_ev_calculator.py::test_apply_dutching_no_dutching_groups PASSED [ 25%]
tests/test_ev_calculator.py::test_apply_dutching_mixed_groups PASSED     [ 25%]
tests/test_ev_calculator.py::test_apply_dutching_invalid_odds_in_group PASSED [ 25%]
tests/test_ev_calculator.py::test_apply_dutching_single_valid_ticket_in_group PASSED [ 25%]
tests/test_ev_calculator.py::test_apply_dutching_group_too_small PASSED  [ 25%]
tests/test_ev_calculator.py::test_ticket_label_with_id PASSED            [ 25%]
tests/test_ev_calculator.py::test_ticket_label_with_name PASSED          [ 25%]
tests/test_ev_calculator.py::test_ticket_label_with_label PASSED         [ 25%]
tests/test_ev_calculator.py::test_ticket_label_with_selection PASSED     [ 26%]
tests/test_ev_calculator.py::test_ticket_label_with_runner PASSED        [ 26%]
tests/test_ev_calculator.py::test_ticket_label_no_label_keys_falls_back_to_index PASSED [ 26%]
tests/test_ev_calculator.py::test_ticket_label_empty_string_values_falls_back_to_index PASSED [ 26%]
tests/test_ev_calculator.py::test_clone_leg_dict PASSED                  [ 26%]
tests/test_ev_calculator.py::test_clone_leg_list_of_dicts PASSED         [ 26%]
tests/test_ev_calculator.py::test_clone_leg_primitive_type PASSED        [ 26%]
tests/test_ev_calculator.py::test_prepare_legs_for_covariance_with_legs_for_probability PASSED [ 26%]
tests/test_ev_calculator.py::test_prepare_legs_for_covariance_with_legs_details PASSED [ 26%]
tests/test_ev_calculator.py::test_prepare_legs_for_covariance_with_legs PASSED [ 26%]
tests/test_ev_calculator.py::test_prepare_legs_for_covariance_with_id_only PASSED [ 26%]
tests/test_ev_calculator.py::test_prepare_legs_for_covariance_no_identifiable_legs PASSED [ 27%]
tests/test_ev_calculator.py::test_ticket_dependency_keys_with_ticket_id PASSED [ 27%]
tests/test_ev_calculator.py::test_ticket_dependency_keys_with_selection_id PASSED [ 27%]
tests/test_ev_calculator.py::test_ticket_dependency_keys_with_leg_id_in_legs PASSED [ 27%]
tests/test_ev_calculator.py::test_ticket_dependency_keys_with_mixed_dependencies PASSED [ 27%]
tests/test_ev_calculator.py::test_ticket_dependency_keys_empty PASSED    [ 27%]
tests/test_ev_calculator.py::test_prepare_ticket_dependencies PASSED     [ 27%]
tests/test_ev_calculator.py::test_rho_for_shared_exposures_id_dependency PASSED [ 27%]
tests/test_ev_calculator.py::test_rho_for_shared_exposures_leg_dependency PASSED [ 27%]
tests/test_ev_calculator.py::test_rho_for_shared_exposures_no_specific_dependency PASSED [ 27%]
tests/test_ev_calculator.py::test_rho_for_shared_exposures_empty PASSED  [ 27%]
tests/test_ev_calculator.py::test_approx_joint_probability_independent PASSED [ 27%]
tests/test_ev_calculator.py::test_approx_joint_probability_positive_correlation PASSED [ 28%]
tests/test_ev_calculator.py::test_approx_joint_probability_negative_correlation PASSED [ 28%]
tests/test_ev_calculator.py::test_approx_joint_probability_rho_clipping PASSED [ 28%]
tests/test_ev_calculator.py::test_approx_joint_probability_lower_bound PASSED [ 28%]
tests/test_ev_calculator.py::test_merge_legs_no_duplicates PASSED        [ 28%]
tests/test_ev_calculator.py::test_merge_legs_with_duplicates PASSED      [ 28%]
tests/test_ev_calculator.py::test_merge_legs_with_dict_duplicates PASSED [ 28%]
tests/test_ev_calculator.py::test_merge_legs_empty_inputs PASSED         [ 28%]
tests/test_ev_calculator.py::test_simulate_joint_probability_no_simulate_fn PASSED [ 28%]
tests/test_ev_calculator.py::test_simulate_joint_probability_no_legs PASSED [ 28%]
tests/test_ev_calculator.py::test_simulate_joint_probability_with_simulate_fn_no_cache PASSED [ 28%]
tests/test_ev_calculator.py::test_simulate_joint_probability_with_simulate_fn_and_cache_miss PASSED [ 29%]
tests/test_ev_calculator.py::test_simulate_joint_probability_with_simulate_fn_and_cache_hit PASSED [ 29%]
tests/test_ev_calculator.py::test_estimate_joint_probability_with_simulate_fn_and_cache PASSED [ 29%]
tests/test_ev_calculator.py::test_estimate_joint_probability_with_simulate_fn_no_cache PASSED [ 29%]
tests/test_ev_calculator.py::test_estimate_joint_probability_no_simulate_fn_uses_approx PASSED [ 29%]
tests/test_ev_calculator.py::test_estimate_joint_probability_with_copula_monte_carlo PASSED [ 29%]
tests/test_ev_calculator.py::test_covariance_from_joint_positive PASSED  [ 29%]
tests/test_ev_calculator.py::test_covariance_from_joint_negative PASSED  [ 29%]
tests/test_ev_calculator.py::test_covariance_from_joint_zero_probability PASSED [ 29%]
tests/test_ev_calculator.py::test_compute_joint_moments_no_tickets PASSED [ 29%]
tests/test_ev_calculator.py::test_compute_joint_moments_fewer_than_min_tickets PASSED [ 29%]
tests/test_ev_calculator.py::test_compute_joint_moments_no_shared_exposures PASSED [ 29%]
tests/test_ev_calculator.py::test_compute_joint_moments_with_shared_exposures_positive_covariance PASSED [ 30%]
tests/test_ev_calculator.py::test_compute_joint_moments_with_shared_exposures_negative_covariance PASSED [ 30%]
tests/test_ev_calculator.py::test_compute_joint_moments_covariance_below_threshold PASSED [ 30%]
tests/test_ev_calculator.py::test_risk_of_ruin[0.1-0.01-100-None-0.0] PASSED [ 30%]
tests/test_ev_calculator.py::test_risk_of_ruin[0.0-0.01-100-None-1.0] PASSED [ 30%]
tests/test_ev_calculator.py::test_risk_of_ruin[0.1-0.0-100-None-0.0] PASSED [ 30%]
tests/test_ev_calculator.py::test_risk_of_ruin[0.1-0.01-100-0.02-0.0] PASSED [ 30%]
tests/test_ev_calculator.py::test_risk_of_ruin[0.1-0.01-100-0.005-0.0] PASSED [ 30%]
tests/test_ev_calculator.py::test_risk_of_ruin[0.01-0.01-1-None-0.1353352832366127] PASSED [ 30%]
tests/test_ev_calculator.py::test_risk_of_ruin_invalid_bankroll PASSED   [ 30%]
tests/test_ev_calculator.py::test_risk_of_ruin_respects_baseline_variance PASSED [ 30%]
tests/test_ev_calculator.py::test_optimize_stake_allocation_with_scipy PASSED [ 31%]
tests/test_ev_calculator.py::test_optimize_stake_allocation_without_scipy_fallback_to_grid_search PASSED [ 31%]
tests/test_ev_calculator.py::test_optimize_stake_allocation_empty_tickets PASSED [ 31%]
tests/test_ev_calculator.py::test_process_single_ticket_p_provided PASSED [ 31%]
tests/test_ev_calculator.py::test_process_single_ticket_legs_provided_simulated_p PASSED [ 31%]
tests/test_ev_calculator.py::test_process_single_ticket_legs_provided_simulated_p_cached PASSED [ 31%]
tests/test_ev_calculator.py::test_process_single_ticket_no_p_or_legs_raises_value_error PASSED [ 31%]
tests/test_ev_calculator.py::test_process_single_ticket_invalid_p_raises_value_error PASSED [ 31%]
tests/test_ev_calculator.py::test_process_single_ticket_invalid_odds_raises_value_error PASSED [ 31%]
tests/test_ev_calculator.py::test_process_single_ticket_stake_capping_and_rounding PASSED [ 31%]
tests/test_ev_calculator.py::test_process_tickets_basic_functionality PASSED [ 31%]
tests/test_ev_calculator.py::test_calculate_ticket_metrics_single_ticket PASSED [ 31%]
tests/test_ev_calculator.py::test_calculate_ticket_metrics_with_combined_ticket PASSED [ 32%]
tests/test_ev_calculator.py::test_calculate_final_metrics_green_flag PASSED [ 32%]
tests/test_ev_calculator.py::test_calculate_final_metrics_red_flag_ev_ratio PASSED [ 32%]
tests/test_ev_calculator.py::test_calculate_final_metrics_red_flag_ror PASSED [ 32%]
tests/test_ev_calculator.py::test_compute_ev_roi_basic_functionality PASSED [ 32%]
tests/test_ev_calculator.py::test_compute_ev_roi_invalid_budget PASSED   [ 32%]
tests/test_ev_calculator.py::test_compute_ev_roi_invalid_variance_cap_config PASSED [ 32%]
tests/test_ev_calculator.py::test_compute_ev_roi_with_optimize_true PASSED [ 32%]
tests/test_ev_calculator.py::test_compute_ev_roi_variance_capping PASSED [ 32%]
tests/test_ev_thresholds.py::test_ev_sp_below_default_threshold 
-------------------------------- live log call ---------------------------------
2026-01-11 21:38:59 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 32%]
tests/test_ev_thresholds.py::test_ev_global_below_default_threshold 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:00 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 32%]
tests/test_ev_thresholds.py::test_validate_policy_roi_below_threshold PASSED [ 33%]
tests/test_ev_thresholds.py::test_validate_policy_raises_on_low_roi_message PASSED [ 33%]
tests/test_evaluate_combo.py::test_default_config_path_missing PASSED    [ 33%]
tests/test_evaluate_combo.py::test_env_path_missing PASSED               [ 33%]
tests/test_evaluate_combo.py::test_env_path_present PASSED               [ 33%]
tests/test_evaluate_combo.py::test_gates_when_calibration_missing PASSED [ 33%]
tests/test_evaluate_combo.py::test_override_missing_calibration 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:00 [WARNING] [COMBO] allow_heuristic override ignored; payout calibration is mandatory for combo evaluation.
PASSED                                                                   [ 33%]
tests/test_evaluate_combo.py::test_with_calibration PASSED               [ 33%]
tests/test_evaluate_combo.py::test_marks_unreliable_probabilities 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:00 [WARNING] [COMBO] allow_heuristic override ignored; payout calibration is mandatory for combo evaluation.
PASSED                                                                   [ 33%]
tests/test_fetch_je_stats.py::test_normalise_text[  Test String  -teststring] PASSED [ 33%]
tests/test_fetch_je_stats.py::test_normalise_text[\xc9curie Sp\xe9ciale-ecuriespeciale] PASSED [ 33%]
tests/test_fetch_je_stats.py::test_normalise_text[J. VANMEERBECK-jvanmeerbeck] PASSED [ 34%]
tests/test_fetch_je_stats.py::test_parse_percentage[R\xe9ussite jockey/cheval : 15%-15.0] PASSED [ 34%]
tests/test_fetch_je_stats.py::test_parse_percentage[Ratio: 3 / 10-30.0] PASSED [ 34%]
tests/test_fetch_je_stats.py::test_parse_percentage[Victoires : 5-5.0] PASSED [ 34%]
tests/test_fetch_je_stats.py::test_parse_percentage[Taux de r\xe9ussite : 0.25-25.0] PASSED [ 34%]
tests/test_fetch_je_stats.py::test_parse_percentage[Just a number 42.5 here-42.5] PASSED [ 34%]
tests/test_fetch_je_stats.py::test_parse_percentage[No number here-None] PASSED [ 34%]
tests/test_fetch_je_stats.py::test_parse_percentage[-None] PASSED        [ 34%]
tests/test_fetch_je_stats.py::test_parse_percentage[Victoires=10-10.0] PASSED [ 34%]
tests/test_fetch_je_stats.py::test_parse_percentage[12,5%-12.5] PASSED   [ 34%]
tests/test_fetch_je_stats.py::test_extract_links_from_horse_page ERROR   [ 34%]
tests/test_fetch_je_stats.py::test_extract_rate_from_profile ERROR       [ 34%]
tests/test_fetch_je_stats.py::test_discover_horse_url_by_name ERROR      [ 35%]
tests/test_fetch_je_stats.py::test_discover_horse_url_by_name_http_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:00 [WARNING] Failed to fetch Geny search results for Bold Eagle
PASSED                                                                   [ 35%]
tests/test_fetch_je_stats.py::test_parse_horse_percentages_success ERROR [ 35%]
tests/test_fetch_je_stats.py::test_parse_horse_percentages_handles_failures 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:00 [WARNING] Failed to fetch horse page http://horse.url
PASSED                                                                   [ 35%]
tests/test_fetch_je_stats.py::test_collect_stats_edge_cases[h5_data0-0-0-None] ERROR [ 35%]
tests/test_fetch_je_stats.py::test_collect_stats_edge_cases[h5_data1-0-1-] ERROR [ 35%]
tests/test_fetch_je_stats.py::test_collect_stats_edge_cases[h5_data2-0-1-] ERROR [ 35%]
tests/test_fetch_je_stats.py::test_collect_stats_edge_cases[h5_data3-100-1-] ERROR [ 35%]
tests/test_fetch_je_stats.py::test_discover_horse_url_by_name_empty_name PASSED [ 35%]
tests/test_fetch_je_stats.py::test_extract_rate_from_profile_not_found PASSED [ 35%]
tests/test_fetch_je_stats.py::test_main_function_calls_collect_stats PASSED [ 35%]
tests/test_fetch_je_stats.py::test_collect_stats_local_filesystem ERROR  [ 36%]
tests/test_fetch_je_stats.py::test_enrich_from_snapshot_calls_subprocess PASSED [ 36%]
tests/test_fetch_je_stats.py::test_collect_stats_integration ERROR       [ 36%]
tests/test_firestore_client.py::test_update_race_document_success 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:01 [INFO] Updating Firestore document
PASSED                                                                   [ 36%]
tests/test_firestore_client.py::test_update_race_document_handles_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:01 [ERROR] Failed to update document some_id: Firestore unavailable
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/firestore_client.py", line 87, in update_race_document
    doc_ref = db_client.collection(config.FIRESTORE_COLLECTION).document(document_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
Exception: Firestore unavailable
PASSED                                                                   [ 36%]
tests/test_firestore_client.py::test_update_race_document_skips_if_db_not_available PASSED [ 36%]
tests/test_firestore_client.py::test_get_races_for_date_success FAILED   [ 36%]
tests/test_firestore_client.py::test_get_races_for_date_empty FAILED     [ 36%]
tests/test_firestore_client.py::test_get_races_for_date_handles_exception FAILED [ 36%]
tests/test_firestore_client.py::test_get_races_for_date_skips_if_db_not_available FAILED [ 36%]
tests/test_firestore_client.py::test_get_doc_id_from_url[https://www.zeturf.fr/fr/course/2025-12-25/R1C2-test-pmu-2025-12-25-2025-12-25_R1C2] PASSED [ 36%]
tests/test_firestore_client.py::test_get_doc_id_from_url[https://turf.fr/R5C3/details-2025-12-25-2025-12-25_R5C3] PASSED [ 36%]
tests/test_firestore_client.py::test_get_doc_id_from_url[R3C8-2025-12-25-2025-12-25_R3C8] PASSED [ 37%]
tests/test_firestore_client.py::test_get_doc_id_from_url[R1C1-2025-12-25-2025-12-25_R1C1] PASSED [ 37%]
tests/test_firestore_client.py::test_get_doc_id_from_url[some-string-r4c1-other-2025-12-25-2025-12-25_R4C1] PASSED [ 37%]
tests/test_firestore_client.py::test_get_doc_id_from_url[invalid-url-2025-12-25-None] PASSED [ 37%]
tests/test_firestore_client.py::test_get_doc_id_from_url[-2025-12-25-None] PASSED [ 37%]
tests/test_firestore_client.py::test_get_processing_status_for_date_success FAILED [ 37%]
tests/test_firestore_client.py::test_get_processing_status_for_date_db_not_available FAILED [ 37%]
tests/test_firestore_client.py::test_get_processing_status_for_date_empty_daily_plan FAILED [ 37%]
tests/test_firestore_client.py::test_get_processing_status_for_date_explicit_empty_plan_reason FAILED [ 37%]
tests/test_firestore_client.py::test_get_processing_status_for_date_unprocessed_races FAILED [ 37%]
tests/test_firestore_client.py::test_get_processing_status_for_date_error_decision FAILED [ 37%]
tests/test_firestore_client.py::test_get_processing_status_for_date_unknown_decision FAILED [ 38%]
tests/test_firestore_client.py::test_get_document_success PASSED         [ 38%]
tests/test_firestore_client.py::test_get_document_not_found PASSED       [ 38%]
tests/test_firestore_client.py::test_get_document_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:01 [ERROR] Failed to get document 'test_doc' from 'test_collection': Connection failed
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/firestore_client.py", line 55, in get_document
    doc = doc_ref.get()
          ^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
Exception: Connection failed
PASSED                                                                   [ 38%]
tests/test_firestore_client.py::test_set_document_success PASSED         [ 38%]
tests/test_firestore_client.py::test_set_document_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:01 [ERROR] Failed to set document 'test_doc' in 'test_collection': Permission denied
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/firestore_client.py", line 73, in set_document
    db_client.collection(collection).document(document_id).set(data)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
Exception: Permission denied
PASSED                                                                   [ 38%]
tests/test_firestore_client.py::test_get_races_for_date_db_unavailable FAILED [ 38%]
tests/test_firestore_client.py::test_get_document_skips_if_db_not_available PASSED [ 38%]
tests/test_firestore_client.py::test_set_document_skips_if_db_not_available PASSED [ 38%]
tests/test_firestore_client_extended.py::test_get_processing_status_for_date_processing_stalled FAILED [ 38%]
tests/test_firestore_client_extended.py::test_get_processing_status_for_date_db_empty FAILED [ 38%]
tests/test_gcs_client_extended.py::test_gcs_manager_init PASSED          [ 38%]
tests/test_gcs_client_extended.py::test_gcs_manager_init_no_bucket 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:01 [WARNING] GCS_BUCKET is not set in the configuration, but GCS_ENABLED is True. GCS operations will fail.
PASSED                                                                   [ 39%]
tests/test_gcs_client_extended.py::test_gcs_manager_lazy_init PASSED     [ 39%]
tests/test_gcs_client_extended.py::test_get_gcs_path PASSED              [ 39%]
tests/test_gcs_client_extended.py::test_file_exists PASSED               [ 39%]
tests/test_gcs_client_extended.py::test_get_gcs_manager_no_bucket PASSED [ 39%]
tests/test_gcs_client_extended.py::test_get_gcs_manager_singleton PASSED [ 39%]
tests/test_gcs_client_extended.py::test_get_gcs_fs_no_manager 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [INFO] GCS operations are disabled because BUCKET_NAME is not set.
2026-01-11 21:39:02 [ERROR] GCSManager is not initialized. Cannot get filesystem.
PASSED                                                                   [ 39%]
tests/test_gcs_client_extended.py::test_build_gcs_path PASSED            [ 39%]
tests/test_gcs_client_extended.py::test_build_gcs_path_no_manager 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [ERROR] GCSManager is not initialized. Cannot build GCS path.
PASSED                                                                   [ 39%]
tests/test_gcs_client_extended.py::test_gcs_manager_save_json_to_gcs_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [INFO] Saving JSON to GCS: gs://test-bucket/error.json
2026-01-11 21:39:02 [ERROR] Failed to save JSON to GCS at gs://test-bucket/error.json: Mock GCS write error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/gcs_client.py", line 178, in save_json_to_gcs
    json.dump(data, f)
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
Exception: Mock GCS write error
PASSED                                                                   [ 39%]
tests/test_gcs_client_extended.py::test_gcs_manager_save_json_to_gcs_success 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [INFO] Saving JSON to GCS: gs://test-bucket/test.json
2026-01-11 21:39:02 [INFO] Successfully saved JSON to gs://test-bucket/test.json
PASSED                                                                   [ 39%]
tests/test_gcs_client_extended.py::test_global_save_json_to_gcs_success PASSED [ 40%]
tests/test_gcs_client_extended.py::test_global_save_json_to_gcs_no_manager_raises_runtime_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [ERROR] GCSManager not initialized. Cannot save JSON to gs://test-bucket/error.json.
PASSED                                                                   [ 40%]
tests/test_gcs_client_extended.py::test_gcs_manager_list_files_success FAILED [ 40%]
tests/test_gcs_client_extended.py::test_gcs_manager_list_files_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [ERROR] Failed to list files in GCS at gs://test-bucket/dir/: Mock GCS list error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/gcs_client.py", line 133, in list_files
    files_info = self.fs.ls(gcs_uri, detail=True)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
Exception: Mock GCS list error
PASSED                                                                   [ 40%]
tests/test_gcs_client_extended.py::test_gcs_manager_read_file_from_gcs_success PASSED [ 40%]
tests/test_gcs_client_extended.py::test_gcs_manager_read_file_from_gcs_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [ERROR] Failed to read file from GCS at gs://test-bucket/path/to/file.json: Mock GCS read error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/gcs_client.py", line 155, in read_file_from_gcs
    with self.fs.open(gcs_uri, 'r') as f:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
Exception: Mock GCS read error
PASSED                                                                   [ 40%]
tests/test_gcs_client_extended.py::test_global_list_files_gcs_enabled_success PASSED [ 40%]
tests/test_gcs_client_extended.py::test_global_list_files_gcs_disabled_local_fallback 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [INFO] GCS operations are disabled because GCS_ENABLED is False.
2026-01-11 21:39:02 [INFO] GCS disabled or manager not initialized. Listing files locally from: data/test_race/snapshots/
PASSED                                                                   [ 40%]
tests/test_gcs_client_extended.py::test_global_read_file_from_gcs_gcs_enabled_success PASSED [ 40%]
tests/test_gcs_client_extended.py::test_global_read_file_from_gcs_gcs_disabled_local_fallback 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [INFO] GCS operations are disabled because GCS_ENABLED is False.
2026-01-11 21:39:02 [INFO] GCS disabled or manager not initialized. Reading file locally from: data/local_file.json
2026-01-11 21:39:02 [INFO] GCS operations are disabled because GCS_ENABLED is False.
2026-01-11 21:39:02 [INFO] GCS disabled or manager not initialized. Reading file locally from: gs://test-bucket/data/local_file.json
PASSED                                                                   [ 40%]
tests/test_gcs_client_extended.py::test_global_read_file_from_gcs_gcs_disabled_local_file_not_found 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [INFO] GCS operations are disabled because GCS_ENABLED is False.
2026-01-11 21:39:02 [INFO] GCS disabled or manager not initialized. Reading file locally from: data/non_existent.json
2026-01-11 21:39:02 [WARNING] Local file not found: data/non_existent.json
PASSED                                                                   [ 40%]
tests/test_gcs_utils.py::test_is_gcs_enabled PASSED                      [ 40%]
tests/test_gcs_utils.py::test_is_gcs_disabled PASSED                     [ 41%]
tests/test_gcs_utils.py::test_disabled_reason_when_disabled PASSED       [ 41%]
tests/test_gcs_utils.py::test_disabled_reason_when_enabled PASSED        [ 41%]
tests/test_gcs_utils.py::test_get_gcs_client_initialization_success PASSED [ 41%]
tests/test_gcs_utils.py::test_get_gcs_client_initialization_failure 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [ERROR] Failed to initialize GCS client: Auth failure
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/gcs_utils.py", line 23, in _get_gcs_client
    _gcs_client = storage.Client()
                  ^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
Exception: Auth failure
PASSED                                                                   [ 41%]
tests/test_gcs_utils.py::test_upload_file_gcs_disabled PASSED            [ 41%]
tests/test_gcs_utils.py::test_upload_file_client_is_none PASSED          [ 41%]
tests/test_gcs_utils.py::test_upload_file_local_file_not_found 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [WARNING] Local file not found, cannot upload to GCS: nonexistent/file.json
PASSED                                                                   [ 41%]
tests/test_gcs_utils.py::test_upload_file_path_construction[data/snapshots/R1C1/file.json-prod/snapshots/R1C1/file.json] PASSED [ 41%]
tests/test_gcs_utils.py::test_upload_file_path_construction[snapshots/R1C2/file.json-prod/snapshots/R1C2/file.json] PASSED [ 41%]
tests/test_gcs_utils.py::test_upload_file_path_construction[analyses/R1C3/file.json-prod/analyses/R1C3/file.json] PASSED [ 41%]
tests/test_gcs_utils.py::test_upload_file_path_construction[some/other/path/data/analyses/R1/file.json-prod/analyses/R1/file.json] PASSED [ 42%]
tests/test_gcs_utils.py::test_upload_file_path_construction[unknown/path/file.json-prod/unknown/path/file.json] PASSED [ 42%]
tests/test_gcs_utils.py::test_upload_file_gcs_api_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [ERROR] Failed to upload data/snapshots/R1C1/file.json to GCS: 403 Permission denied
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/gcs_utils.py", line 85, in upload_file
    blob.upload_from_filename(str(local_file))
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
google.api_core.exceptions.Forbidden: 403 Permission denied
PASSED                                                                   [ 42%]
tests/test_guardrails.py::test_evaluate_guardrail_uses_multiple_paths PASSED [ 42%]
tests/test_guardrails.py::test_evaluate_guardrail_detects_low_values PASSED [ 42%]
tests/test_guardrails.py::test_load_json_raises_on_non_object PASSED     [ 42%]
tests/test_guardrails.py::test_extract_metric_returns_zero_when_missing PASSED [ 42%]
tests/test_guardrails.py::test_append_env_writes_to_file PASSED          [ 42%]
tests/test_guardrails.py::test_main_success_path PASSED                  [ 42%]
tests/test_guardrails.py::test_main_abstention_path_creates_report PASSED [ 42%]
tests/test_guardrails.py::test_main_file_not_found PASSED                [ 42%]
tests/test_kelly.py::test_kelly_fraction[0.5-3.0-1.0-1.0-0.25] PASSED    [ 43%]
tests/test_kelly.py::test_kelly_fraction[0.2-3.0-1.0-1.0-0.0] PASSED     [ 43%]
tests/test_kelly.py::test_kelly_fraction[0.3333333333333333-3.0-1.0-1.0-0.0] PASSED [ 43%]
tests/test_kelly.py::test_kelly_fraction[0.5-3.0-0.5-1.0-0.125] PASSED   [ 43%]
tests/test_kelly.py::test_kelly_fraction[0.8-3.0-1.0-0.2-0.2] PASSED     [ 43%]
tests/test_kelly.py::test_kelly_fraction[0.8-3.0-0.5-0.3-0.3] PASSED     [ 43%]
tests/test_kelly.py::test_kelly_fraction[1.5-3.0-1.0-1.0-0.0] PASSED     [ 43%]
tests/test_kelly.py::test_kelly_fraction[0.0-3.0-1.0-1.0-0.0] PASSED     [ 43%]
tests/test_kelly.py::test_kelly_fraction[-0.5-3.0-1.0-1.0-0.0] PASSED    [ 43%]
tests/test_kelly.py::test_kelly_fraction[0.5-1.0-1.0-1.0-0.0] PASSED     [ 43%]
tests/test_kelly.py::test_kelly_fraction[0.5-0.5-1.0-1.0-0.0] PASSED     [ 43%]
tests/test_kelly.py::test_kelly_fraction[0.5-3.0--0.5-1.0-0.25] PASSED   [ 43%]
tests/test_kelly.py::test_kelly_fraction[0.8-3.0-1.0-1.5-0.7] PASSED     [ 44%]
tests/test_kelly.py::test_kelly_stake PASSED                             [ 44%]
tests/test_kelly_cap.py::test_kelly_cap_limits_stakes PASSED             [ 44%]
tests/test_kelly_cap.py::test_validate_budget_ok PASSED                  [ 44%]
tests/test_kelly_cap.py::test_validate_budget_total_exceeded PASSED      [ 44%]
tests/test_kelly_cap.py::test_validate_budget_horse_cap_exceeded PASSED  [ 44%]
tests/test_logging_io.py::test_append_csv_line_local_filesystem PASSED   [ 44%]
tests/test_logging_io.py::test_append_csv_line_appends_locally PASSED    [ 44%]
tests/test_logging_io.py::test_append_json_local_filesystem PASSED       [ 44%]
tests/test_logging_io.py::test_append_json_gcs PASSED                    [ 44%]
tests/test_no_vig_ev.py::test_no_vig_sum_to_one PASSED                   [ 44%]
tests/test_no_vig_ev.py::test_ev_drops_when_margin_higher PASSED         [ 45%]
tests/test_online_fetch_start_time.py::test_extract_start_time_from_programme_row[<td class='hour'>14h05</td>-14:05] PASSED [ 45%]
tests/test_online_fetch_start_time.py::test_extract_start_time_from_programme_row[<td class='hour'> 9h30 </td>-09:30] PASSED [ 45%]
tests/test_online_fetch_start_time.py::test_extract_start_time_from_programme_row[<td class='hour'>21:45</td>-21:45] PASSED [ 45%]
tests/test_online_fetch_start_time.py::test_extract_start_time_from_programme_row[<td class='hour'>08:15</td>-08:15] PASSED [ 45%]
tests/test_online_fetch_start_time.py::test_extract_start_time_from_programme_row[<td class='hour'>12h00</td>-12:00] PASSED [ 45%]
tests/test_online_fetch_start_time.py::test_extract_start_time_from_programme_row[<td class='hour'>No time here</td>-None] PASSED [ 45%]
tests/test_online_fetch_start_time.py::test_extract_start_time_from_programme_row[<td></td>-None] PASSED [ 45%]
tests/test_orchestrator_runner.py::test_extract_rc_from_url_success[https://www.boturfers.fr/courses/2025-01-01/r2c3-race-name-R2-C3] PASSED [ 45%]
tests/test_orchestrator_runner.py::test_extract_rc_from_url_success[https://www.boturfers.fr/courses/2025-01-01/R2C3-race-name-R2-C3] PASSED [ 45%]
tests/test_orchestrator_runner.py::test_extract_rc_from_url_success[https://www.zeturf.fr/fr/course/2025-12-25/R1C2-test-R1-C2] PASSED [ 45%]
tests/test_orchestrator_runner.py::test_extract_rc_from_url_success[https://zeturf.com/R12C5/details-R12-C5] PASSED [ 45%]
tests/test_orchestrator_runner.py::test_extract_rc_from_url_no_match_raises_value_error PASSED [ 46%]
tests/test_orchestrator_runner.py::test_run_course_extract_rc_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [ERROR] Invalid URL format
PASSED                                                                   [ 46%]
tests/test_orchestrator_runner.py::test_run_course_analysis_pipeline_success 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [INFO] Starting Firestore-native course analysis
2026-01-11 21:39:02 [INFO] Course analysis completed successfully.
PASSED                                                                   [ 46%]
tests/test_orchestrator_runner.py::test_run_course_analysis_pipeline_failure PASSED [ 46%]
tests/test_orchestrator_runner.py::test_run_course_unexpected_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [ERROR] Course analysis failed.
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/runner.py", line 68, in run_course
    analysis_result = await analysis_pipeline.run_analysis_for_phase(
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
Exception: Unexpected error
PASSED                                                                   [ 46%]
tests/test_overround.py::test_compute_overround_place_nominal PASSED     [ 46%]
tests/test_overround.py::test_compute_overround_place_with_odds_place_fallback PASSED [ 46%]
tests/test_overround.py::test_compute_overround_place_with_cote_fallback PASSED [ 46%]
tests/test_overround.py::test_compute_overround_place_mixed_sources PASSED [ 46%]
tests/test_overround.py::test_compute_overround_place_handles_invalid_data PASSED [ 46%]
tests/test_overround.py::test_compute_overround_place_empty_list 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [WARNING] Could not calculate place overround: no valid place odds found.
PASSED                                                                   [ 46%]
tests/test_overround.py::test_compute_overround_place_no_valid_odds 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [WARNING] Could not calculate place overround: no valid place odds found.
PASSED                                                                   [ 47%]
tests/test_overround.py::test_adaptive_cap_returns_base_cap PASSED       [ 47%]
tests/test_p_finale.py::test_apply_drift_steam_no_pval PASSED            [ 47%]
tests/test_p_finale.py::test_apply_drift_steam_no_maps PASSED            [ 47%]
tests/test_p_finale.py::test_apply_drift_steam_invalid_map_data PASSED   [ 47%]
tests/test_p_finale.py::test_apply_drift_steam_applies_steam_bonus PASSED [ 47%]
tests/test_p_finale.py::test_apply_drift_steam_applies_drift_penalty_to_fav PASSED [ 47%]
tests/test_p_finale.py::test_apply_drift_steam_no_penalty_for_drifting_non_favorite PASSED [ 47%]
tests/test_p_finale.py::test_apply_drift_steam_no_change_if_delta_not_met PASSED [ 47%]
tests/test_p_finale.py::test_generate_p_finale_data_finds_runners_in_different_keys[runners] PASSED [ 47%]
tests/test_p_finale.py::test_generate_p_finale_data_finds_runners_in_different_keys[horses] PASSED [ 47%]
tests/test_p_finale.py::test_generate_p_finale_data_finds_runners_in_different_keys[partants] PASSED [ 47%]
tests/test_p_finale.py::test_generate_p_finale_data_empty_if_no_runners PASSED [ 48%]
tests/test_p_finale.py::test_generate_p_finale_data_extracts_all_fields_with_fallbacks PASSED [ 48%]
tests/test_p_finale.py::test_generate_p_finale_data_handles_non_dict_runners PASSED [ 48%]
tests/test_p_finale.py::test_generate_p_finale_data_calls_apply_drift_steam PASSED [ 48%]
tests/test_p_finale.py::test_generate_p_finale_data_no_drift_call_if_maps_missing PASSED [ 48%]
tests/test_p_finale_export.py::test_export_creates_csv_and_excel PASSED  [ 48%]
tests/test_p_finale_extended.py::test_apply_drift_steam[0.5-1-p5_map0-p30_map0-2-0.515] PASSED [ 48%]
tests/test_p_finale_extended.py::test_apply_drift_steam[0.5-1-p5_map1-p30_map1-1-0.485] PASSED [ 48%]
tests/test_p_finale_extended.py::test_apply_drift_steam[0.5-1-p5_map2-p30_map2-2-0.5] PASSED [ 48%]
tests/test_p_finale_extended.py::test_apply_drift_steam[0.5-1-p5_map3-p30_map3-1-0.5] PASSED [ 48%]
tests/test_p_finale_extended.py::test_apply_drift_steam[0.5-1-None-p30_map4-1-0.5] PASSED [ 48%]
tests/test_p_finale_extended.py::test_apply_drift_steam[0.5-1-p5_map5-None-1-0.5] PASSED [ 49%]
tests/test_p_finale_extended.py::test_apply_drift_steam[None-1-p5_map6-p30_map6-1-0.0] PASSED [ 49%]
tests/test_p_finale_extended.py::test_generate_p_finale_data_basic PASSED [ 49%]
tests/test_p_finale_extended.py::test_generate_p_finale_data_empty_runners PASSED [ 49%]
tests/test_p_finale_extended.py::test_generate_p_finale_data_no_drift_config PASSED [ 49%]
tests/test_pipeline_run.py::test_generate_tickets_abstains_when_roi_is_low 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [INFO] Runner 1: ROI = 0.5
2026-01-11 21:39:02 [INFO] Runner 2: ROI = 0.5
PASSED                                                                   [ 49%]
tests/test_pipeline_run.py::test_generate_tickets_creates_sp_dutching_ticket_when_roi_is_high 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [INFO] Runner 1: ROI = 0.8181818181818181
2026-01-11 21:39:02 [INFO] Runner 2: ROI = 0.8181818181818182
2026-01-11 21:39:02 [INFO] Runner 3: ROI = 0.8181818181818183
PASSED                                                                   [ 49%]
tests/test_pipeline_run.py::test_generate_tickets_abstains_when_global_roi_is_low 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:02 [INFO] Runner 1: ROI = 0.3928571428571429
2026-01-11 21:39:02 [INFO] Runner 2: ROI = 0.3928571428571431
PASSED                                                                   [ 49%]
tests/test_pipeline_run.py::test_generate_tickets_creates_trio_ticket_with_best_roi 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:03 [INFO] Runner 1: ROI = 0.3166144200626959
2026-01-11 21:39:03 [INFO] Runner 2: ROI = 0.31661442006269613
2026-01-11 21:39:03 [INFO] Runner 3: ROI = 0.3166144200626959
2026-01-11 21:39:03 [INFO] Runner 4: ROI = 0.316614420062696
PASSED                                                                   [ 49%]
tests/test_pipeline_run_extended.py::test_normalize_probs_empty_list PASSED [ 49%]
tests/test_pipeline_run_extended.py::test_normalize_probs_zero_sum PASSED [ 49%]
tests/test_pipeline_run_extended.py::test_initialize_and_validate_success PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_initialize_and_validate_missing_budget_raises_error PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_initialize_and_validate_empty_runners_raises_error PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_initialize_and_validate_missing_critical_key_raises_error PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_calculate_adjusted_probabilities_missing_base_probabilities_raises_error PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_calculate_adjusted_probabilities_p_base_fallback_from_win_odds PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_calculate_adjusted_probabilities_real_favorites_detection PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_calculate_adjusted_probabilities_overround_calculation PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_apply_base_stat_adjustment_je_bonus PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_apply_base_stat_adjustment_je_malus PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_apply_base_stat_adjustment_volatility_bonus PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_apply_base_stat_adjustment_musique_score PASSED [ 50%]
tests/test_pipeline_run_extended.py::test_apply_base_stat_adjustment_no_je_or_volatility_data PASSED [ 51%]
tests/test_pipeline_run_extended.py::test_apply_base_stat_adjustment_je_neutral PASSED [ 51%]
tests/test_pipeline_run_extended.py::test_apply_base_stat_adjustment_je_invalid_rate_type PASSED [ 51%]
tests/test_pipeline_run_extended.py::test_apply_chrono_adjustment_success PASSED [ 51%]
tests/test_pipeline_run_extended.py::test_apply_chrono_adjustment_no_best_chronos PASSED [ 51%]
tests/test_pipeline_run_extended.py::test_apply_chrono_adjustment_malformed_chrono_data PASSED [ 51%]
tests/test_pipeline_run_extended.py::test_apply_drift_adjustment_no_h30_odds PASSED [ 51%]
tests/test_pipeline_run_extended.py::test_apply_drift_adjustment_stable_odds PASSED [ 51%]
tests/test_pipeline_run_extended.py::test_apply_drift_adjustment_drift_detected PASSED [ 51%]
tests/test_pipeline_run_extended.py::test_apply_drift_adjustment_steam_detected PASSED [ 51%]
tests/test_pipeline_run_extended.py::test_apply_drift_adjustment_favorite_drift_factor PASSED [ 51%]
tests/test_pipeline_run_extended.py::test_apply_drift_adjustment_outsider_steam_factor PASSED [ 52%]
tests/test_pipeline_run_extended.py::test_apply_drift_adjustment_medium_drift_no_special_factors PASSED [ 52%]
tests/test_pipeline_run_extended.py::test_select_sp_dutching_candidates_min_candidates PASSED [ 52%]
tests/test_pipeline_run_extended.py::test_select_sp_dutching_candidates_mid_range_priority PASSED [ 52%]
tests/test_pipeline_run_extended.py::test_select_sp_dutching_candidates_max_candidates_limit PASSED [ 52%]
tests/test_pipeline_run_extended.py::test_generate_sp_dutching_tickets_no_profitable_candidates 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:03 [INFO] Runner 2: ROI = -0.7
2026-01-11 21:39:03 [INFO] Runner 3: ROI = -0.6
PASSED                                                                   [ 52%]
tests/test_pipeline_run_extended.py::test_generate_sp_dutching_tickets_profitable_candidates_creates_ticket 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:03 [INFO] Runner 1: ROI = 1.0800000000000003
2026-01-11 21:39:03 [INFO] Runner 2: ROI = 1.0999999999999999
PASSED                                                                   [ 52%]
tests/test_pipeline_run_extended.py::test_get_legs_for_exotic_type[COUPLE-2] PASSED [ 52%]
tests/test_pipeline_run_extended.py::test_get_legs_for_exotic_type[COUPLE_PLACE-2] PASSED [ 52%]
tests/test_pipeline_run_extended.py::test_get_legs_for_exotic_type[ZE234-2] PASSED [ 52%]
tests/test_pipeline_run_extended.py::test_get_legs_for_exotic_type[TRIO-3] PASSED [ 52%]
tests/test_pipeline_run_extended.py::test_get_legs_for_exotic_type[ZE4-4] PASSED [ 52%]
tests/test_pipeline_run_extended.py::test_get_legs_for_exotic_type[UNKNOWN-3] 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:03 [WARNING] Unknown exotic type 'UNKNOWN', assuming 3 legs.
PASSED                                                                   [ 53%]
tests/test_pipeline_run_extended.py::test_generate_exotic_tickets_no_profitable_combos PASSED [ 53%]
tests/test_pipeline_run_extended.py::test_generate_exotic_tickets_overround_too_high PASSED [ 53%]
tests/test_pipeline_run_extended.py::test_generate_exotic_tickets_no_allowed_types PASSED [ 53%]
tests/test_pipeline_run_extended.py::test_generate_exotic_tickets_not_enough_sp_candidates PASSED [ 53%]
tests/test_pipeline_run_extended.py::test_generate_exotic_tickets_multiple_profitable_combos_updates_best PASSED [ 53%]
tests/test_pipeline_run_extended.py::test_finalize_and_decide_no_tickets PASSED [ 53%]
tests/test_pipeline_run_extended.py::test_finalize_and_decide_low_global_roi PASSED [ 53%]
tests/test_pipeline_run_extended.py::test_finalize_and_decide_play PASSED [ 53%]
tests/test_pipeline_run_extended.py::test_generate_tickets_populates_top5_pronostic PASSED [ 53%]
tests/test_pipeline_run_extended.py::test_generate_tickets_populates_market_analysis_table PASSED [ 53%]
tests/test_pipeline_run_extended.py::test_calculate_adjusted_probabilities_p_base_value_error PASSED [ 54%]
tests/test_plan.py::test_build_plan_nominal_case 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:03 [INFO] Building plan for 2025-12-20 using ProgrammeProvider.
2026-01-11 21:39:03 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:39:03 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:03 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:39:03 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:03 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:39:03 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:39:03 [WARNING] Failed to fetch programme for 2025-12-20 from any source.
FAILED                                                                   [ 54%]
tests/test_plan.py::test_build_plan_scraper_fails 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:03 [INFO] Building plan for 2025-12-20 using ProgrammeProvider.
2026-01-11 21:39:03 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:39:03 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:03 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:39:03 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:03 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:39:03 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:39:03 [WARNING] Failed to fetch programme for 2025-12-20 from any source.
FAILED                                                                   [ 54%]
tests/test_plan.py::test_build_plan_handles_malformed_data 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:03 [INFO] Building plan for 2025-12-20 using ProgrammeProvider.
2026-01-11 21:39:03 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:39:03 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:03 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:39:03 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:03 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:39:03 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:39:03 [WARNING] Failed to fetch programme for 2025-12-20 from any source.
FAILED                                                                   [ 54%]
tests/test_plan.py::test_build_plan_today_string 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:03 [INFO] Building plan for 2026-01-11 using ProgrammeProvider.
2026-01-11 21:39:03 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:39:03 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2026-01-11 (implémentation factice).
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:39:04 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2026-01-11 (implémentation factice).
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:39:04 [INFO] [BoturfersProgrammeProvider] Récupération du programme depuis https://www.boturfers.fr/programme-pmu-du-jour
2026-01-11 21:39:04 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:39:04 [WARNING] Failed to fetch programme for 2026-01-11 from any source.
PASSED                                                                   [ 54%]
tests/test_plan.py::test_build_plan_empty_enriched_plan 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:04 [INFO] Building plan for 2025-12-20 using ProgrammeProvider.
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:39:04 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:39:04 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:39:04 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:39:04 [WARNING] Failed to fetch programme for 2025-12-20 from any source.
PASSED                                                                   [ 54%]
tests/test_plan.py::test_build_plan_partants_non_digit_string 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:04 [INFO] Building plan for 2025-12-20 using ProgrammeProvider.
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:39:04 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:39:04 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:39:04 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:39:04 [WARNING] Failed to fetch programme for 2025-12-20 from any source.
FAILED                                                                   [ 54%]
tests/test_plan.py::test_build_plan_handles_compact_rc_format 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:04 [INFO] Building plan for 2025-12-20 using ProgrammeProvider.
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:39:04 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:39:04 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:39:04 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:39:04 [WARNING] Failed to fetch programme for 2025-12-20 from any source.
FAILED                                                                   [ 54%]
tests/test_plan.py::test_build_plan_sync_wrapper 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:04 [WARNING] build_plan() is deprecated, use build_plan_async() instead
PASSED                                                                   [ 54%]
tests/test_plan.py::test_build_plan_sync_raises_in_event_loop 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:04 [WARNING] build_plan() is deprecated, use build_plan_async() instead
2026-01-11 21:39:04 [ERROR] Cannot use build_plan() from within event loop. Use build_plan_async() instead.
PASSED                                                                   [ 54%]
tests/test_plan.py::test_build_plan_sync_reraises_other_runtime_errors 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:04 [WARNING] build_plan() is deprecated, use build_plan_async() instead
PASSED                                                                   [ 54%]
tests/test_plan_extended.py::test_build_plan_handles_various_invalid_rc_formats 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:04 [INFO] Building plan for 2025-12-20 using ProgrammeProvider.
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:39:04 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:04 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:39:04 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:05 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:39:05 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:39:05 [WARNING] Failed to fetch programme for 2025-12-20 from any source.
FAILED                                                                   [ 54%]
tests/test_plan_extended.py::test_build_plan_data_types 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:05 [INFO] Building plan for 2025-12-20 using ProgrammeProvider.
2026-01-11 21:39:05 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:39:05 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:05 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:39:05 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:05 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:39:05 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:39:05 [WARNING] Failed to fetch programme for 2025-12-20 from any source.
FAILED                                                                   [ 55%]
tests/test_plan_extended.py::test_build_plan_invalid_runners_count 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:05 [INFO] Building plan for 2025-12-20 using ProgrammeProvider.
2026-01-11 21:39:05 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:39:05 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:05 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:39:05 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:05 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:39:05 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:39:05 [WARNING] Failed to fetch programme for 2025-12-20 from any source.
FAILED                                                                   [ 55%]
tests/test_plan_extended.py::test_build_plan_mandatory_keys 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:05 [INFO] Building plan for 2025-12-20 using ProgrammeProvider.
2026-01-11 21:39:05 [INFO] Tentative avec le provider de programme: PmuProgrammeProvider
2026-01-11 21:39:05 [INFO] [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:05 [INFO] Tentative avec le provider de programme: GenyProgrammeProvider
2026-01-11 21:39:05 [INFO] [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
2026-01-11 21:39:05 [INFO] Tentative avec le provider de programme: BoturfersProgrammeProvider
2026-01-11 21:39:05 [WARNING] Aucun provider de programme n'a pu fournir de plan.
2026-01-11 21:39:05 [WARNING] Failed to fetch programme for 2025-12-20 from any source.
FAILED                                                                   [ 55%]
tests/test_post_course_payload.py::test_merge_meta_both_sources PASSED   [ 55%]
tests/test_post_course_payload.py::test_merge_meta_tickets_takes_priority PASSED [ 55%]
tests/test_post_course_payload.py::test_merge_meta_with_top_level_keys PASSED [ 55%]
tests/test_post_course_payload.py::test_merge_meta_handles_missing_or_invalid_inputs PASSED [ 55%]
tests/test_post_course_payload.py::test_merge_meta_model_alias PASSED    [ 55%]
tests/test_post_course_payload.py::test_compute_post_course_summary_nominal PASSED [ 55%]
tests/test_post_course_payload.py::test_compute_post_course_summary_no_winners PASSED [ 55%]
tests/test_post_course_payload.py::test_compute_post_course_summary_empty_tickets PASSED [ 55%]
tests/test_post_course_payload.py::test_summarise_ticket_metrics PASSED  [ 56%]
tests/test_post_course_payload.py::test_apply_summary_to_ticket_container PASSED [ 56%]
tests/test_post_course_payload.py::test_build_payload PASSED             [ 56%]
tests/test_post_course_payload.py::test_build_payload_from_sources PASSED [ 56%]
tests/test_post_course_payload.py::test_format_csv_line PASSED           [ 56%]
tests/test_resolve_course_id.py::test_resolve_course_context_with_fallback PASSED [ 56%]
tests/test_resolve_course_id.py::test_resolve_course_context_picks_closest_future_entry PASSED [ 56%]
tests/test_resolve_course_id.py::test_resolve_course_context_errors_when_empty PASSED [ 56%]
tests/test_resolve_course_id.py::test_iter_schedule_entries_supports_fr_course_urls PASSED [ 56%]
tests/test_resolve_course_id.py::test_resolve_course_context_supports_fr_course_urls PASSED [ 56%]
tests/test_roi_monitor.py::test_load_json_safe_success PASSED            [ 56%]
tests/test_roi_monitor.py::test_load_json_safe_failure PASSED            [ 56%]
tests/test_roi_monitor.py::test_parse_tracking_csv_success PASSED        [ 57%]
tests/test_roi_monitor.py::test_parse_tracking_csv_failure PASSED        [ 57%]
tests/test_roi_monitor.py::test_collect_analyses_no_date_filter PASSED   [ 57%]
tests/test_roi_monitor.py::test_collect_analyses_with_date_filter PASSED [ 57%]
tests/test_roi_monitor.py::test_compute_statistics PASSED                [ 57%]
tests/test_roi_monitor.py::test_print_report PASSED                      [ 57%]
tests/test_roi_monitor.py::test_export_json PASSED                       [ 57%]
tests/test_roi_monitor.py::test_main_run_once PASSED                     [ 57%]
tests/test_roi_monitor.py::test_main_watch_mode PASSED                   [ 57%]
tests/test_roi_rebalancer.py::test_compute_allocation_plan_prioritises_high_ev PASSED [ 57%]
tests/test_roi_rebalancer.py::test_plan_serialisation_round_trip PASSED  [ 57%]
tests/test_roi_rebalancer.py::test_allocation_plan_requires_positive_bankroll PASSED [ 58%]
tests/test_roi_rebalancer_extended.py::test_compute_allocation_plan_empty_tickets PASSED [ 58%]
tests/test_roi_rebalancer_extended.py::test_compute_allocation_plan_no_positive_ev_tickets PASSED [ 58%]
tests/test_roi_rebalancer_extended.py::test_compute_allocation_plan_stake_cap PASSED [ 58%]
tests/test_roi_rebalancer_extended.py::test_compute_allocation_plan_invalid_ticket_format PASSED [ 58%]
tests/test_roi_rebalancer_extended.py::test_allocation_plan_serialization PASSED [ 58%]
tests/test_roi_rebalancer_extended.py::test_compute_allocation_plan_zero_bankroll PASSED [ 58%]
tests/test_roi_rebalancer_extended.py::test_extract_metrics_nominal PASSED [ 58%]
tests/test_roi_rebalancer_extended.py::test_extract_metrics_missing_metrics_block PASSED [ 58%]
tests/test_roi_rebalancer_extended.py::test_extract_metrics_ev_block PASSED [ 58%]
tests/test_roi_rebalancer_extended.py::test_extract_metrics_calculates_ev_from_roi_and_stake PASSED [ 58%]
tests/test_roi_rebalancer_extended.py::test_extract_metrics_with_invalid_values PASSED [ 59%]
tests/test_roi_rebalancer_extended.py::test_load_analysis_reports_from_dir PASSED [ 59%]
tests/test_roi_rebalancer_extended.py::test_load_analysis_reports_with_direct_file_paths PASSED [ 59%]
tests/test_roi_rebalancer_extended.py::test_load_analysis_reports_skips_malformed_files PASSED [ 59%]
tests/test_roi_rebalancer_extended.py::test_load_analysis_reports_skips_files_with_no_metrics PASSED [ 59%]
tests/test_roi_rebalancer_extended.py::test_load_analysis_reports_with_non_existent_path PASSED [ 59%]
tests/test_roi_rebalancer_extended.py::test_score_basic PASSED           [ 59%]
tests/test_roi_rebalancer_extended.py::test_score_zero_ev PASSED         [ 59%]
tests/test_roi_rebalancer_extended.py::test_score_high_risk PASSED       [ 59%]
tests/test_roi_rebalancer_extended.py::test_scale_risk_basic PASSED      [ 59%]
tests/test_roi_rebalancer_extended.py::test_scale_risk_zero_stake PASSED [ 59%]
tests/test_roi_rebalancer_extended.py::test_scale_risk_zero_target_stake PASSED [ 59%]
tests/test_roi_rebalancer_extended.py::test_scale_risk_clamps_max PASSED [ 60%]
tests/test_scheduler.py::test_schedule_all_races_dry_run_no_force 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [INFO] --- Starting schedule_all_races (Force: False, Dry Run: True) ---
2026-01-11 21:39:06 [WARNING] Skipping task: Schedule time 2026-01-11T19:08:00+00:00 is in the past.
2026-01-11 21:39:06 [WARNING] Skipping task: Schedule time 2026-01-11T19:33:00+00:00 is in the past.
2026-01-11 21:39:06 [INFO] Calculation complete. Candidates: 2, Skipped: 2
2026-01-11 21:39:06 [INFO] --- Dry run complete. Returning calculated tasks. ---
PASSED                                                                   [ 60%]
tests/test_scheduler.py::test_schedule_all_races_dry_run_with_force 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [INFO] --- Starting schedule_all_races (Force: True, Dry Run: True) ---
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.090970+00:00
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.091262+00:00
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.091635+00:00
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.092072+00:00
2026-01-11 21:39:06 [INFO] Calculation complete. Candidates: 4, Skipped: 0
2026-01-11 21:39:06 [INFO] --- Dry run complete. Returning calculated tasks. ---
PASSED                                                                   [ 60%]
tests/test_scheduler.py::test_schedule_all_races_real_run_with_force 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [INFO] --- Starting schedule_all_races (Force: True, Dry Run: False) ---
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.103368+00:00
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.103866+00:00
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.104378+00:00
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.104944+00:00
2026-01-11 21:39:06 [INFO] Calculation complete. Candidates: 4, Skipped: 0
2026-01-11 21:39:06 [INFO] --- Executing real run. Initializing Cloud Tasks client. ---
2026-01-11 21:39:06 [INFO] Enqueuing Cloud Task
2026-01-11 21:39:06 [INFO] Task created: <MagicMock name='projects/p/locations/l/queues/q/tasks/t.name' id='138885909803472'>
2026-01-11 21:39:06 [INFO] Enqueuing Cloud Task
2026-01-11 21:39:06 [INFO] Task created: <MagicMock name='projects/p/locations/l/queues/q/tasks/t.name' id='138885909803472'>
2026-01-11 21:39:06 [INFO] Enqueuing Cloud Task
2026-01-11 21:39:06 [INFO] Task created: <MagicMock name='projects/p/locations/l/queues/q/tasks/t.name' id='138885909803472'>
2026-01-11 21:39:06 [INFO] Enqueuing Cloud Task
2026-01-11 21:39:06 [INFO] Task created: <MagicMock name='projects/p/locations/l/queues/q/tasks/t.name' id='138885909803472'>
2026-01-11 21:39:06 [INFO] --- schedule_all_races complete. ---
PASSED                                                                   [ 60%]
tests/test_scheduler.py::test_schedule_all_races_real_run_no_force 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [INFO] --- Starting schedule_all_races (Force: False, Dry Run: False) ---
2026-01-11 21:39:06 [WARNING] Skipping task: Schedule time 2026-01-11T19:08:00+00:00 is in the past.
2026-01-11 21:39:06 [WARNING] Skipping task: Schedule time 2026-01-11T19:33:00+00:00 is in the past.
2026-01-11 21:39:06 [INFO] Calculation complete. Candidates: 2, Skipped: 2
2026-01-11 21:39:06 [INFO] --- Executing real run. Initializing Cloud Tasks client. ---
2026-01-11 21:39:06 [INFO] Enqueuing Cloud Task
2026-01-11 21:39:06 [INFO] Task created: <MagicMock name='projects/p/locations/l/queues/q/tasks/t.name' id='138885950785488'>
2026-01-11 21:39:06 [INFO] Enqueuing Cloud Task
2026-01-11 21:39:06 [INFO] Task created: <MagicMock name='projects/p/locations/l/queues/q/tasks/t.name' id='138885950785488'>
2026-01-11 21:39:06 [INFO] --- schedule_all_races complete. ---
PASSED                                                                   [ 60%]
tests/test_scheduler_extended.py::test_calculate_task_schedule_invalid_phase_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [ERROR] Error calculating schedule time: invalid literal for int() with base 10: 'NVALID'
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scheduler.py", line 37, in _calculate_task_schedule
    phase_minutes = int(phase[1:])
                    ^^^^^^^^^^^^^^
ValueError: invalid literal for int() with base 10: 'NVALID'
PASSED                                                                   [ 60%]
tests/test_scheduler_extended.py::test_calculate_task_schedule_invalid_race_time_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [ERROR] Error calculating schedule time: Invalid isoformat string: '2025-01-01Tnot-a-time'
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scheduler.py", line 38, in _calculate_task_schedule
    race_datetime_local = datetime.fromisoformat(f"{date}T{race_time_local}")
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: Invalid isoformat string: '2025-01-01Tnot-a-time'
PASSED                                                                   [ 60%]
tests/test_scheduler_extended.py::test_enqueue_run_task_no_service_url 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [ERROR] Service URL is not configured. Cannot create task.
PASSED                                                                   [ 60%]
tests/test_scheduler_extended.py::test_enqueue_run_task_oidc_config_missing 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [ERROR] Failed to create task for http://example.com/race: TASK_OIDC_SA_EMAIL must be set when REQUIRE_AUTH is True.
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scheduler.py", line 108, in enqueue_run_task
    raise ValueError("TASK_OIDC_SA_EMAIL must be set when REQUIRE_AUTH is True.")
ValueError: TASK_OIDC_SA_EMAIL must be set when REQUIRE_AUTH is True.
PASSED                                                                   [ 60%]
tests/test_scheduler_extended.py::test_enqueue_run_task_permission_denied 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [CRITICAL] Permission denied to create Cloud Task. Please grant 'roles/cloudtasks.enqueuer' to 'sa@example.com'. Original error: 403 Forbidden by policy
PASSED                                                                   [ 60%]
tests/test_scheduler_extended.py::test_enqueue_run_task_generic_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [ERROR] Failed to create task for http://example.com/race: Network error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scheduler.py", line 134, in enqueue_run_task
    response = client.create_task(parent=parent_path, task=task)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
Exception: Network error
PASSED                                                                   [ 60%]
tests/test_scheduler_extended.py::test_schedule_all_races_real_run_no_service_url 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [CRITICAL] Cannot execute real run without a service_url.
PASSED                                                                   [ 61%]
tests/test_scheduler_extended.py::test_schedule_all_races_cloud_tasks_client_init_fails 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [CRITICAL] Failed to initialize Cloud Tasks client: Client init failed
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scheduler.py", line 219, in schedule_all_races
    client = tasks_v2.CloudTasksClient()
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
Exception: Client init failed
PASSED                                                                   [ 61%]
tests/test_scheduler_extended.py::test_schedule_all_races_results_are_sorted 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [INFO] --- Starting schedule_all_races (Force: True, Dry Run: False) ---
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.233310+00:00
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.233635+00:00
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.233926+00:00
2026-01-11 21:39:06 [INFO] [Force Mode] Forced schedule to now + 2 minutes: 2026-01-11T20:41:06.234159+00:00
2026-01-11 21:39:06 [INFO] Calculation complete. Candidates: 4, Skipped: 0
2026-01-11 21:39:06 [INFO] --- Executing real run. Initializing Cloud Tasks client. ---
2026-01-11 21:39:06 [INFO] --- schedule_all_races complete. ---
PASSED                                                                   [ 61%]
tests/test_scraper_boturfers.py::test_boturfers_fetcher_init_success PASSED [ 61%]
tests/test_scraper_boturfers.py::test_boturfers_fetcher_init_value_error PASSED [ 61%]
tests/test_scraper_boturfers.py::test_fetcher_fetch_html_success PASSED  [ 61%]
tests/test_scraper_boturfers.py::test_fetcher_fetch_html_httpx_request_error PASSED [ 61%]
tests/test_scraper_boturfers.py::test_fetcher_fetch_html_httpx_status_error PASSED [ 61%]
tests/test_scraper_boturfers.py::test_fetcher_fetch_html_generic_exception PASSED [ 61%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_row_success PASSED [ 61%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_row_missing_elements PASSED [ 61%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_row_missing_name_tag PASSED [ 61%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_row_time_formats[14h30-14:30] PASSED [ 62%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_row_time_formats[9h05-09:05] PASSED [ 62%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_row_time_formats[11:15-11:15] PASSED [ 62%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_row_time_formats[invalid-None] PASSED [ 62%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_row_time_formats[-None] PASSED [ 62%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_row_time_formats[None-None] PASSED [ 62%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_row_runners_count_non_digit PASSED [ 62%]
tests/test_scraper_boturfers.py::test_fetcher_parse_programme_success ERROR [ 62%]
tests/test_scraper_boturfers.py::test_fetcher_parse_programme_no_reunion_tabs ERROR [ 62%]
tests/test_scraper_boturfers.py::test_fetcher_parse_programme_no_race_table_in_reunion PASSED [ 62%]
tests/test_scraper_boturfers.py::test_fetcher_parse_distance_success ERROR [ 62%]
tests/test_scraper_boturfers.py::test_fetcher_parse_distance_not_found PASSED [ 63%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_metadata_success ERROR [ 63%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_metadata_no_info_block PASSED [ 63%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_runners_from_details_page_success ERROR [ 63%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_runners_from_details_page_no_runners_table PASSED [ 63%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_runners_from_details_page_malformed_row ERROR [ 63%]
tests/test_scraper_boturfers.py::test_fetcher_get_snapshot_success ERROR [ 63%]
tests/test_scraper_boturfers.py::test_fetcher_get_snapshot_fetch_html_fails 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [ERROR] Erreur inattendue lors du fetch HTML de http://programme.url: Mock error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scrapers/boturfers.py", line 74, in _fetch_html
    response = await client.get(self.race_url, headers=HTTP_HEADERS, timeout=20)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
httpx.RequestError: Mock error
PASSED                                                                   [ 63%]
tests/test_scraper_boturfers.py::test_fetcher_get_race_snapshot_success ERROR [ 63%]
tests/test_scraper_boturfers.py::test_fetcher_get_race_snapshot_fetch_html_fails 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:06 [ERROR] Erreur inattendue lors du fetch HTML de http://race.url: Mock error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scrapers/boturfers.py", line 74, in _fetch_html
    response = await client.get(self.race_url, headers=HTTP_HEADERS, timeout=20)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
httpx.RequestError: Mock error
PASSED                                                                   [ 63%]
tests/test_scraper_boturfers.py::test_fetch_boturfers_programme_success ERROR [ 63%]
tests/test_scraper_boturfers.py::test_fetch_boturfers_programme_empty_url PASSED [ 63%]
tests/test_scraper_boturfers.py::test_fetch_boturfers_programme_fetcher_error PASSED [ 64%]
tests/test_scraper_boturfers.py::test_fetch_boturfers_programme_no_races_returned ERROR [ 64%]
tests/test_scraper_boturfers.py::test_fetch_boturfers_programme_general_exception PASSED [ 64%]
tests/test_scraper_boturfers.py::test_fetch_boturfers_race_details_success ERROR [ 64%]
tests/test_scraper_boturfers.py::test_fetch_boturfers_race_details_empty_url PASSED [ 64%]
tests/test_scraper_boturfers.py::test_fetch_boturfers_race_details_url_partant_transformation PASSED [ 64%]
tests/test_scraper_boturfers.py::test_fetch_boturfers_race_details_fetcher_error PASSED [ 64%]
tests/test_scraper_boturfers.py::test_fetch_boturfers_race_details_no_runners_returned PASSED [ 64%]
tests/test_scraper_boturfers.py::test_fetch_boturfers_race_details_general_exception PASSED [ 64%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_row_missing_link PASSED [ 64%]
tests/test_scraper_boturfers.py::test_fetcher_parse_race_metadata_missing_conditions ERROR [ 64%]
tests/test_scraper_boturfers_extended.py::test_boturfers_fetcher_init_value_error PASSED [ 65%]
tests/test_scraper_boturfers_extended.py::test_fetcher_fetch_html_httpx_status_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:07 [ERROR] Erreur HTTP lors du téléchargement de http://test.url: 404
PASSED                                                                   [ 65%]
tests/test_scraper_boturfers_extended.py::test_fetcher_fetch_html_generic_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:08 [ERROR] Erreur inattendue lors du fetch HTML de http://test.url: Network error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scrapers/boturfers.py", line 74, in _fetch_html
    response = await client.get(self.race_url, headers=HTTP_HEADERS, timeout=20)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
Exception: Network error
PASSED                                                                   [ 65%]
tests/test_scraper_boturfers_extended.py::test_parse_programme_no_reunion_tabs 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:08 [WARNING] Aucun onglet de réunion ('div.tab-pane[id^=r]') trouvé sur la page du programme.
PASSED                                                                   [ 65%]
tests/test_scraper_boturfers_extended.py::test_parse_programme_no_race_table_in_reunion PASSED [ 65%]
tests/test_scraper_boturfers_extended.py::test_parse_programme_reunion_id_from_id_attribute PASSED [ 65%]
tests/test_scraper_boturfers_extended.py::test_parse_programme_empty_race_table PASSED [ 65%]
tests/test_scraper_boturfers_extended.py::test_parse_programme_malformed_reunion_title PASSED [ 65%]
tests/test_scraper_boturfers_extended.py::test_parse_distance_not_found PASSED [ 65%]
tests/test_scraper_boturfers_extended.py::test_parse_distance_from_span_tag PASSED [ 65%]
tests/test_scraper_boturfers_extended.py::test_parse_distance_from_span_tag_fallback_after_info_block_no_distance PASSED [ 65%]
tests/test_scraper_boturfers_extended.py::test_parse_race_metadata_no_info_block 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:12 [WARNING] Aucune métadonnée de course n'a pu être extraite de http://race.url.
PASSED                                                                   [ 65%]
tests/test_scraper_boturfers_extended.py::test_parse_race_metadata_no_conditions_tag_and_no_conditions_text PASSED [ 66%]
tests/test_scraper_boturfers_extended.py::test_parse_race_metadata_conditions_from_text_snippet PASSED [ 66%]
tests/test_scraper_boturfers_extended.py::test_parse_race_metadata_empty_metadata_logs_warning 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:14 [WARNING] Aucune métadonnée de course n'a pu être extraite de http://race.url.
PASSED                                                                   [ 66%]
tests/test_scraper_boturfers_extended.py::test_parse_race_runners_no_runners_table 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:14 [WARNING] Could not find runners table ('table.data') on the page.
PASSED                                                                   [ 66%]
tests/test_scraper_boturfers_extended.py::test_parse_race_runners_malformed_row PASSED [ 66%]
tests/test_scraper_boturfers_extended.py::test_fetcher_parse_race_runners_from_details_page_no_odds PASSED [ 66%]
tests/test_scraper_boturfers_extended.py::test_parse_race_runners_missing_musique_gains PASSED [ 66%]
tests/test_scraper_boturfers_extended.py::test_parse_race_row_runners_count_non_digit PASSED [ 66%]
tests/test_scraper_boturfers_extended.py::test_fetcher_parse_race_row_missing_url PASSED [ 66%]
tests/test_scraper_boturfers_extended.py::test_fetcher_parse_race_row_no_name_tag PASSED [ 66%]
tests/test_scraper_boturfers_extended.py::test_parse_race_row_missing_runners_count_tag PASSED [ 66%]
tests/test_scraper_boturfers_extended.py::test_parse_race_metadata_course_type_and_corde[type attel\xe9-Attel\xe9-N/A] PASSED [ 67%]
tests/test_scraper_boturfers_extended.py::test_parse_race_metadata_course_type_and_corde[type mont\xe9 corde \xe0 gauche-Mont\xe9-Gauche] PASSED [ 67%]
tests/test_scraper_boturfers_extended.py::test_parse_race_metadata_course_type_and_corde[type plat corde \xe0 droite-Plat-Droite] PASSED [ 67%]
tests/test_scraper_boturfers_extended.py::test_parse_race_metadata_course_type_and_corde[type obstacle-Obstacle-N/A] PASSED [ 67%]
tests/test_scraper_boturfers_extended.py::test_parse_race_metadata_course_type_and_corde[type inconnu-None-N/A] PASSED [ 67%]
tests/test_scraper_boturfers_extended.py::test_parse_race_runners_with_odds_place PASSED [ 67%]
tests/test_scraper_boturfers_extended.py::test_get_snapshot_fetch_html_fails PASSED [ 67%]
tests/test_scraper_boturfers_extended.py::test_get_snapshot_no_races_extracted 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:20 [ERROR] Aucune course n'a pu être extraite de http://programme.url.
PASSED                                                                   [ 67%]
tests/test_scraper_boturfers_extended.py::test_get_race_snapshot_fetch_html_fails PASSED [ 67%]
tests/test_scraper_boturfers_extended.py::test_get_race_snapshot_no_runners_extracted 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:20 [ERROR] Aucun partant n'a pu être extrait de http://race.url.
PASSED                                                                   [ 67%]
tests/test_scraper_boturfers_extended.py::test_fetch_boturfers_programme_fetcher_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:20 [INFO] Début du scraping du programme Boturfers.
2026-01-11 21:39:20 [ERROR] Le scraping du programme a échoué ou n'a retourné aucune course.
PASSED                                                                   [ 67%]
tests/test_scraper_boturfers_extended.py::test_fetch_boturfers_race_details_fetcher_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:20 [INFO] Début du scraping des détails de course.
2026-01-11 21:39:20 [ERROR] Le scraping des détails a échoué.
PASSED                                                                   [ 68%]
tests/test_scraper_boturfers_new_tests.py::test_parse_race_metadata_conditions_from_text_snippet PASSED [ 68%]
tests/test_scraper_boturfers_new_tests.py::test_parse_race_metadata_no_metadata_logs_warning 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:20 [WARNING] Aucune métadonnée de course n'a pu être extraite de http://example.com/race.
PASSED                                                                   [ 68%]
tests/test_scraper_boturfers_new_tests.py::test_fetch_boturfers_programme_empty_url_logs_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:20 [ERROR] Aucune URL fournie pour le scraping Boturfers.
PASSED                                                                   [ 68%]
tests/test_scraper_boturfers_new_tests.py::test_fetch_boturfers_programme_generic_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:20 [ERROR] Une erreur inattendue est survenue lors du scraping de http://example.com/programme: Mocked fetch error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scrapers/boturfers.py", line 364, in fetch_boturfers_programme
    raw_snapshot = await fetcher.get_snapshot()
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scrapers/boturfers.py", line 314, in get_snapshot
    if not await self._fetch_html():
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
Exception: Mocked fetch error
PASSED                                                                   [ 68%]
tests/test_scraper_boturfers_new_tests.py::test_fetch_boturfers_race_details_non_boturfers_url_no_partant 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:20 [INFO] Début du scraping des détails de course.
2026-01-11 21:39:20 [INFO] Scraping des détails réussi. 1 partants trouvés.
PASSED                                                                   [ 68%]
tests/test_scraper_boturfers_new_tests.py::test_fetch_boturfers_race_details_generic_exception 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:20 [ERROR] Une erreur inattendue est survenue lors du scraping des détails de http://example.com/race/details: Mocked fetch error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scrapers/boturfers.py", line 408, in fetch_boturfers_race_details
    raw_snapshot = await fetcher.get_race_snapshot()
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/scrapers/boturfers.py", line 331, in get_race_snapshot
    if not await self._fetch_html():
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
Exception: Mocked fetch error
PASSED                                                                   [ 68%]
tests/test_scraper_boturfers_robustness.py::test_parse_programme_handles_broken_reunion_class ERROR [ 68%]
tests/test_scraper_boturfers_robustness.py::test_parse_programme_handles_missing_race_table ERROR [ 68%]
tests/test_scraper_boturfers_robustness.py::test_parse_programme_from_static_fixture ERROR [ 68%]
tests/test_scraper_boturfers_robustness.py::test_parse_race_details_from_static_fixture ERROR [ 68%]
tests/test_scraper_boturfers_robustness.py::test_programme_fixture_has_expected_structure ERROR [ 68%]
tests/test_scraper_geny.py::test_slugify[Paris-Vincennes (FR)-paris-vincennes-fr] PASSED [ 69%]
tests/test_scraper_geny.py::test_slugify[Hippodrome de la C\xf4te d'Azur-hippodrome-de-la-cote-d-azur] PASSED [ 69%]
tests/test_scraper_geny.py::test_slugify[Saint-Cloud-saint-cloud] PASSED [ 69%]
tests/test_scraper_geny.py::test_slugify[123 Test-123-test] PASSED       [ 69%]
tests/test_scraper_geny.py::test_slugify[-] PASSED                       [ 69%]
tests/test_scraper_geny.py::test_slugify[   -] PASSED                    [ 69%]
tests/test_scraper_geny.py::test_slugify[  _!@# my string 123-my-string-123] PASSED [ 69%]
tests/test_scraper_geny.py::test_fetch_geny_programme_success ERROR      [ 69%]
tests/test_scraper_geny.py::test_fetch_geny_programme_no_races_container 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [WARNING] No 'next-races-container' found on Geny page.
PASSED                                                                   [ 69%]
tests/test_scraper_geny.py::test_fetch_geny_programme_empty_rows 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Discovered 0 meetings from Geny
PASSED                                                                   [ 69%]
tests/test_scraper_geny.py::test_fetch_geny_programme_malformed_row_elements 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [WARNING] Could not find meeting element 'th.race-name' in a row. Skipping row.
2026-01-11 21:39:21 [INFO] Discovered 0 meetings from Geny
PASSED                                                                   [ 69%]
tests/test_scraper_geny.py::test_fetch_geny_programme_httpx_request_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [ERROR] An error occurred while requesting 'http://mock.url': Mock request error
PASSED                                                                   [ 70%]
tests/test_scraper_geny.py::test_fetch_geny_programme_httpx_status_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [ERROR] Error response 404 while requesting 'http://mock.url': Not Found
PASSED                                                                   [ 70%]
tests/test_scraper_geny.py::test_fetch_geny_programme_id_course_from_href_fallback 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Discovered 1 meetings from Geny
PASSED                                                                   [ 70%]
tests/test_scraper_zeturf.py::test_fetch_race_snapshot_full_success 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] [ZEturf] phase=H30 url=https://www.zeturf.fr/fr/course/2025-11-20/R1C1-saint-galmier partants=12
PASSED                                                                   [ 70%]
tests/test_scraper_zeturf.py::test_phase_norm[H-30-H30] PASSED           [ 70%]
tests/test_scraper_zeturf.py::test_phase_norm[H30-H30] PASSED            [ 70%]
tests/test_scraper_zeturf.py::test_phase_norm[h05-H5] PASSED             [ 70%]
tests/test_scraper_zeturf.py::test_phase_norm[H5-H5] PASSED              [ 70%]
tests/test_scraper_zeturf.py::test_phase_norm[UNKNOWN-H30] PASSED        [ 70%]
tests/test_scraper_zeturf.py::test_phase_norm[-H30] PASSED               [ 70%]
tests/test_scraper_zeturf.py::test_phase_norm[None-H30] PASSED           [ 70%]
tests/test_scraper_zeturf.py::test_fetch_zeturf_race_details_success PASSED [ 70%]
tests/test_scraper_zeturf.py::test_fetch_zeturf_race_details_value_error_no_rc PASSED [ 71%]
tests/test_scraper_zeturf.py::test_fetch_zeturf_race_details_empty_snapshot PASSED [ 71%]
tests/test_scraper_zeturf.py::test_fetch_zeturf_race_details_missing_runners PASSED [ 71%]
tests/test_scraper_zeturf.py::test_fetch_zeturf_race_details_non_dict_snapshot PASSED [ 71%]
tests/test_scraper_zeturf.py::test_fetch_zeturf_race_details_h5_phase_input PASSED [ 71%]
tests/test_scraper_zeturf.py::test_fetch_zeturf_race_details_various_rc_formats PASSED [ 71%]
tests/test_service.py::test_get_pronostics_page 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/pronostics "HTTP/1.1 200 OK"
PASSED                                                                   [ 71%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_get_pronostics_data_empty_case 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://test/api/pronostics?date=2025-01-01 "HTTP/1.1 200 OK"
PASSED                                                                   [ 71%]
tests/test_service.py::test_get_pronostics_data_etag_304_not_modified 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] No processed races found for 2025-01-01 with a valid plan. Please trigger /tasks/bootstrap-day to start processing.
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://test/api/pronostics?date=2025-01-01 "HTTP/1.1 200 OK"
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] No processed races found for 2025-01-01 with a valid plan. Please trigger /tasks/bootstrap-day to start processing.
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://test/api/pronostics?date=2025-01-01 "HTTP/1.1 304 Not Modified"
PASSED                                                                   [ 71%]
tests/test_service.py::test_get_pronostics_data_with_data 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://test/api/pronostics?date=2025-01-01 "HTTP/1.1 200 OK"
PASSED                                                                   [ 71%]
tests/test_service.py::test_get_processing_status 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://test/ops/status?date=2025-01-01 "HTTP/1.1 200 OK"
PASSED                                                                   [ 71%]
tests/test_service.py::test_get_ops_status_reason_if_empty 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/ops/status?date=2025-01-01 "HTTP/1.1 200 OK"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_health_check 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_healthz_endpoint 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/healthz "HTTP/1.1 200 OK"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_legacy_redirects 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/pronostics/ui "HTTP/1.1 307 Temporary Redirect"
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/api/pronostics/ui "HTTP/1.1 307 Temporary Redirect"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_legacy_run_endpoint_with_course_url 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: POST http://testserver/run "HTTP/1.1 200 OK"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_legacy_run_endpoint_with_reunion_course 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Searching for R1C1 in daily plan
2026-01-11 21:39:21 [INFO] Found matching race in plan
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: POST http://testserver/run "HTTP/1.1 200 OK"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_legacy_run_endpoint_missing_params 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: POST http://testserver/run "HTTP/1.1 422 Unprocessable Entity"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_legacy_analyse_endpoint 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Searching for R1C1 in daily plan
2026-01-11 21:39:21 [INFO] Found matching race in plan
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: POST http://testserver/analyse "HTTP/1.1 200 OK"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_legacy_pipeline_run_endpoint 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Searching for R1C1 in daily plan
2026-01-11 21:39:21 [INFO] Found matching race in plan
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: POST http://testserver/pipeline/run "HTTP/1.1 200 OK"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_post_ops_run_success 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Manual run triggered for race R1C1 on 2026-01-11
2026-01-11 21:39:21 [INFO] Successfully processed and saved manual run for 2026-01-11_R1C1
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: POST http://testserver/ops/run?rc=R1C1 "HTTP/1.1 200 OK"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_run_single_race_missing_course_url 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Manual run triggered for race R1C1 on 2026-01-11
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: POST http://testserver/ops/run?rc=R1C1 "HTTP/1.1 400 Bad Request"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_schedule_day_races_success 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Received request to schedule day races. Force: True, Dry Run: True
2026-01-11 21:39:21 [INFO] Built plan with 1 races. Passing to scheduler with service_url: https://testserver
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: POST http://testserver/schedule "HTTP/1.1 200 OK"
PASSED                                                                   [ 72%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_schedule_day_races_empty_plan 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Received request to schedule day races. Force: False, Dry Run: False
2026-01-11 21:39:21 [WARNING] No races found in plan for 2025-01-01. Nothing to schedule.
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: POST http://testserver/schedule "HTTP/1.1 200 OK"
PASSED                                                                   [ 73%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_run_single_race_unhandled_exception 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Manual run triggered for race R1C1 on 2026-01-11
2026-01-11 21:39:21 [ERROR] Critical error during manual run for 2026-01-11_R1C1: Simulated pipeline error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/service.py", line 303, in run_single_race
    analysis_result = await analysis_pipeline.run_analysis_for_phase(
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
Exception: Simulated pipeline error
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: POST http://testserver/ops/run?rc=R1C1 "HTTP/1.1 500 Internal Server Error"
PASSED                                                                   [ 73%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_schedule_day_races_unhandled_exception 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [ERROR] UNHANDLED EXCEPTION in /schedule endpoint: Simulated unhandled error
TRACEBACK:
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/service.py", line 233, in schedule_day_races
    daily_plan = await plan.build_plan_async(plan_date)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
Exception: Simulated unhandled error

PASSED                                                                   [ 73%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_api_pronostics_schema_and_ui_markers 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://test/api/pronostics?date=2025-01-01 "HTTP/1.1 200 OK"
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/pronostics "HTTP/1.1 200 OK"
PASSED                                                                   [ 73%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_run_single_race_not_found 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Manual run triggered for race R1C1 on 2026-01-11
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: POST http://testserver/ops/run?rc=R1C1 "HTTP/1.1 404 Not Found"
PASSED                                                                   [ 73%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_get_daily_plan_success 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/api/plan?date=2025-01-01 "HTTP/1.1 200 OK"
PASSED                                                                   [ 73%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_debug_config_endpoint 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/debug/config "HTTP/1.1 200 OK"
PASSED                                                                   [ 73%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_get_pronostics_data_defaults_to_today 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/api/pronostics "HTTP/1.1 200 OK"
PASSED                                                                   [ 73%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_ui_contains_critical_elements_and_api_call 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/pronostics "HTTP/1.1 200 OK"
PASSED                                                                   [ 73%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_get_daily_plan_invalid_date_format 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/api/plan?date=not-a-date "HTTP/1.1 422 Unprocessable Entity"
PASSED                                                                   [ 73%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service.py::test_get_ops_status_invalid_date_format 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/ops/status?date=not-a-date "HTTP/1.1 422 Unprocessable Entity"
PASSED                                                                   [ 73%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service_extended.py::test_get_pronostics_data_invalid_date 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/api/pronostics?date=invalid-date "HTTP/1.1 422 Unprocessable Entity"
PASSED                                                                   [ 74%]
tests/test_service_extended.py::test_get_pronostics_data_plan_only 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] No processed races found for 2025-01-01 with a valid plan. Please trigger /tasks/bootstrap-day to start processing.
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/api/pronostics?date=2025-01-01 "HTTP/1.1 200 OK"
PASSED                                                                   [ 74%]
tests/test_service_smoke.py::test_ping_endpoint 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
PASSED                                                                   [ 74%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_service_smoke.py::test_pronostics_endpoint_returns_data 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:21 [INFO] Starting Hippique Orchestrator v1.0.0
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:21 [INFO] Request started
2026-01-11 21:39:21 [INFO] Request finished
2026-01-11 21:39:21 [INFO] HTTP Request: GET http://testserver/api/pronostics?date=2025-01-10 "HTTP/1.1 200 OK"
PASSED                                                                   [ 74%]
------------------------------ live log teardown -------------------------------
2026-01-11 21:39:21 [INFO] Shutting down Hippique Orchestrator.

tests/test_simulate_ev_module.py::test_implied_probs_normalizes PASSED   [ 74%]
tests/test_simulate_ev_module.py::test_normalize_overround_balances_dict PASSED [ 74%]
tests/test_simulate_ev_module.py::test_kelly_fraction_basic PASSED       [ 74%]
tests/test_simulate_ev_module.py::test_allocate_dutching_sp_cap PASSED   [ 74%]
tests/test_simulate_ev_module.py::test_allocate_dutching_sp_min_stake_filter PASSED [ 74%]
tests/test_simulate_ev_module.py::test_allocate_dutching_sp_skips_invalid PASSED [ 74%]
tests/test_simulate_ev_module.py::test_allocate_dutching_sp_uses_precomputed_implied_probs PASSED [ 74%]
tests/test_simulate_ev_module.py::test_allocate_dutching_sp_fallbacks_when_probabilities_invalid PASSED [ 75%]
tests/test_simulate_ev_module.py::test_gate_ev_thresholds PASSED         [ 75%]
tests/test_simulate_ev_module.py::test_gate_ev_sharpe_min PASSED         [ 75%]
tests/test_simulate_ev_module.py::test_simulate_ev_batch_uses_simulate_wrapper PASSED [ 75%]
tests/test_simulate_wrapper.py::test_calibration_details_expose_metadata PASSED [ 75%]
tests/test_simulate_wrapper.py::test_beta_binomial_fallback PASSED       [ 75%]
tests/test_simulate_wrapper.py::test_invalid_calibration PASSED          [ 75%]
tests/test_simulate_wrapper.py::test_combination_order PASSED            [ 75%]
tests/test_simulate_wrapper.py::test_cache_prevents_recomputation PASSED [ 75%]
tests/test_simulate_wrapper.py::test_cache_eviction PASSED               [ 75%]
tests/test_simulate_wrapper.py::test_fallback_uses_leg_probabilities PASSED [ 75%]
tests/test_simulate_wrapper.py::test_fallback_uses_implied_odds PASSED   [ 75%]
tests/test_simulate_wrapper.py::test_correlation_penalty_reduces_probability_and_ev PASSED [ 76%]
tests/test_snapshot_manager.py::test_write_snapshot_for_day_async_empty_plan 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:22 [WARNING] No race plan found for 2025-01-01. No snapshots will be created.
PASSED                                                                   [ 76%]
tests/test_snapshot_manager.py::test_write_snapshot_for_day_async_successful_run 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:22 [INFO] Starting daily snapshot job for 2025-01-01, phase H-5
2026-01-11 21:39:22 [INFO] Found 2 races for 2025-01-01. Creating 5 concurrent snapshots...
2026-01-11 21:39:22 [INFO] Finished creating 2 snapshot tasks for 2025-01-01.
PASSED                                                                   [ 76%]
tests/test_snapshot_manager.py::test_write_snapshot_for_day_async_incomplete_race_data 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:22 [WARNING] Skipping race with incomplete data: {'date': '2025-01-01', 'r_label': 'R2', 'c_label': 'C1'}
2026-01-11 21:39:22 [WARNING] Skipping race with incomplete data: {'course_url': 'url3', 'r_label': 'R3', 'c_label': 'C1'}
PASSED                                                                   [ 76%]
tests/test_snapshot_manager.py::test_write_snapshot_for_day_async_error_handling 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:22 [ERROR] Failed during daily snapshot job for 2025-01-01: Failed to build plan
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/snapshot_manager.py", line 52, in write_snapshot_for_day_async
    plan = await build_plan_async(date_str)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 2262, in _execute_mock_call
    raise effect
Exception: Failed to build plan
PASSED                                                                   [ 76%]
tests/test_snapshot_manager.py::test_write_snapshot_for_day_sync_wrapper PASSED [ 76%]
tests/test_stats_fetcher_extended.py::test_collect_stats_no_snapshot_metadata 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:22 [ERROR] Cannot collect stats, no snapshot found for race_id in phase H-5
PASSED                                                                   [ 76%]
tests/test_stats_fetcher_extended.py::test_collect_stats_no_runners_in_snapshot 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:22 [WARNING] No runners found in snapshot path/to/snapshot.json, cannot collect stats.
PASSED                                                                   [ 76%]
tests/test_stats_fetcher_extended.py::test_collect_stats_successful_run 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:22 [INFO] Starting stats collection for race_id
2026-01-11 21:39:22 [INFO] Fetching stats for runner Horse A (discipline: unknown)
2026-01-11 21:39:22 [INFO] Fetching stats for runner Horse B (discipline: unknown)
2026-01-11 21:39:22 [INFO] Successfully saved aggregated stats to <AsyncMock name='gcs_client.save_snapshot()' id='138886027679920'>
PASSED                                                                   [ 76%]
tests/test_stats_fetcher_extended.py::test_collect_stats_error_fetching_stats 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:22 [INFO] Starting stats collection for race_id
2026-01-11 21:39:22 [INFO] Fetching stats for runner Horse A (discipline: unknown)
PASSED                                                                   [ 76%]
tests/test_stats_fetcher_extended.py::test_collect_stats_runner_without_num_or_name 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:22 [WARNING] Skipping runner due to missing num or name: {'name': 'Horse A'}
2026-01-11 21:39:22 [WARNING] Skipping runner due to missing num or name: {'num': 2}
PASSED                                                                   [ 76%]
tests/test_stats_provider.py::TestZoneTurfProviderHelpers::test_slugify[Test Name-test-name] PASSED [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderHelpers::test_slugify[Un cheval avec accentu\xe9-un-cheval-avec-accentue] PASSED [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderHelpers::test_slugify[  leading & trailing spaces  -leading-trailing-spaces] PASSED [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderHelpers::test_slugify[!@#invalid-chars$%-invalid-chars] PASSED [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderHelpers::test_slugify[-] PASSED [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderHelpers::test_slugify[----] PASSED [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderHelpers::test_normalize_name[E. Raffin-eraffin] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderHelpers::test_normalize_name[J. DUBOIS-jdubois] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderHelpers::test_normalize_name[Jean-\xc9tienne Dubois-jeanetiennedubois] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderHelpers::test_normalize_name[Horse 123-horse123] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderHelpers::test_normalize_name[-] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_parse_chrono_to_seconds[1'11"6-71.6] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 77%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_parse_chrono_to_seconds[1'12''3-72.3] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 78%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_parse_chrono_to_seconds[1'10"-70.0] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 78%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_parse_chrono_to_seconds[59"8-59.8] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 78%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_parse_chrono_to_seconds[None-None] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 78%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_parse_chrono_to_seconds[-None] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 78%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_parse_chrono_to_seconds[invalid-None] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:22 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:22 [WARNING] Could not parse chrono string: invalid
PASSED                                                                   [ 78%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_horse_chrono_parsing 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 78%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_horse_chrono_parsing_incomplete 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 78%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_jockey_stats_parsing 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 78%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_methods_handle_http_error[fetch_horse_chrono] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:23 [ERROR] HTTP error while fetching chrono for 'Known Entity': Not Found
PASSED                                                                   [ 78%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_methods_handle_http_error[fetch_jockey_stats] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:23 [ERROR] HTTP error while fetching stats for jockey 'Known Entity': Not Found
PASSED                                                                   [ 78%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_methods_handle_http_error[fetch_trainer_stats] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:23 [ERROR] HTTP error while fetching stats for trainer 'Known Entity': Not Found
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_trainer_stats_parsing_edge_cases[\n                <html><body><h2>Statistiques 2025 de S. Mestries</h2>\n                <table>\n                    <tr><td>Partants</td><td> 0 </td></tr>\n                    <tr><td>Victoires</td><td> 0 </td></tr>\n                    <tr><td>Plac\xe9s</td><td> 0 </td></tr>\n                </table></body></html>\n                -expected_stats0] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_trainer_stats_parsing_edge_cases[<html><body><h2>Statistiques 2025 de S. Mestries</h2></body></html>-None] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:23 [WARNING] Stats table not found for trainer 'A Trainer' at /entraineur/a-trainer-54007/
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_trainer_stats_parsing_edge_cases[<html><body><table><tr><td>Partants</td><td> 10 </td></tr></table></body></html>-None] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:23 [WARNING] Stats section not found for trainer 'A Trainer' at /entraineur/a-trainer-54007/
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_methods_handle_id_resolution_failure[fetch_horse_chrono] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_methods_handle_id_resolution_failure[fetch_jockey_stats] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_methods_handle_id_resolution_failure[fetch_trainer_stats] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_jockey_stats_parsing_edge_cases[\n                <html><body><h2>Statistiques 2025 de E. Raffin</h2>\n                <table>\n                    <tr><td>Courses</td><td> 0 </td></tr>\n                    <tr><td>Victoires</td><td> 0 </td></tr>\n                    <tr><td>Plac\xe9s</td><td> 0 </td></tr>\n                </table></body></html>\n                -expected_stats0] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_jockey_stats_parsing_edge_cases[<html><body><h2>Statistiques 2025 de E. Raffin</h2></body></html>-None] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:23 [WARNING] Stats table not found for jockey 'A Jockey' at /jockey/a-jockey-2957/
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_jockey_stats_parsing_edge_cases[<html><body><table><tr><td>Courses</td><td> 10 </td></tr></table></body></html>-None] 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:23 [WARNING] Stats section not found for jockey 'A Jockey' at /jockey/a-jockey-2957/
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfProviderParsing::test_fetch_trainer_stats_parsing 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfIdResolution::test_get_id_from_cache_handles_exception 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:23 [ERROR] Failed to read from cache for horse_myhorse: Firestore unavailable
PASSED                                                                   [ 79%]
tests/test_stats_provider.py::TestZoneTurfIdResolution::test_set_id_to_cache_handles_exception 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:23 [ERROR] Failed to write to cache for horse_myhorse: Firestore unavailable
PASSED                                                                   [ 80%]
tests/test_stats_provider.py::TestZoneTurfIdResolution::test_get_id_from_cache_expired 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:23 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:23 [INFO] Cache expired for horse 'My Horse'.
PASSED                                                                   [ 80%]
tests/test_stats_provider.py::TestZoneTurfIdResolution::test_resolve_entity_id_empty_name 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 80%]
tests/test_stats_provider.py::TestZoneTurfIdResolution::test_resolve_entity_id_cache_hit 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 80%]
tests/test_stats_provider.py::TestZoneTurfIdResolution::test_resolve_entity_id_scraping 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
FAILED                                                                   [ 80%]
tests/test_stats_provider.py::TestZoneTurfIdResolution::test_resolve_entity_id_handles_http_error 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:24 [INFO] Cache miss for horse 'My Horse'. Resolving via scraping.
2026-01-11 21:39:24 [ERROR] HTTP error while resolving ID for 'My Horse' at page 1: Server Error
2026-01-11 21:39:24 [WARNING] Could not resolve ID for horse 'My Horse' after scraping.
PASSED                                                                   [ 80%]
tests/test_stats_provider.py::TestZoneTurfIdResolution::test_resolve_entity_id_handles_non_letter_name 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:24 [INFO] Cache miss for horse '1st Horse'. Resolving via scraping.
2026-01-11 21:39:24 [WARNING] Could not resolve ID for horse '1st Horse' after scraping.
PASSED                                                                   [ 80%]
tests/test_stats_provider.py::TestZoneTurfIdResolution::test_resolve_entity_id_not_found 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:24 [INFO] Cache miss for horse 'Unknown Horse'. Resolving via scraping.
2026-01-11 21:39:24 [WARNING] Could not resolve ID for horse 'Unknown Horse' after scraping.
PASSED                                                                   [ 80%]
tests/test_stats_provider.py::TestZoneTurfIdResolution::test_resolve_entity_id_pagination_limit 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:24 [INFO] Cache miss for horse 'My Horse'. Resolving via scraping.
2026-01-11 21:39:24 [WARNING] Could not resolve ID for horse 'My Horse' after scraping.
PASSED                                                                   [ 80%]
tests/test_stats_provider_extended.py::test_slugify PASSED               [ 80%]
tests/test_stats_provider_extended.py::test_normalize_name 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 80%]
tests/test_stats_provider_extended.py::test_fetch_horse_chrono_success 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_jockey_stats_success 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_trainer_stats_success 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_horse_chrono_network_error 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:24 [ERROR] An error occurred while fetching chrono for 'Test Horse': mock network error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/stats_provider.py", line 301, in fetch_horse_chrono
    response = self.client.get(url_path)
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
httpx.RequestError: mock network error
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_horse_chrono_http_status_error 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:24 [ERROR] HTTP error while fetching chrono for 'Test Horse': Not Found
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_horse_chrono_no_records_table 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_horse_chrono_no_performances_table 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_horse_chrono_no_data_returns_none 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:24 [WARNING] No chrono data found for horse 'Test Horse' at /cheval/test-horse-12345/
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_jockey_stats_network_error 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:24 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:24 [ERROR] An error occurred while fetching stats for jockey 'Test Jockey': mock network error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/stats_provider.py", line 368, in fetch_jockey_stats
    response = self.client.get(url_path)
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
httpx.RequestError: mock network error
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_jockey_stats_http_error 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:25 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:25 [ERROR] HTTP error while fetching stats for jockey 'Test Jockey': Server Error
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_jockey_stats_no_header 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:25 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:25 [WARNING] Stats section not found for jockey 'Test Jockey' at /jockey/test-jockey-123/
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_jockey_stats_no_table 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:25 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:25 [WARNING] Stats table not found for jockey 'Test Jockey' at /jockey/test-jockey-123/
PASSED                                                                   [ 81%]
tests/test_stats_provider_extended.py::test_fetch_trainer_stats_network_error 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:25 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:25 [ERROR] An error occurred while fetching stats for trainer 'Test Trainer': mock network error
Traceback (most recent call last):
  File "/home/francoisosmozis/hippique-orchestrator/hippique_orchestrator/stats_provider.py", line 433, in fetch_trainer_stats
    response = self.client.get(url_path)
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1134, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1138, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/unittest/mock.py", line 1193, in _execute_mock_call
    raise effect
httpx.RequestError: mock network error
PASSED                                                                   [ 82%]
tests/test_stats_provider_extended.py::test_fetch_trainer_stats_http_error 
-------------------------------- live log setup --------------------------------
2026-01-11 21:39:25 [INFO] ZoneTurfProvider initialized.
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:25 [ERROR] HTTP error while fetching stats for trainer 'Test Trainer': Server Error
PASSED                                                                   [ 82%]
tests/test_tickets_store.py::test_client_returns_storage_client PASSED   [ 82%]
tests/test_tickets_store.py::test_blob_path_constructs_correct_path PASSED [ 82%]
tests/test_tickets_store.py::test_index_path_constructs_correct_path PASSED [ 82%]
tests/test_tickets_store.py::test_render_ticket_html_full_payload PASSED [ 82%]
tests/test_tickets_store.py::test_render_ticket_html_minimal_payload PASSED [ 82%]
tests/test_tickets_store.py::test_render_ticket_html_different_keys_for_ev_roi_tickets PASSED [ 82%]
tests/test_tickets_store.py::test_save_ticket_html_success PASSED        [ 82%]
tests/test_tickets_store.py::test_save_ticket_html_no_bucket_env_var_raises_error PASSED [ 82%]
tests/test_tickets_store.py::test_build_and_save_ticket_success PASSED   [ 82%]
tests/test_tickets_store.py::test_list_ticket_objects_success PASSED     [ 83%]
tests/test_tickets_store.py::test_list_ticket_objects_empty_list PASSED  [ 83%]
tests/test_tickets_store.py::test_list_ticket_objects_no_bucket_env_var_raises_error PASSED [ 83%]
tests/test_tickets_store.py::test_rebuild_index_success PASSED           [ 83%]
tests/test_tickets_store.py::test_rebuild_index_no_bucket_env_var_raises_error PASSED [ 83%]
tests/test_tickets_store.py::test_load_ticket_html_success PASSED        [ 83%]
tests/test_tickets_store.py::test_load_ticket_html_no_bucket_env_var_raises_error PASSED [ 83%]
tests/test_time_utils.py::test_get_tz PASSED                             [ 83%]
tests/test_time_utils.py::test_get_today_str PASSED                      [ 83%]
tests/test_time_utils.py::test_convert_local_to_utc_naive PASSED         [ 83%]
tests/test_time_utils.py::test_convert_local_to_utc_aware PASSED         [ 83%]
tests/test_time_utils.py::test_format_rfc3339 PASSED                     [ 84%]
tests/test_ui.py::test_read_main 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:25 [INFO] Request started
2026-01-11 21:39:25 [INFO] Request finished
2026-01-11 21:39:25 [INFO] HTTP Request: GET http://testserver/pronostics "HTTP/1.1 200 OK"
PASSED                                                                   [ 84%]
tests/test_update_excel_planning.py::test_cli_invalid_phase_raises_error PASSED [ 84%]
tests/test_update_excel_planning.py::test_extract_common_meta_aliases[nb_partants-10-partants-10] PASSED [ 84%]
tests/test_update_excel_planning.py::test_extract_common_meta_aliases[runners_count-11 partants-partants-11] PASSED [ 84%]
tests/test_update_excel_planning.py::test_extract_common_meta_aliases[start-10h30-start_time-10:30] PASSED [ 84%]
tests/test_update_excel_planning.py::test_extract_common_meta_aliases[heure_depart-11:00-start_time-11:00] PASSED [ 84%]
tests/test_update_excel_planning.py::test_extract_common_meta_aliases[specialite-Steeple-discipline-Steeple] PASSED [ 84%]
tests/test_update_excel_planning.py::test_extract_common_meta_aliases[r-R5-reunion-R5] PASSED [ 84%]
tests/test_update_excel_planning.py::test_extract_common_meta_aliases[c-C6-course-C6] PASSED [ 84%]
tests/test_update_excel_planning.py::test_summarise_tickets_formats[tickets0-] PASSED [ 84%]
tests/test_update_excel_planning.py::test_summarise_tickets_formats[tickets1-SG:1@4.5] PASSED [ 84%]
tests/test_update_excel_planning.py::test_summarise_tickets_formats[tickets2-JUM:2-4@12.1 | TRIO:5-6-7] PASSED [ 85%]
tests/test_update_excel_planning.py::test_summarise_tickets_formats[tickets3-WEIRD:8-9] PASSED [ 85%]
tests/test_update_excel_planning.py::test_summarise_tickets_formats[tickets4-2S4:10-11-12] PASSED [ 85%]
tests/test_update_excel_planning.py::test_h30_updates_existing_row PASSED [ 85%]
tests/test_update_excel_planning.py::test_h30_populates_planning_sheet PASSED [ 85%]
tests/test_update_excel_planning.py::test_h5_updates_status_and_tickets PASSED [ 85%]
tests/test_update_excel_planning.py::test_h5_abstention_uses_reason PASSED [ 85%]
tests/test_update_excel_planning.py::test_h5_preserves_existing_metadata_when_missing PASSED [ 85%]
tests/test_update_excel_planning.py::test_h5_converts_timezone_when_tz_env_set PASSED [ 85%]
tests/test_update_excel_planning.py::test_custom_status_h5_flag PASSED   [ 85%]
tests/test_update_excel_planning.py::test_custom_status_h30_and_h5 PASSED [ 85%]
tests/test_update_excel_planning.py::test_h30_preserves_existing_comment PASSED [ 86%]
tests/test_update_excel_planning.py::test_h30_handles_nested_course_payload PASSED [ 86%]
tests/test_update_excel_planning.py::test_h30_infers_rc_fields PASSED    [ 86%]
tests/test_update_excel_planning.py::test_h5_infers_rc_fields PASSED     [ 86%]
tests/test_update_excel_planning.py::test_h5_compact_ticket_summary PASSED [ 86%]
tests/test_update_excel_planning.py::test_format_time_respects_input_timezone PASSED [ 86%]
tests/test_update_excel_planning.py::test_format_time_uses_env_timezone PASSED [ 86%]
tests/test_update_excel_planning.py::test_format_time_handles_textual_hours[13h05-13:05] PASSED [ 86%]
tests/test_update_excel_planning.py::test_format_time_handles_textual_hours[7h-07:00] PASSED [ 86%]
tests/test_update_excel_planning.py::test_format_time_handles_textual_hours[09 heures 30-09:30] PASSED [ 86%]
tests/test_update_excel_planning.py::test_format_time_handles_textual_hours[18.45-18:45] PASSED [ 86%]
tests/test_update_excel_planning.py::test_cli_alias_and_dash_phase PASSED [ 86%]
tests/test_update_excel_with_results.py::test_update_excel_records_observed_roi PASSED [ 87%]
tests/test_validator_ev.py::test_validate_ev_passes_with_defaults 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:26 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 87%]
tests/test_validator_ev.py::test_validate_ev_sp_below_threshold 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:26 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 87%]
tests/test_validator_ev.py::test_validate_ev_combo_optional 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:26 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 87%]
tests/test_validator_ev.py::test_validate_ev_combo_required 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:26 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 87%]
tests/test_validator_ev.py::test_validate_ev_logs_context 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:26 [INFO] [validate_ev] context {'p_success': 0.45, 'payout_expected': 18.0, 'stake': 10.0, 'EV_ratio': 0.35}
PASSED                                                                   [ 87%]
tests/test_validator_ev.py::test_validate_ev_invalid_input_for_missing_probability 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:26 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': 25.0, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 87%]
tests/test_validator_ev.py::test_validate_ev_invalid_input_for_missing_payout 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:26 [INFO] [validate_ev] context {'p_success': 0.45, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 87%]
tests/test_validator_ev.py::test_validate_policy_pass PASSED             [ 87%]
tests/test_validator_ev.py::test_validate_policy_fail_ev PASSED          [ 87%]
tests/test_validator_ev.py::test_validate_policy_fail_roi PASSED         [ 87%]
tests/test_validator_ev.py::test_validate_combos_pass PASSED             [ 88%]
tests/test_validator_ev.py::test_validate_combos_fail_default PASSED     [ 88%]
tests/test_validator_ev.py::test_combos_allowed_thresholds PASSED        [ 88%]
tests/test_validator_ev.py::test_validate_inputs_ok PASSED               [ 88%]
tests/test_validator_ev.py::test_validate_inputs_partants_insuffisants PASSED [ 88%]
tests/test_validator_ev.py::test_validate_inputs_cote_none PASSED        [ 88%]
tests/test_validator_ev.py::test_validate_inputs_couverture PASSED       [ 88%]
tests/test_validator_ev.py::test_summarise_validation_success PASSED     [ 88%]
tests/test_validator_ev.py::test_summarise_validation_failure_returns_reason PASSED [ 88%]
tests/test_validator_ev.py::test_validator_cli_returns_non_zero_on_failure PASSED [ 88%]
tests/test_validator_ev_extended.py::test_validate_inputs_happy_path PASSED [ 88%]
tests/test_validator_ev_extended.py::test_validate_inputs_not_enough_partants PASSED [ 88%]
tests/test_validator_ev_extended.py::test_validate_inputs_missing_odds PASSED [ 89%]
tests/test_validator_ev_extended.py::test_validate_inputs_none_in_odds PASSED [ 89%]
tests/test_validator_ev_extended.py::test_validate_inputs_je_coverage_insufficient PASSED [ 89%]
tests/test_validator_ev_extended.py::test_validate_inputs_je_coverage_missing_but_allowed PASSED [ 89%]
tests/test_validator_ev_extended.py::test_validate_inconsistent_partants PASSED [ 89%]
tests/test_validator_ev_extended.py::test_validate_no_partants PASSED    [ 89%]
tests/test_validator_ev_extended.py::test_validate_missing_odds_h30 PASSED [ 89%]
tests/test_validator_ev_extended.py::test_validate_non_numeric_odds_h5 PASSED [ 89%]
tests/test_validator_ev_extended.py::test_validate_invalid_odds_h30 PASSED [ 89%]
tests/test_validator_ev_extended.py::test_validate_missing_je_stats_when_required PASSED [ 89%]
tests/test_validator_ev_extended.py::test_validate_happy_path PASSED     [ 89%]
tests/test_validator_ev_extended.py::test_validate_je_stats_not_required PASSED [ 90%]
tests/test_validator_ev_extended.py::test_validate_ev_sp_below_threshold 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:27 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 90%]
tests/test_validator_ev_extended.py::test_validate_ev_global_below_threshold 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:27 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 90%]
tests/test_validator_ev_extended.py::test_validate_ev_global_none_and_combo_needed 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:27 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 90%]
tests/test_validator_ev_extended.py::test_validate_ev_happy_path_with_combo 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:27 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 90%]
tests/test_validator_ev_extended.py::test_validate_ev_happy_path_no_combo 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:27 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 90%]
tests/test_validator_ev_extended.py::test_validate_ev_missing_p_success 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:27 [INFO] [validate_ev] context {'p_success': None, 'payout_expected': 10, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 90%]
tests/test_validator_ev_extended.py::test_validate_ev_missing_payout_expected 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:27 [INFO] [validate_ev] context {'p_success': 0.5, 'payout_expected': None, 'stake': None, 'EV_ratio': None}
PASSED                                                                   [ 90%]
tests/test_validator_ev_extended.py::test_validate_policy_ev_below_threshold PASSED [ 90%]
tests/test_validator_ev_extended.py::test_validate_policy_roi_below_threshold PASSED [ 90%]
tests/test_validator_ev_extended.py::test_validate_policy_happy_path PASSED [ 90%]
tests/test_validator_ev_extended.py::test_validate_budget_total_exceeded PASSED [ 90%]
tests/test_validator_ev_extended.py::test_validate_budget_per_horse_exceeded PASSED [ 91%]
tests/test_validator_ev_extended.py::test_validate_budget_happy_path PASSED [ 91%]
tests/test_validator_ev_extended.py::test_validate_combos_payout_below_threshold PASSED [ 91%]
tests/test_validator_ev_extended.py::test_validate_combos_happy_path PASSED [ 91%]
tests/test_validator_ev_extended.py::test_combos_allowed_ev_below_threshold PASSED [ 91%]
tests/test_validator_ev_extended.py::test_combos_allowed_payout_below_threshold PASSED [ 91%]
tests/test_validator_ev_extended.py::test_combos_allowed_invalid_inputs PASSED [ 91%]
tests/test_validator_ev_extended.py::test_combos_allowed_happy_path PASSED [ 91%]
tests/test_validator_ev_extended.py::test_cli_happy_path PASSED          [ 91%]
tests/test_validator_ev_extended.py::test_cli_file_not_found PASSED      [ 91%]
tests/test_validator_ev_extended.py::test_cli_validation_error PASSED    [ 91%]
tests/test_validator_ev_extended.py::test_cli_readme_roi_mismatch PASSED [ 92%]
tests/test_validator_ev_extended.py::test_cli_allow_je_na_flag PASSED    [ 92%]
tests/test_validator_ev_extended.py::test_load_cfg_no_config_file PASSED [ 92%]
tests/test_validator_ev_extended.py::test_load_cfg_invalid_yaml_returns_empty_dict 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:27 [WARNING] Invalid YAML in config/gpi.yml, returning empty config.
PASSED                                                                   [ 92%]
tests/test_validator_ev_extended.py::test_readme_has_roi_sp_no_readme PASSED [ 92%]
tests/test_validator_ev_extended.py::test_readme_has_roi_sp_no_match PASSED [ 92%]
tests/test_validator_ev_extended.py::test_readme_has_roi_sp_invalid_value PASSED [ 92%]
tests/test_validator_ev_extended.py::test_readme_has_roi_sp_below_target PASSED [ 92%]
tests/test_validator_ev_extended.py::test_readme_has_roi_sp_above_target PASSED [ 92%]
tests/test_validator_ev_extended.py::test_summarise_validation_all_pass PASSED [ 92%]
tests/test_validator_ev_extended.py::test_summarise_validation_first_fails PASSED [ 92%]
tests/test_validator_ev_extended.py::test_must_have_falsy_value_raises_runtime_error PASSED [ 93%]
tests/test_validator_ev_extended.py::test_must_have_truthy_value_returns_value PASSED [ 93%]
tests/test_validator_ev_extended.py::test_normalise_phase_invalid_phase_raises_value_error PASSED [ 93%]
tests/test_validator_ev_extended.py::test_normalise_phase_h5 PASSED      [ 93%]
tests/test_validator_ev_extended.py::test_normalise_phase_h30 PASSED     [ 93%]
tests/test_validator_ev_extended.py::test_normalise_phase_none_returns_h5 PASSED [ 93%]
tests/test_validator_ev_extended.py::test_load_json_payload_invalid_json_raises_json_decode_error PASSED [ 93%]
tests/test_validator_ev_extended.py::test_find_first_existing_none_found PASSED [ 93%]
tests/test_validator_ev_extended.py::test_find_first_existing_found PASSED [ 93%]
tests/test_validator_ev_extended.py::test_load_partants_invalid_list_format_returns_empty_list PASSED [ 93%]
tests/test_validator_ev_extended.py::test_load_partants_invalid_dict_format_raises_value_error PASSED [ 93%]
tests/test_validator_ev_extended.py::test_load_odds_empty_odds_map_raises_value_error PASSED [ 93%]
tests/test_validator_ev_extended.py::test_load_odds_from_dict_with_invalid_values PASSED [ 94%]
tests/test_validator_ev_extended.py::test_load_odds_from_list_with_invalid_values PASSED [ 94%]
tests/test_validator_ev_extended.py::test_load_config_non_existent_path PASSED [ 94%]
tests/test_validator_ev_extended.py::test_load_config_invalid_yaml 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:27 [WARNING] Invalid YAML in invalid.yml, returning empty config.
PASSED                                                                   [ 94%]
tests/test_validator_ev_extended.py::test_load_config_invalid_json 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:27 [WARNING] Invalid JSON in invalid.json, returning empty config.
PASSED                                                                   [ 94%]
tests/test_validator_ev_extended.py::test_load_config_valid_yaml PASSED  [ 94%]
tests/test_validator_ev_extended.py::test_load_config_valid_json PASSED  [ 94%]
tests/test_zoneturf_client.py::test_normalize_name[Jullou-jullou] PASSED [ 94%]
tests/test_zoneturf_client.py::test_normalize_name[  Jullou  -jullou] PASSED [ 94%]
tests/test_zoneturf_client.py::test_normalize_name[Jullou (FR)-jullou] PASSED [ 94%]
tests/test_zoneturf_client.py::test_normalize_name[Jullou-Nivard-jullou nivard] PASSED [ 94%]
tests/test_zoneturf_client.py::test_normalize_name[Jullou-Nivard (FR)-jullou nivard] PASSED [ 95%]
tests/test_zoneturf_client.py::test_normalize_name[\xc9curie Royale-ecurie royale] PASSED [ 95%]
tests/test_zoneturf_client.py::test_normalize_name[Jullou's Horse-jullous horse] PASSED [ 95%]
tests/test_zoneturf_client.py::test_normalize_name[-] PASSED             [ 95%]
tests/test_zoneturf_client.py::test_normalize_name[None-] PASSED         [ 95%]
tests/test_zoneturf_client.py::test_parse_rk_string[1'11"6-71.6] PASSED  [ 95%]
tests/test_zoneturf_client.py::test_parse_rk_string[1'15''3-75.3] PASSED [ 95%]
tests/test_zoneturf_client.py::test_parse_rk_string[1'20"0-80.0] PASSED  [ 95%]
tests/test_zoneturf_client.py::test_parse_rk_string[0'59"9-59.9] PASSED  [ 95%]
tests/test_zoneturf_client.py::test_parse_rk_string[None-None] PASSED    [ 95%]
tests/test_zoneturf_client.py::test_parse_rk_string[-None] PASSED        [ 95%]
tests/test_zoneturf_client.py::test_parse_rk_string[invalid-None] PASSED [ 95%]
tests/test_zoneturf_client.py::test_parse_rk_string[1'11-None] PASSED    [ 96%]
tests/test_zoneturf_client.py::test_resolve_horse_id_success ERROR       [ 96%]
tests/test_zoneturf_client.py::test_resolve_horse_id_not_found ERROR     [ 96%]
tests/test_zoneturf_client.py::test_resolve_horse_id_network_error 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:27 [INFO] Resolving Zone-Turf ID for 'Jullou' via alphabetical pages...
2026-01-11 21:39:27 [WARNING] Failed to fetch page https://www.zone-turf.fr/cheval/lettre-j.html?p=1: Network issue
PASSED                                                                   [ 96%]
tests/test_zoneturf_client.py::test_resolve_horse_id_cache_hit PASSED    [ 96%]
tests/test_zoneturf_client.py::test_resolve_horse_id_no_alpha_in_name PASSED [ 96%]
tests/test_zoneturf_client.py::test_resolve_person_id_success ERROR      [ 96%]
tests/test_zoneturf_client.py::test_resolve_person_id_cache_hit PASSED   [ 96%]
tests/test_zoneturf_client.py::test_resolve_person_id_not_found ERROR    [ 96%]
tests/test_zoneturf_client.py::test_fetch_chrono_from_html_with_jullou_page ERROR [ 96%]
tests/test_zoneturf_client.py::test_fetch_chrono_from_html_no_chrono_data PASSED [ 96%]
tests/test_zoneturf_client.py::test_fetch_chrono_from_html_empty_content PASSED [ 97%]
tests/test_zoneturf_client.py::test_fetch_chrono_from_html_malformed_record PASSED [ 97%]
tests/test_zoneturf_client.py::test_fetch_chrono_from_html_malformed_table_chrono PASSED [ 97%]
tests/test_zoneturf_client.py::test_fetch_chrono_from_html_correctly_finds_jullou_chrono PASSED [ 97%]
tests/test_zoneturf_client.py::test_fetch_person_stats_from_html_success ERROR [ 97%]
tests/test_zoneturf_client.py::test_fetch_person_stats_from_html_no_stats_block PASSED [ 97%]
tests/test_zoneturf_client.py::test_fetch_person_stats_from_html_empty_content PASSED [ 97%]
tests/test_zoneturf_client.py::test_get_chrono_stats_success ERROR       [ 97%]
tests/test_zoneturf_client.py::test_get_chrono_stats_id_not_resolved 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:28 [WARNING] Could not get Zone-Turf ID for horse: Jullou
PASSED                                                                   [ 97%]
tests/test_zoneturf_client.py::test_get_chrono_stats_network_error_fetching_page 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:28 [WARNING] Failed to fetch Zone-Turf page for Jullou due to network error
PASSED                                                                   [ 97%]
tests/test_zoneturf_client.py::test_get_chrono_stats_page_fetch_failed 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:28 [WARNING] Failed to fetch Zone-Turf page for Jullou (ID: 1772764) with status 404
PASSED                                                                   [ 97%]
tests/test_zoneturf_client.py::test_get_chrono_stats_cache_hit PASSED    [ 97%]
tests/test_zoneturf_client.py::test_get_jockey_trainer_stats_success ERROR [ 98%]
tests/test_zoneturf_client.py::test_get_jockey_trainer_stats_id_not_resolved 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:28 [WARNING] Could not get Zone-Turf ID for jockey: Julien Dupont
PASSED                                                                   [ 98%]
tests/test_zoneturf_client.py::test_get_jockey_trainer_stats_cache_hit PASSED [ 98%]
tests/test_zoneturf_client.py::test_get_jockey_trainer_stats_network_error_fetching_page 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:28 [WARNING] Failed to fetch Zone-Turf page for jockey Julien Dupont due to network error
PASSED                                                                   [ 98%]
tests/test_zoneturf_client.py::test_get_jockey_trainer_stats_page_fetch_failed 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:28 [WARNING] Failed to fetch Zone-Turf page for jockey Julien Dupont (ID: 112233) with status 404
PASSED                                                                   [ 98%]
tests/test_zoneturf_client_extended.py::test_resolve_horse_id_non_200_status 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:28 [WARNING] Received non-200 status code 404 for URL: https://www.zone-turf.fr/cheval/lettre-t.html?p=1
PASSED                                                                   [ 98%]
tests/test_zoneturf_client_extended.py::test_resolve_horse_id_url_without_id 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:28 [INFO] Resolving Zone-Turf ID for 'Jullou' via alphabetical pages...
PASSED                                                                   [ 98%]
tests/test_zoneturf_client_extended.py::test_fetch_chrono_from_html_no_info_card PASSED [ 98%]
tests/test_zoneturf_client_extended.py::test_fetch_chrono_from_html_no_performance_card PASSED [ 98%]
tests/test_zoneturf_client_extended.py::test_fetch_chrono_from_html_no_record_tag PASSED [ 98%]
tests/test_zoneturf_client_extended.py::test_fetch_chrono_from_html_no_record_text PASSED [ 98%]
tests/test_zoneturf_client_extended.py::test_fetch_chrono_from_html_performance_no_list_group PASSED [ 99%]
tests/test_zoneturf_client_extended.py::test_fetch_chrono_from_html_performance_no_attelle_li PASSED [ 99%]
tests/test_zoneturf_client_extended.py::test_fetch_chrono_from_html_performance_no_red_km_header PASSED [ 99%]
tests/test_zoneturf_client_extended.py::test_fetch_chrono_from_html_performance_malformed_row PASSED [ 99%]
tests/test_zoneturf_client_extended.py::test_fetch_chrono_from_html_performance_other_horse_name PASSED [ 99%]
tests/test_zoneturf_client_extended.py::test_fetch_chrono_from_html_multiple_attelle_sections PASSED [ 99%]
tests/test_zoneturf_client_extended.py::test_resolve_person_id_non_200_status 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:28 [WARNING] Received non-200 status code 404 for URL: https://www.zone-turf.fr/jockey/lettre-t.html?p=1
PASSED                                                                   [ 99%]
tests/test_zoneturf_client_extended.py::test_resolve_person_id_url_without_id 
-------------------------------- live log call ---------------------------------
2026-01-11 21:39:28 [INFO] Resolving Zone-Turf ID for 'TestPerson' (jockey) via alphabetical pages...
PASSED                                                                   [ 99%]
tests/test_zoneturf_client_extended.py::test_fetch_person_stats_from_html_missing_rates PASSED [ 99%]
tests/test_zoneturf_client_extended.py::test_fetch_person_stats_from_html_missing_table PASSED [ 99%]
tests/test_zoneturf_client_extended.py::test_fetch_person_stats_from_html_malformed_table_data PASSED [ 99%]
tests/test_zoneturf_client_extended.py::test_fetch_person_stats_from_html_no_stat_paragraph PASSED [100%]/usr/lib/python3.12/ast.py:52: RuntimeWarning: coroutine 'write_snapshot_for_day_async' was never awaited
  return compile(source, filename, mode, flags,
RuntimeWarning: Enable tracemalloc to get the object allocation traceback


==================================== ERRORS ====================================
___________ ERROR at setup of test_fallback_parse_html_extracts_data ___________

    @pytest.fixture
    def zeturf_course_html():
        """Returns the content of the Zeturf course page fixture."""
        fixture_path = Path(__file__).parent.parent / "fixtures" / "zeturf_course_page.html"
>       return fixture_path.read_text(encoding="utf-8")

tests/scripts/test_online_fetch_zeturf.py:19: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/zeturf_course_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/zeturf_course_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
_________ ERROR at setup of test_fallback_parse_html_no_runners_table __________

    @pytest.fixture
    def zeturf_course_html():
        """Returns the content of the Zeturf course page fixture."""
        fixture_path = Path(__file__).parent.parent / "fixtures" / "zeturf_course_page.html"
>       return fixture_path.read_text(encoding="utf-8")

tests/scripts/test_online_fetch_zeturf_extended.py:14: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/zeturf_course_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/zeturf_course_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
________ ERROR at setup of test_fallback_parse_html_runner_missing_data ________

    @pytest.fixture
    def zeturf_course_html():
        """Returns the content of the Zeturf course page fixture."""
        fixture_path = Path(__file__).parent.parent / "fixtures" / "zeturf_course_page.html"
>       return fixture_path.read_text(encoding="utf-8")

tests/scripts/test_online_fetch_zeturf_extended.py:14: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/zeturf_course_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/zeturf_course_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
_____________ ERROR at setup of test_extract_links_from_horse_page _____________

    @pytest.fixture
    def horse_page_html():
        """Returns the content of the sample Geny horse page HTML file."""
        path = Path(__file__).parent / "fixtures" / "geny_horse_page.html"
>       return path.read_text(encoding="utf-8")

tests/test_fetch_je_stats.py:16: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_horse_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_horse_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
_______________ ERROR at setup of test_extract_rate_from_profile _______________

    @pytest.fixture
    def profile_page_html():
        """Returns the content of the sample Geny profile page HTML file."""
        path = Path(__file__).parent / "fixtures" / "geny_profile_page.html"
>       return path.read_text(encoding="utf-8")

tests/test_fetch_je_stats.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_profile_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_profile_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
______________ ERROR at setup of test_discover_horse_url_by_name _______________

    @pytest.fixture
    def search_page_html():
        """Returns the content of the sample Geny search page HTML file."""
        path = Path(__file__).parent / "fixtures" / "geny_search_page.html"
>       return path.read_text(encoding="utf-8")

tests/test_fetch_je_stats.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
____________ ERROR at setup of test_parse_horse_percentages_success ____________

    @pytest.fixture
    def search_page_html():
        """Returns the content of the sample Geny search page HTML file."""
        path = Path(__file__).parent / "fixtures" / "geny_search_page.html"
>       return path.read_text(encoding="utf-8")

tests/test_fetch_je_stats.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
______ ERROR at setup of test_collect_stats_edge_cases[h5_data0-0-0-None] ______

    @pytest.fixture
    def search_page_html():
        """Returns the content of the sample Geny search page HTML file."""
        path = Path(__file__).parent / "fixtures" / "geny_search_page.html"
>       return path.read_text(encoding="utf-8")

tests/test_fetch_je_stats.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
________ ERROR at setup of test_collect_stats_edge_cases[h5_data1-0-1-] ________

    @pytest.fixture
    def search_page_html():
        """Returns the content of the sample Geny search page HTML file."""
        path = Path(__file__).parent / "fixtures" / "geny_search_page.html"
>       return path.read_text(encoding="utf-8")

tests/test_fetch_je_stats.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
________ ERROR at setup of test_collect_stats_edge_cases[h5_data2-0-1-] ________

    @pytest.fixture
    def search_page_html():
        """Returns the content of the sample Geny search page HTML file."""
        path = Path(__file__).parent / "fixtures" / "geny_search_page.html"
>       return path.read_text(encoding="utf-8")

tests/test_fetch_je_stats.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
_______ ERROR at setup of test_collect_stats_edge_cases[h5_data3-100-1-] _______

    @pytest.fixture
    def search_page_html():
        """Returns the content of the sample Geny search page HTML file."""
        path = Path(__file__).parent / "fixtures" / "geny_search_page.html"
>       return path.read_text(encoding="utf-8")

tests/test_fetch_je_stats.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
____________ ERROR at setup of test_collect_stats_local_filesystem _____________

    @pytest.fixture
    def search_page_html():
        """Returns the content of the sample Geny search page HTML file."""
        path = Path(__file__).parent / "fixtures" / "geny_search_page.html"
>       return path.read_text(encoding="utf-8")

tests/test_fetch_je_stats.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
_______________ ERROR at setup of test_collect_stats_integration _______________

    @pytest.fixture
    def search_page_html():
        """Returns the content of the sample Geny search page HTML file."""
        path = Path(__file__).parent / "fixtures" / "geny_search_page.html"
>       return path.read_text(encoding="utf-8")

tests/test_fetch_je_stats.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/geny_search_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
____________ ERROR at setup of test_fetcher_parse_programme_success ____________

    @pytest.fixture
    def boturfers_programme_html():
        """Provides the HTML content of a nominal Boturfers programme page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_programme.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html').exists

tests/test_scraper_boturfers.py:19: AssertionError
________ ERROR at setup of test_fetcher_parse_programme_no_reunion_tabs ________

    @pytest.fixture
    def boturfers_programme_empty_html():
        """Provides HTML for an empty Boturfers programme page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_programme_empty.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_empty.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_empty.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_empty.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_empty.html').exists

tests/test_scraper_boturfers.py:27: AssertionError
____________ ERROR at setup of test_fetcher_parse_distance_success _____________

    @pytest.fixture
    def boturfers_race_details_html():
        """Provides the HTML content of a nominal Boturfers race details page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_race_details.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html').exists

tests/test_scraper_boturfers.py:35: AssertionError
__________ ERROR at setup of test_fetcher_parse_race_metadata_success __________

    @pytest.fixture
    def boturfers_race_details_html():
        """Provides the HTML content of a nominal Boturfers race details page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_race_details.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html').exists

tests/test_scraper_boturfers.py:35: AssertionError
_ ERROR at setup of test_fetcher_parse_race_runners_from_details_page_success __

    @pytest.fixture
    def boturfers_race_details_html():
        """Provides the HTML content of a nominal Boturfers race details page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_race_details.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html').exists

tests/test_scraper_boturfers.py:35: AssertionError
_ ERROR at setup of test_fetcher_parse_race_runners_from_details_page_malformed_row _

    @pytest.fixture
    def boturfers_race_details_malformed_html():
        """Provides malformed HTML for a Boturfers race details page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_race_details_malformed.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details_malformed.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details_malformed.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details_malformed.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details_malformed.html').exists

tests/test_scraper_boturfers.py:43: AssertionError
_____________ ERROR at setup of test_fetcher_get_snapshot_success ______________

    @pytest.fixture
    def boturfers_programme_html():
        """Provides the HTML content of a nominal Boturfers programme page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_programme.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html').exists

tests/test_scraper_boturfers.py:19: AssertionError
___________ ERROR at setup of test_fetcher_get_race_snapshot_success ___________

    @pytest.fixture
    def boturfers_race_details_html():
        """Provides the HTML content of a nominal Boturfers race details page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_race_details.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html').exists

tests/test_scraper_boturfers.py:35: AssertionError
___________ ERROR at setup of test_fetch_boturfers_programme_success ___________

    @pytest.fixture
    def boturfers_programme_html():
        """Provides the HTML content of a nominal Boturfers programme page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_programme.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme.html').exists

tests/test_scraper_boturfers.py:19: AssertionError
______ ERROR at setup of test_fetch_boturfers_programme_no_races_returned ______

    @pytest.fixture
    def boturfers_programme_empty_html():
        """Provides HTML for an empty Boturfers programme page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_programme_empty.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_empty.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_empty.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_empty.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_empty.html').exists

tests/test_scraper_boturfers.py:27: AssertionError
_________ ERROR at setup of test_fetch_boturfers_race_details_success __________

    @pytest.fixture
    def boturfers_race_details_html():
        """Provides the HTML content of a nominal Boturfers race details page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_race_details.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html').exists

tests/test_scraper_boturfers.py:35: AssertionError
____ ERROR at setup of test_fetcher_parse_race_metadata_missing_conditions _____

    @pytest.fixture
    def boturfers_race_details_html():
        """Provides the HTML content of a nominal Boturfers race details page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_race_details.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_race_details.html').exists

tests/test_scraper_boturfers.py:35: AssertionError
_____ ERROR at setup of test_parse_programme_handles_broken_reunion_class ______

    @pytest.fixture
    def boturfers_programme_broken_reunion_class_html():
        """Provides the HTML content of a broken Boturfers programme page."""
        fixture_path = (
            Path(__file__).parent / "fixtures" / "boturfers_programme_broken_reunion_class.html"
        )
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_broken_reunion_class.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_broken_reunion_class.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_broken_reunion_class.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_broken_reunion_class.html').exists

tests/test_scraper_boturfers_robustness.py:37: AssertionError
______ ERROR at setup of test_parse_programme_handles_missing_race_table _______

    @pytest.fixture
    def boturfers_programme_missing_table_html():
        """Provides the HTML content of a Boturfers programme page with a missing table."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_programme_missing_table.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_missing_table.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_missing_table.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_missing_table.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_missing_table.html').exists

tests/test_scraper_boturfers_robustness.py:45: AssertionError
__________ ERROR at setup of test_parse_programme_from_static_fixture __________

    @pytest.fixture
    def boturfers_programme_sample_html():
        """Provides the HTML content of a sample Boturfers programme page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_programme_sample.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_sample.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_sample.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_sample.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_sample.html').exists

tests/test_scraper_boturfers_robustness.py:19: AssertionError
________ ERROR at setup of test_parse_race_details_from_static_fixture _________

    @pytest.fixture
    def boturfers_racedetail_sample_html():
        """Provides the HTML content of a sample Boturfers race detail page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_racedetail_sample.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_racedetail_sample.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_racedetail_sample.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_racedetail_sample.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_racedetail_sample.html').exists

tests/test_scraper_boturfers_robustness.py:27: AssertionError
_______ ERROR at setup of test_programme_fixture_has_expected_structure ________

    @pytest.fixture
    def boturfers_programme_sample_html():
        """Provides the HTML content of a sample Boturfers programme page."""
        fixture_path = Path(__file__).parent / "fixtures" / "boturfers_programme_sample.html"
>       assert fixture_path.exists(), f"Fixture file not found: {fixture_path}"
E       AssertionError: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_sample.html
E       assert False
E        +  where False = <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_sample.html')>()
E        +    where <bound method Path.exists of PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_sample.html')> = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/boturfers_programme_sample.html').exists

tests/test_scraper_boturfers_robustness.py:19: AssertionError
_____________ ERROR at setup of test_fetch_geny_programme_success ______________

    @pytest.fixture
    def geny_programme_html_success():
>       with open("tests/fixtures/geny_programme.html") as f:
E       FileNotFoundError: [Errno 2] No such file or directory: 'tests/fixtures/geny_programme.html'

tests/test_scraper_geny.py:13: FileNotFoundError
_______________ ERROR at setup of test_resolve_horse_id_success ________________

    @pytest.fixture
    def horse_alpha_j_html() -> str:
        fixture_path = FIXTURE_DIR / 'zoneturf_horse_alpha_j.html'
        if not fixture_path.exists():
>           pytest.fail(f"Fixture file not found: {fixture_path}")
E           Failed: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/zoneturf_horse_alpha_j.html

tests/test_zoneturf_client.py:39: Failed
______________ ERROR at setup of test_resolve_horse_id_not_found _______________

    @pytest.fixture
    def horse_alpha_empty_html() -> str:
        fixture_path = FIXTURE_DIR / 'zoneturf_horse_alpha_empty.html'
        if not fixture_path.exists():
>           pytest.fail(f"Fixture file not found: {fixture_path}")
E           Failed: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/zoneturf_horse_alpha_empty.html

tests/test_zoneturf_client.py:47: Failed
_______________ ERROR at setup of test_resolve_person_id_success _______________

    @pytest.fixture
    def person_alpha_j_jockey_html() -> str:
        fixture_path = FIXTURE_DIR / 'zoneturf_person_alpha_j_jockey.html'
        if not fixture_path.exists():
>           pytest.fail(f"Fixture file not found: {fixture_path}")
E           Failed: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/zoneturf_person_alpha_j_jockey.html

tests/test_zoneturf_client.py:55: Failed
______________ ERROR at setup of test_resolve_person_id_not_found ______________

    @pytest.fixture
    def person_alpha_empty_html() -> str:
        fixture_path = FIXTURE_DIR / 'zoneturf_person_alpha_empty.html'
        if not fixture_path.exists():
>           pytest.fail(f"Fixture file not found: {fixture_path}")
E           Failed: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/zoneturf_person_alpha_empty.html

tests/test_zoneturf_client.py:63: Failed
________ ERROR at setup of test_fetch_chrono_from_html_with_jullou_page ________

    @pytest.fixture
    def jullou_html_content() -> str:
        """Provides the HTML content of the Jullou Zone-Turf page."""
        fixture_path = FIXTURE_DIR / 'zoneturf_jullou.html'
        if not fixture_path.exists():
>           pytest.fail(f"Fixture file not found: {fixture_path}")
E           Failed: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/zoneturf_jullou.html

tests/test_zoneturf_client.py:31: Failed
_________ ERROR at setup of test_fetch_person_stats_from_html_success __________

    @pytest.fixture
    def person_page_julien_html() -> str:
        fixture_path = FIXTURE_DIR / 'zoneturf_person_page_julien.html'
        if not fixture_path.exists():
>           pytest.fail(f"Fixture file not found: {fixture_path}")
E           Failed: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/zoneturf_person_page_julien.html

tests/test_zoneturf_client.py:71: Failed
_______________ ERROR at setup of test_get_chrono_stats_success ________________

    @pytest.fixture
    def jullou_html_content() -> str:
        """Provides the HTML content of the Jullou Zone-Turf page."""
        fixture_path = FIXTURE_DIR / 'zoneturf_jullou.html'
        if not fixture_path.exists():
>           pytest.fail(f"Fixture file not found: {fixture_path}")
E           Failed: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/zoneturf_jullou.html

tests/test_zoneturf_client.py:31: Failed
___________ ERROR at setup of test_get_jockey_trainer_stats_success ____________

    @pytest.fixture
    def person_page_julien_html() -> str:
        fixture_path = FIXTURE_DIR / 'zoneturf_person_page_julien.html'
        if not fixture_path.exists():
>           pytest.fail(f"Fixture file not found: {fixture_path}")
E           Failed: Fixture file not found: /home/francoisosmozis/hippique-orchestrator/tests/fixtures/zoneturf_person_page_julien.html

tests/test_zoneturf_client.py:71: Failed
=================================== FAILURES ===================================
______________________ test_drift_is_detected_and_applied ______________________

mocker = <pytest_mock.plugin.MockerFixture object at 0x7e50e77d4b00>

    @pytest.mark.asyncio
    async def test_drift_is_detected_and_applied(mocker):
        """
        Ensures that when an H-5 analysis is run, it finds the H-30 snapshot,
        loads it, and the final analysis shows a non-stable drift status.
        """
        # 1. Mock GCS client
        mock_gcs_client = mocker.patch("hippique_orchestrator.analysis_pipeline.gcs_client")
    
        # Mock file listing to find the H-30 snapshot
        mock_gcs_client.list_files.return_value = ["data/R1C1/snapshots/20250101_120000_H-30.json"]
    
        # Mock file reading to return different content based on path
        def mock_read_file(path):
            if "_H-30.json" in path:
                return json.dumps(H30_SNAPSHOT)
            if "gpi_v52.yml" in path:
                return GPI_CONFIG_YAML
            # For the H-5 snapshot itself and stats, return the H-5 data
            return json.dumps(H5_SNAPSHOT)
    
        mock_gcs_client.read_file_from_gcs.side_effect = mock_read_file
    
>       mocker.patch(
            "hippique_orchestrator.analysis_pipeline.source_registry.fetch_stats_for_runner",
            return_value={"mock_stats": "stats.json"},
        )

tests/test_analysis_drift.py:76: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/pytest_mock/plugin.py:440: in __call__
    return self._start_patch(
.venv/lib/python3.12/site-packages/pytest_mock/plugin.py:258: in _start_patch
    mocked: MockType = p.start()
/usr/lib/python3.12/unittest/mock.py:1606: in start
    result = self.__enter__()
/usr/lib/python3.12/unittest/mock.py:1458: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7e50e567f1d0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <hippique_orchestrator.source_registry.SourceRegistry object at 0x7e5101f1de20> does not have the attribute 'fetch_stats_for_runner'

/usr/lib/python3.12/unittest/mock.py:1431: AttributeError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163934.6232452, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163934.974947, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
__________________ test_api_pronostics_default_date_is_today ___________________

app = <fastapi.applications.FastAPI object at 0x7e50f00dfc50>
mock_firestore_client = <AsyncMock name='get_races_for_date' id='138885911786128'>
mock_build_plan = <AsyncMock name='build_plan_async' id='138885911780560'>

    @pytest.mark.asyncio
    @freeze_time("2025-07-15")
    async def test_api_pronostics_default_date_is_today(app, mock_firestore_client, mock_build_plan):
        """Tests that the API defaults to today's date when none is provided."""
        mock_firestore_client.return_value = []
        mock_build_plan.return_value = []
    
>       async with httpx.AsyncClient(app=app, base_url="http://test") as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/test_api_endpoints.py:109: TypeError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163935.5855331, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163936.9113712, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
__________________ test_api_pronostics_etag_304_not_modified ___________________

app = <fastapi.applications.FastAPI object at 0x7e50f00dfc50>
mock_firestore_client = <AsyncMock name='get_races_for_date' id='138885910595392'>
mock_build_plan = <AsyncMock name='build_plan_async' id='138885910603168'>

    @pytest.mark.asyncio
    async def test_api_pronostics_etag_304_not_modified(app, mock_firestore_client, mock_build_plan):
        """Tests that the API returns a 304 Not Modified when the ETag matches."""
        mock_firestore_client.return_value = []
        mock_build_plan.return_value = []
    
>       async with httpx.AsyncClient(app=app, base_url="http://test") as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/test_api_endpoints.py:134: TypeError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163937.147416, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163937.160976, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
_________________ test_api_pronostics_rich_response_structure __________________

app = <fastapi.applications.FastAPI object at 0x7e50f00dfc50>
mock_firestore_client = <AsyncMock name='get_races_for_date' id='138885909808384'>
mock_build_plan = <AsyncMock name='build_plan_async' id='138885909819952'>
mock_race_doc = <function mock_race_doc.<locals>._mock_race_doc at 0x7e50ec1c3f60>

    @pytest.mark.asyncio
    async def test_api_pronostics_rich_response_structure(
        app, mock_firestore_client, mock_build_plan, mock_race_doc
    ):
        """Tests the structure of the API response when data is present."""
        mock_firestore_client.return_value = [
            mock_race_doc("2025-01-01_R1C1", {"gpi_decision": "play"}),
            mock_race_doc("2025-01-01_R1C2", {"gpi_decision": "abstain"}),
        ]
        mock_build_plan.return_value = [
            {
                "date": "2025-01-01",
                "r_label": "R1",
                "c_label": "C1",
                "time_local": "13:50",
                "course_url": "http://example.com/r1c1",
            },
            {
                "date": "2025-01-01",
                "r_label": "R1",
                "c_label": "C2",
                "time_local": "14:20",
                "course_url": "http://example.com/r1c2",
            },
        ]
>       async with httpx.AsyncClient(app=app, base_url="http://test") as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/test_api_endpoints.py:169: TypeError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163937.1668549, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163937.1810892, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
_ test_fetch_race_details_routes_to_boturfers[https://www.boturfers.fr/c/2025-01-01/r1c1-hippique_orchestrator.data_source.source_registry.fetch_snapshot] _

race_url = 'https://www.boturfers.fr/c/2025-01-01/r1c1'
expected_scraper_path = 'hippique_orchestrator.data_source.source_registry.fetch_snapshot'

    @pytest.mark.asyncio
    @pytest.mark.parametrize(
        "race_url, expected_scraper_path",
        [
            (
                "https://www.boturfers.fr/c/2025-01-01/r1c1",
                "hippique_orchestrator.data_source.source_registry.fetch_snapshot",
            ),
            (
                "http://some-other-site.com/race",
                "hippique_orchestrator.data_source.source_registry.fetch_snapshot",
            ),
        ],
    )
    async def test_fetch_race_details_routes_to_boturfers(race_url, expected_scraper_path):
        """
        Ensures fetch_race_details routes non-Zeturf URLs to the boturfers scraper.
        """
>       with patch(expected_scraper_path, new_callable=AsyncMock) as mock_fetch:

tests/test_data_source.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/unittest/mock.py:1458: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7e50e55d7620>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <hippique_orchestrator.source_registry.SourceRegistry object at 0x7e5101f1de20> does not have the attribute 'fetch_snapshot'

/usr/lib/python3.12/unittest/mock.py:1431: AttributeError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163938.479881, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163938.7033165, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
_ test_fetch_race_details_routes_to_boturfers[http://some-other-site.com/race-hippique_orchestrator.data_source.source_registry.fetch_snapshot] _

race_url = 'http://some-other-site.com/race'
expected_scraper_path = 'hippique_orchestrator.data_source.source_registry.fetch_snapshot'

    @pytest.mark.asyncio
    @pytest.mark.parametrize(
        "race_url, expected_scraper_path",
        [
            (
                "https://www.boturfers.fr/c/2025-01-01/r1c1",
                "hippique_orchestrator.data_source.source_registry.fetch_snapshot",
            ),
            (
                "http://some-other-site.com/race",
                "hippique_orchestrator.data_source.source_registry.fetch_snapshot",
            ),
        ],
    )
    async def test_fetch_race_details_routes_to_boturfers(race_url, expected_scraper_path):
        """
        Ensures fetch_race_details routes non-Zeturf URLs to the boturfers scraper.
        """
>       with patch(expected_scraper_path, new_callable=AsyncMock) as mock_fetch:

tests/test_data_source.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/unittest/mock.py:1458: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7e50e55d6f60>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <hippique_orchestrator.source_registry.SourceRegistry object at 0x7e5101f1de20> does not have the attribute 'fetch_snapshot'

/usr/lib/python3.12/unittest/mock.py:1431: AttributeError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163938.7074416, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163938.899263, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
_ test_fetch_race_details_routes_to_zeturf[https://www.zeturf.fr/fr/course/2025-12-25/R1C2-test-hippique_orchestrator.data_source.source_registry.fetch_snapshot] _

race_url = 'https://www.zeturf.fr/fr/course/2025-12-25/R1C2-test'
expected_scraper_path = 'hippique_orchestrator.data_source.source_registry.fetch_snapshot'

    @pytest.mark.asyncio
    @pytest.mark.parametrize(
        "race_url, expected_scraper_path",
        [
            (
                "https://www.zeturf.fr/fr/course/2025-12-25/R1C2-test",
                "hippique_orchestrator.data_source.source_registry.fetch_snapshot",
            ),
            (
                "http://zeturf.com/R1C1",
                "hippique_orchestrator.data_source.source_registry.fetch_snapshot",
            ),
        ],
    )
    async def test_fetch_race_details_routes_to_zeturf(race_url, expected_scraper_path):
        """
        Ensures fetch_race_details routes ZEturf URLs to the zeturf scraper.
        """
>       with patch(expected_scraper_path, new_callable=AsyncMock) as mock_fetch:

tests/test_data_source.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/unittest/mock.py:1458: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7e50e55da6c0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <hippique_orchestrator.source_registry.SourceRegistry object at 0x7e5101f1de20> does not have the attribute 'fetch_snapshot'

/usr/lib/python3.12/unittest/mock.py:1431: AttributeError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163938.9034243, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163939.1001873, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
_ test_fetch_race_details_routes_to_zeturf[http://zeturf.com/R1C1-hippique_orchestrator.data_source.source_registry.fetch_snapshot] _

race_url = 'http://zeturf.com/R1C1'
expected_scraper_path = 'hippique_orchestrator.data_source.source_registry.fetch_snapshot'

    @pytest.mark.asyncio
    @pytest.mark.parametrize(
        "race_url, expected_scraper_path",
        [
            (
                "https://www.zeturf.fr/fr/course/2025-12-25/R1C2-test",
                "hippique_orchestrator.data_source.source_registry.fetch_snapshot",
            ),
            (
                "http://zeturf.com/R1C1",
                "hippique_orchestrator.data_source.source_registry.fetch_snapshot",
            ),
        ],
    )
    async def test_fetch_race_details_routes_to_zeturf(race_url, expected_scraper_path):
        """
        Ensures fetch_race_details routes ZEturf URLs to the zeturf scraper.
        """
>       with patch(expected_scraper_path, new_callable=AsyncMock) as mock_fetch:

tests/test_data_source.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/unittest/mock.py:1458: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7e50e5504a10>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <hippique_orchestrator.source_registry.SourceRegistry object at 0x7e5101f1de20> does not have the attribute 'fetch_snapshot'

/usr/lib/python3.12/unittest/mock.py:1431: AttributeError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163939.1043932, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163939.294263, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
_______________________ test_get_races_for_date_success ________________________

mock_db = <MagicMock id='138885947295168'>

    def test_get_races_for_date_success(mock_db):
        """Test `get_races_for_date` returns a list of document snapshots."""
    
        # Create mock documents
        doc1_mock = MagicMock(spec=DocumentSnapshot)
        doc2_mock = MagicMock(spec=DocumentSnapshot)
    
        mock_query = MagicMock()
        mock_query.stream.return_value = [doc1_mock, doc2_mock]
    
        mock_db.collection.return_value.order_by.return_value.start_at.return_value.end_at.return_value = mock_query
    
        date_str = "2025-12-30"
        results = firestore_client.get_races_for_date(date_str)
    
>       assert len(results) == 2
E       TypeError: object of type 'coroutine' has no len()

tests/test_firestore_client.py:85: TypeError
________________________ test_get_races_for_date_empty _________________________

mock_db = <MagicMock id='138885909798048'>

    def test_get_races_for_date_empty(mock_db):
        """Test `get_races_for_date` returns an empty list when no documents are found."""
    
        mock_query = MagicMock()
        mock_query.stream.return_value = []
    
        mock_db.collection.return_value.order_by.return_value.start_at.return_value.end_at.return_value = mock_query
    
        results = firestore_client.get_races_for_date("2025-12-30")
    
>       assert results == []
E       assert <coroutine object get_races_for_date at 0x7e50ec257e00> == []

tests/test_firestore_client.py:101: AssertionError
__________________ test_get_races_for_date_handles_exception ___________________

mock_db = <MagicMock id='138885910120352'>
caplog = <_pytest.logging.LogCaptureFixture object at 0x7e50e559aea0>

    def test_get_races_for_date_handles_exception(mock_db, caplog):
        """Test that exceptions during race query are logged and return an empty list."""
    
        mock_db.collection.side_effect = Exception("Query failed")
    
        results = firestore_client.get_races_for_date("2025-12-30")
    
>       assert "Failed to query races by date 2025-12-30" in caplog.text
E       AssertionError: assert 'Failed to query races by date 2025-12-30' in ''
E        +  where '' = <_pytest.logging.LogCaptureFixture object at 0x7e50e559aea0>.text

tests/test_firestore_client.py:111: AssertionError
______________ test_get_races_for_date_skips_if_db_not_available _______________

mock_warning = <MagicMock name='warning' id='138885947275984'>
mock_get_firestore_client = <MagicMock name='_get_firestore_client' id='138885947275408'>

    @patch("hippique_orchestrator.firestore_client._get_firestore_client", return_value=None)
    @patch("hippique_orchestrator.firestore_client.logger.warning")
    def test_get_races_for_date_skips_if_db_not_available(mock_warning, mock_get_firestore_client):
        """Test that `get_races_for_date` skips if the db client is None."""
    
        date_str = "2025-12-30"
        results = firestore_client.get_races_for_date(date_str)
>       assert results == []
E       assert <coroutine object get_races_for_date at 0x7e50ec5510e0> == []

tests/test_firestore_client.py:123: AssertionError
_________________ test_get_processing_status_for_date_success __________________

mock_db = <MagicMock id='138885910386336'>

    def test_get_processing_status_for_date_success(mock_db):
        """Test `get_processing_status_for_date` for a nominal case with processed data."""
    
        date_str = "2025-12-30"
        daily_plan = [
            {"rc": "R1C1", "time": "10:00"},
            {"rc": "R1C2", "time": "10:30"},
            {"rc": "R1C3", "time": "11:00"},
        ]
    
        # Mock Firestore documents
        mock_docs = [
            create_mock_doc(
                "2025-12-30_R1C1",
                "2025-12-30T10:05:00+00:00",
                {"tickets_analysis": {"gpi_decision": "play"}},
            ),
            create_mock_doc(
                "2025-12-30_R1C2",
                "2025-12-30T10:35:00+00:00",
                {"tickets_analysis": {"gpi_decision": "abstain"}},
            ),
        ]
        mock_query = MagicMock()
        mock_query.stream.return_value = mock_docs
        mock_db.collection.return_value.order_by.return_value.start_at.return_value.end_at.return_value = mock_query
    
        status = firestore_client.get_processing_status_for_date(date_str, daily_plan)
    
>       assert status["date"] == date_str
E       TypeError: 'coroutine' object is not subscriptable

tests/test_firestore_client.py:191: TypeError
_____________ test_get_processing_status_for_date_db_not_available _____________

caplog = <MagicMock name='_get_firestore_client' id='138885910121504'>

    @patch(FIRESTORE_CLIENT_PATH, return_value=None)
    def test_get_processing_status_for_date_db_not_available(caplog):
        """Test `get_processing_status_for_date` when Firestore client is None."""
        with caplog.at_level(logging.WARNING):
            status = firestore_client.get_processing_status_for_date("2025-12-30", [])
>       assert status["error"] == "Firestore client is not available."
E       TypeError: 'coroutine' object is not subscriptable

tests/test_firestore_client.py:210: TypeError
_____________ test_get_processing_status_for_date_empty_daily_plan _____________

mock_db = <MagicMock id='138885947424896'>

    def test_get_processing_status_for_date_empty_daily_plan(mock_db):
        """Test `get_processing_status_for_date` with an empty daily plan."""
    
        date_str = "2025-12-30"
        daily_plan = []
    
        mock_query = MagicMock()
        mock_query.stream.return_value = []  # No races in DB
        mock_db.collection.return_value.order_by.return_value.start_at.return_value.end_at.return_value = mock_query
    
        status = firestore_client.get_processing_status_for_date(date_str, daily_plan)
>       assert status["counts"]["total_in_plan"] == 0
E       TypeError: 'coroutine' object is not subscriptable

tests/test_firestore_client.py:225: TypeError
________ test_get_processing_status_for_date_explicit_empty_plan_reason ________

mock_db = <MagicMock id='138885910025648'>

    def test_get_processing_status_for_date_explicit_empty_plan_reason(mock_db):
        """Test `get_processing_status_for_date` explicitly covers the empty plan reason."""
    
        date_str = "2025-01-01"
        daily_plan = []
    
        mock_query = MagicMock()
        mock_query.stream.return_value = []
        mock_db.collection.return_value.order_by.return_value.start_at.return_value.end_at.return_value = mock_query
    
        status = firestore_client.get_processing_status_for_date(date_str, daily_plan)
>       assert status["reason_if_empty"] == "PLAN_SCRAPING_FAILED_OR_NO_RACES_TODAY"
E       TypeError: 'coroutine' object is not subscriptable

tests/test_firestore_client.py:241: TypeError
____________ test_get_processing_status_for_date_unprocessed_races _____________

mock_db = <MagicMock id='138885947430464'>

    def test_get_processing_status_for_date_unprocessed_races(mock_db):
        """Test `get_processing_status_for_date` when daily plan has races but none are processed."""
    
        date_str = "2025-12-30"
        daily_plan = [
            {"rc": "R1C1", "time": "10:00"},
            {"rc": "R1C2", "time": "10:30"},
        ]
    
        mock_query = MagicMock()
        mock_query.stream.return_value = []  # No races in DB
        mock_db.collection.return_value.order_by.return_value.start_at.return_value.end_at.return_value = mock_query
    
        status = firestore_client.get_processing_status_for_date(date_str, daily_plan)
>       assert status["counts"]["total_in_plan"] == 2
E       TypeError: 'coroutine' object is not subscriptable

tests/test_firestore_client.py:258: TypeError
______________ test_get_processing_status_for_date_error_decision ______________

mock_db = <MagicMock id='138885909812176'>

    def test_get_processing_status_for_date_error_decision(mock_db):
        """Test `get_processing_status_for_date` correctly counts error decisions."""
    
        date_str = "2025-12-30"
        daily_plan = [{"rc": "R1C1", "time": "10:00"}]
        mock_docs = [
            create_mock_doc(
                "2025-12-30_R1C1",
                "2025-12-30T10:05:00+00:00",
                {"tickets_analysis": {"gpi_decision": "error"}},
            ),
        ]
        mock_query = MagicMock()
        mock_query.stream.return_value = mock_docs
        mock_db.collection.return_value.order_by.return_value.start_at.return_value.end_at.return_value = mock_query
    
        status = firestore_client.get_processing_status_for_date(date_str, daily_plan)
>       assert status["counts"]["total_error"] == 1
E       TypeError: 'coroutine' object is not subscriptable

tests/test_firestore_client.py:280: TypeError
_____________ test_get_processing_status_for_date_unknown_decision _____________

mock_db = <MagicMock id='138885910123328'>

    def test_get_processing_status_for_date_unknown_decision(mock_db):
        """Test `get_processing_status_for_date` correctly handles unknown decisions (not counted in specific buckets)."""
    
        date_str = "2025-12-30"
        daily_plan = [{"rc": "R1C1", "time": "10:00"}]
        mock_docs = [
            create_mock_doc(
                "2025-12-30_R1C1",
                "2025-12-30T10:05:00+00:00",
                {"tickets_analysis": {"gpi_decision": "unknown_decision"}},
            ),
        ]
        mock_query = MagicMock()
        mock_query.stream.return_value = mock_docs
        mock_db.collection.return_value.order_by.return_value.start_at.return_value.end_at.return_value = mock_query
    
        status = firestore_client.get_processing_status_for_date(date_str, daily_plan)
>       assert status["counts"]["total_error"] == 0
E       TypeError: 'coroutine' object is not subscriptable

tests/test_firestore_client.py:302: TypeError
____________________ test_get_races_for_date_db_unavailable ____________________

mock_warning = <MagicMock name='warning' id='138885910595632'>
mock_get_firestore_client = <MagicMock name='_get_firestore_client' id='138886027253936'>

    @patch("hippique_orchestrator.firestore_client._get_firestore_client", return_value=None)
    @patch("hippique_orchestrator.firestore_client.logger.warning")
    def test_get_races_for_date_db_unavailable(mock_warning, mock_get_firestore_client):
        """Test get_races_for_date when the database is unavailable."""
    
        races = firestore_client.get_races_for_date("2025-12-30")
>       assert races == []
E       assert <coroutine object get_races_for_date at 0x7e50ec257cd0> == []

tests/test_firestore_client.py:381: AssertionError
____________ test_get_processing_status_for_date_processing_stalled ____________

    def test_get_processing_status_for_date_processing_stalled():
        """
        Covers the 'PROCESSING_STALLED' case in get_processing_status_for_date.
        This happens when there are no races for the given date, but there are races
        from other dates in the database.
        """
        # Arrange
        mock_db = MagicMock()
        mock_collection = MagicMock()
        mock_db.collection.return_value = mock_collection
    
        mock_latest_doc_query = MagicMock()
        mock_collection.order_by.return_value.limit.return_value = mock_latest_doc_query
    
        # Simulate a non-empty database, but with no races for the given date
        mock_doc = MagicMock(spec=firestore.DocumentSnapshot)
        mock_doc.id = "2025-01-01_R1C1"
        mock_doc.to_dict.return_value = {
            "gpi_decision": "PLAY",
            "last_modified_at": datetime(2025, 1, 1, 12, 0, 0, tzinfo=timezone.utc).isoformat(),
        }
        mock_doc.update_time = datetime(2025, 1, 1, 12, 0, 0, tzinfo=timezone.utc)
    
        mock_latest_doc_query.stream.return_value = [mock_doc]
    
        daily_plan = [
            {"rc_key": "R1C1", "race_url": "http://example.com/R1C1"},
            {"rc_key": "R1C2", "race_url": "http://example.com/R1C2"},
        ]
    
        # Act
        with (
            patch("hippique_orchestrator.firestore_client._get_firestore_client", return_value=mock_db),
            patch("hippique_orchestrator.firestore_client.get_races_for_date", return_value=[]),
        ):
            status = firestore_client.get_processing_status_for_date("2025-01-02", daily_plan)
    
        # Assert
>       assert status["reason_if_empty"] == "PROCESSING_STALLED"
E       TypeError: 'coroutine' object is not subscriptable

tests/test_firestore_client_extended.py:51: TypeError
_________________ test_get_processing_status_for_date_db_empty _________________

    def test_get_processing_status_for_date_db_empty():
        """
        Tests get_processing_status_for_date when the database is completely empty.
        """
        # Arrange
        mock_db = MagicMock()
        mock_collection = MagicMock()
        mock_db.collection.return_value = mock_collection
    
        mock_latest_doc_query = MagicMock()
        mock_collection.order_by.return_value.limit.return_value = mock_latest_doc_query
        mock_latest_doc_query.stream.return_value = []
    
        # a daily plan with races
        daily_plan = [
            {"rc_key": "R1C1", "race_url": "http://example.com/R1C1"},
        ]
    
        # Act
        with (
            patch("hippique_orchestrator.firestore_client._get_firestore_client", return_value=mock_db),
            patch("hippique_orchestrator.firestore_client.get_races_for_date", return_value=[]),
        ):
            status = firestore_client.get_processing_status_for_date("2025-01-01", daily_plan)
    
        # Assert
>       assert status["reason_if_empty"] == "NO_TASKS_PROCESSED_OR_FIRESTORE_EMPTY"
E       TypeError: 'coroutine' object is not subscriptable

tests/test_firestore_client_extended.py:83: TypeError
_____________________ test_gcs_manager_list_files_success ______________________

gcs_manager = <hippique_orchestrator.gcs_client.GCSManager object at 0x7e50e78d9c40>
mocker = <pytest_mock.plugin.MockerFixture object at 0x7e50e5514470>

    def test_gcs_manager_list_files_success(gcs_manager, mocker):
        mock_fs_ls = mocker.patch.object(gcs_manager.fs, "ls")
        mock_fs_ls.return_value = [
            {"name": "test-bucket/dir/file1.json", "type": "file"},
            {"name": "test-bucket/dir/subdir", "type": "directory"},
            {"name": "test-bucket/dir/file2.txt", "type": "file"},
        ]
        path = "dir/"
        expected_files = ["gs://test-bucket/test-bucket/dir/file1.json", "gs://test-bucket/test-bucket/dir/file2.txt"] # build_gcs_path gets applied to the name
    
        files = gcs_manager.list_files(path)
>       assert files == expected_files
E       AssertionError: assert ['gs://test-b...ir/file2.txt'] == ['gs://test-b...ir/file2.txt']
E         
E         At index 0 diff: 'gs://test-bucket/dir/file1.json' != 'gs://test-bucket/test-bucket/dir/file1.json'
E         
E         Full diff:
E           [
E         -     'gs://test-bucket/test-bucket/dir/file1.json',
E         ?          ------------...
E         
E         ...Full output truncated (5 lines hidden), use '-vv' to show

tests/test_gcs_client_extended.py:177: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163942.085236, "severity": "DEBUG", "name": "hippique_orchestrator.gcs_client", "message": "Attempting to get GCSManager. GCS_ENABLED: True, BUCKET_NAME: test-bucket", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    hippique_orchestrator.gcs_client:gcs_client.py:192 Attempting to get GCSManager. GCS_ENABLED: True, BUCKET_NAME: test-bucket
----------------------------- Captured stdout call -----------------------------
{"timestamp": 1768163942.0869222, "severity": "DEBUG", "name": "hippique_orchestrator.gcs_client", "message": "Listing files in GCS: gs://test-bucket/dir/", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log call -------------------------------
DEBUG    hippique_orchestrator.gcs_client:gcs_client.py:129 Listing files in GCS: gs://test-bucket/dir/
_________________________ test_build_plan_nominal_case _________________________

mock_fetch_programme = <AsyncMock name='fetch_programme' id='138885948225200'>

    @pytest.mark.asyncio
    @patch("hippique_orchestrator.plan.source_registry.fetch_programme", new_callable=AsyncMock)
    async def test_build_plan_nominal_case(mock_fetch_programme):
        """
        Tests the happy path: the scraper returns valid data, and the plan is built and sorted correctly.
        """
        # Arrange
        mock_fetch_programme.return_value = MOCK_PROGRAMME_DATA
        test_date = "2025-12-20"
    
        # Act
        result_plan = await plan.build_plan_async(test_date)
    
        # Assert
>       assert len(result_plan) == 2
E       assert 0 == 2
E        +  where 0 = len([])

tests/test_plan.py:59: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163943.2990215, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
----------------------------- Captured stdout call -----------------------------
{"timestamp": 1768163943.3013015, "severity": "INFO", "name": "hippique_orchestrator.plan", "message": "Building plan for 2025-12-20 using ProgrammeProvider.", "taskName": "Task-368", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.3018544, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: PmuProgrammeProvider", "taskName": "Task-368", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.3021762, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[PmuProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-368", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.4029405, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: GenyProgrammeProvider", "taskName": "Task-368", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.4037297, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[GenyProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-368", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.5048032, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: BoturfersProgrammeProvider", "taskName": "Task-368", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.505461, "severity": "DEBUG", "name": "hippique_orchestrator.programme_provider", "message": "BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.", "taskName": "Task-368", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.5057025, "severity": "WARNING", "name": "hippique_orchestrator.programme_provider", "message": "Aucun provider de programme n'a pu fournir de plan.", "taskName": "Task-368", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.5059822, "severity": "WARNING", "name": "hippique_orchestrator.plan", "message": "Failed to fetch programme for 2025-12-20 from any source.", "taskName": "Task-368", "correlation_id": null, "trace_id": null}
------------------------------ Captured log call -------------------------------
INFO     hippique_orchestrator.plan:plan.py:49 Building plan for 2025-12-20 using ProgrammeProvider.
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: PmuProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:63 [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: GenyProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:77 [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: BoturfersProgrammeProvider
DEBUG    hippique_orchestrator.programme_provider:programme_provider.py:46 BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.
WARNING  hippique_orchestrator.programme_provider:programme_provider.py:109 Aucun provider de programme n'a pu fournir de plan.
WARNING  hippique_orchestrator.plan:plan.py:55 Failed to fetch programme for 2025-12-20 from any source.
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163943.5202343, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
________________________ test_build_plan_scraper_fails _________________________

mock_fetch_programme = <AsyncMock name='fetch_programme' id='138885947196000'>
caplog = <_pytest.logging.LogCaptureFixture object at 0x7e50e78af620>

    @pytest.mark.asyncio
    @patch("hippique_orchestrator.plan.source_registry.fetch_programme", new_callable=AsyncMock)
    async def test_build_plan_scraper_fails(mock_fetch_programme, caplog):
        """
        Tests that an empty plan is returned if the scraper fails (returns None).
        """
        # Arrange
        mock_fetch_programme.return_value = None
    
        # Act
        result_plan = await plan.build_plan_async("2025-12-20")
    
        # Assert
        assert result_plan == []
>       assert "Failed to fetch programme or it was empty from SourceRegistry." in caplog.text
E       assert 'Failed to fetch programme or it was empty from SourceRegistry.' in "INFO     hippique_orchestrator.plan:plan.py:49 Building plan for 2025-12-20 using ProgrammeProvider.\nINFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: PmuProgrammeProvider\nINFO     hippique_orchestrator.programme_provider:programme_provider.py:63 [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).\nINFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: GenyProgrammeProvider\nINFO     hippique_orchestrator.programme_provider:programme_provider.py:77 [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).\nINFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: BoturfersProgrammeProvider\nDEBUG    hippique_orchestrator.programme_provider:programme_provider.py:46 BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.\nWARNING  hippique_orchestrator.programme_provider:programme_provider.py:109 Aucun provider de programme n'a pu fournir de plan.\nWARNING  hippique_orchestrator.plan:plan.py:55 Failed to fetch programme for 2025-12-20 from any source.\n"
E        +  where "INFO     hippique_orchestrator.plan:plan.py:49 Building plan for 2025-12-20 using ProgrammeProvider.\nINFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: PmuProgrammeProvider\nINFO     hippique_orchestrator.programme_provider:programme_provider.py:63 [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).\nINFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: GenyProgrammeProvider\nINFO     hippique_orchestrator.programme_provider:programme_provider.py:77 [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).\nINFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: BoturfersProgrammeProvider\nDEBUG    hippique_orchestrator.programme_provider:programme_provider.py:46 BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.\nWARNING  hippique_orchestrator.programme_provider:programme_provider.py:109 Aucun provider de programme n'a pu fournir de plan.\nWARNING  hippique_orchestrator.plan:plan.py:55 Failed to fetch programme for 2025-12-20 from any source.\n" = <_pytest.logging.LogCaptureFixture object at 0x7e50e78af620>.text

tests/test_plan.py:88: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163943.5259027, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
----------------------------- Captured stdout call -----------------------------
{"timestamp": 1768163943.5281591, "severity": "INFO", "name": "hippique_orchestrator.plan", "message": "Building plan for 2025-12-20 using ProgrammeProvider.", "taskName": "Task-369", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.5286882, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: PmuProgrammeProvider", "taskName": "Task-369", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.5290227, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[PmuProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-369", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.6297805, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: GenyProgrammeProvider", "taskName": "Task-369", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.6303983, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[GenyProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-369", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.7316105, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: BoturfersProgrammeProvider", "taskName": "Task-369", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.7326272, "severity": "DEBUG", "name": "hippique_orchestrator.programme_provider", "message": "BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.", "taskName": "Task-369", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.7329152, "severity": "WARNING", "name": "hippique_orchestrator.programme_provider", "message": "Aucun provider de programme n'a pu fournir de plan.", "taskName": "Task-369", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.733188, "severity": "WARNING", "name": "hippique_orchestrator.plan", "message": "Failed to fetch programme for 2025-12-20 from any source.", "taskName": "Task-369", "correlation_id": null, "trace_id": null}
------------------------------ Captured log call -------------------------------
INFO     hippique_orchestrator.plan:plan.py:49 Building plan for 2025-12-20 using ProgrammeProvider.
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: PmuProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:63 [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: GenyProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:77 [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: BoturfersProgrammeProvider
DEBUG    hippique_orchestrator.programme_provider:programme_provider.py:46 BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.
WARNING  hippique_orchestrator.programme_provider:programme_provider.py:109 Aucun provider de programme n'a pu fournir de plan.
WARNING  hippique_orchestrator.plan:plan.py:55 Failed to fetch programme for 2025-12-20 from any source.
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163943.7438977, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
____________________ test_build_plan_handles_malformed_data ____________________

mock_fetch_programme = <AsyncMock name='fetch_programme' id='138885951611456'>
caplog = <_pytest.logging.LogCaptureFixture object at 0x7e50e7cf7ce0>

    @pytest.mark.asyncio
    @patch("hippique_orchestrator.plan.source_registry.fetch_programme", new_callable=AsyncMock)
    async def test_build_plan_handles_malformed_data(mock_fetch_programme, caplog):
        """
        Tests that entries with malformed RC format or missing start_time are skipped.
        """
        # Arrange
        mock_fetch_programme.return_value = MOCK_MALFORMED_DATA
    
        # Act
        result_plan = await plan.build_plan_async("2025-12-20")
    
        # Assert
        # Only the one valid race should be in the plan
>       assert len(result_plan) == 1
E       assert 0 == 1
E        +  where 0 = len([])

tests/test_plan.py:105: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163943.7479312, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
----------------------------- Captured stdout call -----------------------------
{"timestamp": 1768163943.750049, "severity": "INFO", "name": "hippique_orchestrator.plan", "message": "Building plan for 2025-12-20 using ProgrammeProvider.", "taskName": "Task-370", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.7505577, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: PmuProgrammeProvider", "taskName": "Task-370", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.7508605, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[PmuProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-370", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.8515127, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: GenyProgrammeProvider", "taskName": "Task-370", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.8522506, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[GenyProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-370", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.9531353, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: BoturfersProgrammeProvider", "taskName": "Task-370", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.953996, "severity": "DEBUG", "name": "hippique_orchestrator.programme_provider", "message": "BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.", "taskName": "Task-370", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.9543478, "severity": "WARNING", "name": "hippique_orchestrator.programme_provider", "message": "Aucun provider de programme n'a pu fournir de plan.", "taskName": "Task-370", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163943.954818, "severity": "WARNING", "name": "hippique_orchestrator.plan", "message": "Failed to fetch programme for 2025-12-20 from any source.", "taskName": "Task-370", "correlation_id": null, "trace_id": null}
------------------------------ Captured log call -------------------------------
INFO     hippique_orchestrator.plan:plan.py:49 Building plan for 2025-12-20 using ProgrammeProvider.
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: PmuProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:63 [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: GenyProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:77 [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: BoturfersProgrammeProvider
DEBUG    hippique_orchestrator.programme_provider:programme_provider.py:46 BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.
WARNING  hippique_orchestrator.programme_provider:programme_provider.py:109 Aucun provider de programme n'a pu fournir de plan.
WARNING  hippique_orchestrator.plan:plan.py:55 Failed to fetch programme for 2025-12-20 from any source.
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163943.9675925, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
__________________ test_build_plan_partants_non_digit_string ___________________

mock_fetch_programme = <AsyncMock name='fetch_programme' id='138885951614096'>

    @pytest.mark.asyncio
    @patch("hippique_orchestrator.plan.source_registry.fetch_programme", new_callable=AsyncMock)
    async def test_build_plan_partants_non_digit_string(mock_fetch_programme):
        """
        Tests that `partants` is None when `runners_count` is a non-digit string.
        """
        # Arrange
        mock_programme_data = [
            {
                "rc": "R1 C1",
                "name": "Test Race",
                "start_time": "10:00",
                "url": "http://example.com/r1c1",
                "runners_count": "10 partants",  # Non-digit string
            }
        ]
        mock_fetch_programme.return_value = mock_programme_data
    
        # Act
        result_plan = await plan.build_plan_async("2025-12-20")
    
        # Assert
>       assert len(result_plan) == 1
E       assert 0 == 1
E        +  where 0 = len([])

tests/test_plan.py:165: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163944.3963966, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
----------------------------- Captured stdout call -----------------------------
{"timestamp": 1768163944.3985038, "severity": "INFO", "name": "hippique_orchestrator.plan", "message": "Building plan for 2025-12-20 using ProgrammeProvider.", "taskName": "Task-373", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.3989747, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: PmuProgrammeProvider", "taskName": "Task-373", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.3992488, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[PmuProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-373", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.4999316, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: GenyProgrammeProvider", "taskName": "Task-373", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.500487, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[GenyProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-373", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.6018212, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: BoturfersProgrammeProvider", "taskName": "Task-373", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.602389, "severity": "DEBUG", "name": "hippique_orchestrator.programme_provider", "message": "BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.", "taskName": "Task-373", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.6026032, "severity": "WARNING", "name": "hippique_orchestrator.programme_provider", "message": "Aucun provider de programme n'a pu fournir de plan.", "taskName": "Task-373", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.6029422, "severity": "WARNING", "name": "hippique_orchestrator.plan", "message": "Failed to fetch programme for 2025-12-20 from any source.", "taskName": "Task-373", "correlation_id": null, "trace_id": null}
------------------------------ Captured log call -------------------------------
INFO     hippique_orchestrator.plan:plan.py:49 Building plan for 2025-12-20 using ProgrammeProvider.
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: PmuProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:63 [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: GenyProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:77 [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: BoturfersProgrammeProvider
DEBUG    hippique_orchestrator.programme_provider:programme_provider.py:46 BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.
WARNING  hippique_orchestrator.programme_provider:programme_provider.py:109 Aucun provider de programme n'a pu fournir de plan.
WARNING  hippique_orchestrator.plan:plan.py:55 Failed to fetch programme for 2025-12-20 from any source.
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163944.6141198, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
__________________ test_build_plan_handles_compact_rc_format ___________________

mock_fetch_programme = <AsyncMock name='fetch_programme' id='138885950791968'>

    @pytest.mark.asyncio
    @patch("hippique_orchestrator.plan.source_registry.fetch_programme", new_callable=AsyncMock)
    async def test_build_plan_handles_compact_rc_format(mock_fetch_programme):
        """
        Tests that RC format without space (e.g., "R1C1") is correctly parsed.
        """
        # Arrange
        mock_fetch_programme.return_value = [
            {
                "rc": "R1C1",
                "name": "Compact RC",
                "start_time": "10:00",
                "url": "http://example.com/r1c1",
            }
        ]
    
        # Act
        result_plan = await plan.build_plan_async("2025-12-20")
    
        # Assert
>       assert len(result_plan) == 1
E       assert 0 == 1
E        +  where 0 = len([])

tests/test_plan.py:188: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163944.6181486, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
----------------------------- Captured stdout call -----------------------------
{"timestamp": 1768163944.6204205, "severity": "INFO", "name": "hippique_orchestrator.plan", "message": "Building plan for 2025-12-20 using ProgrammeProvider.", "taskName": "Task-374", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.620964, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: PmuProgrammeProvider", "taskName": "Task-374", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.6212778, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[PmuProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-374", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.7220333, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: GenyProgrammeProvider", "taskName": "Task-374", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.722846, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[GenyProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-374", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.8239124, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: BoturfersProgrammeProvider", "taskName": "Task-374", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.8245852, "severity": "DEBUG", "name": "hippique_orchestrator.programme_provider", "message": "BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.", "taskName": "Task-374", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.8249023, "severity": "WARNING", "name": "hippique_orchestrator.programme_provider", "message": "Aucun provider de programme n'a pu fournir de plan.", "taskName": "Task-374", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.8252294, "severity": "WARNING", "name": "hippique_orchestrator.plan", "message": "Failed to fetch programme for 2025-12-20 from any source.", "taskName": "Task-374", "correlation_id": null, "trace_id": null}
------------------------------ Captured log call -------------------------------
INFO     hippique_orchestrator.plan:plan.py:49 Building plan for 2025-12-20 using ProgrammeProvider.
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: PmuProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:63 [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: GenyProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:77 [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: BoturfersProgrammeProvider
DEBUG    hippique_orchestrator.programme_provider:programme_provider.py:46 BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.
WARNING  hippique_orchestrator.programme_provider:programme_provider.py:109 Aucun provider de programme n'a pu fournir de plan.
WARNING  hippique_orchestrator.plan:plan.py:55 Failed to fetch programme for 2025-12-20 from any source.
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163944.8368752, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
______________ test_build_plan_handles_various_invalid_rc_formats ______________

mock_fetch_programme = <AsyncMock name='fetch_programme' id='138885950955856'>
caplog = <_pytest.logging.LogCaptureFixture object at 0x7e50e7c54770>

    @pytest.mark.asyncio
    @patch("hippique_orchestrator.plan.source_registry.fetch_programme", new_callable=AsyncMock)
    async def test_build_plan_handles_various_invalid_rc_formats(mock_fetch_programme, caplog):
        """
        Tests that various invalid RC formats are skipped.
        """
        # Arrange
        mock_programme_data = [
            {
                "rc": "R C",
                "name": "Invalid RC 1",
                "start_time": "10:00",
                "url": "http://example.com/r1c1",
            },
            {
                "rc": "R1C",
                "name": "Invalid RC 2",
                "start_time": "11:00",
                "url": "http://example.com/r1c2",
            },
            {
                "rc": "RC1",
                "name": "Invalid RC 3",
                "start_time": "12:00",
                "url": "http://example.com/r1c3",
            },
            {
                "rc": "R1 C1",
                "name": "Valid RC",
                "start_time": "13:00",
                "url": "http://example.com/r1c4",
            },
        ]
        mock_fetch_programme.return_value = mock_programme_data
    
        # Act
        result_plan = await plan.build_plan_async("2025-12-20")
    
        # Assert
>       assert len(result_plan) == 1
E       assert 0 == 1
E        +  where 0 = len([])

tests/test_plan_extended.py:47: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163944.8692803, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
----------------------------- Captured stdout call -----------------------------
{"timestamp": 1768163944.8717437, "severity": "INFO", "name": "hippique_orchestrator.plan", "message": "Building plan for 2025-12-20 using ProgrammeProvider.", "taskName": "Task-378", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.8722801, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: PmuProgrammeProvider", "taskName": "Task-378", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.872561, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[PmuProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-378", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.9733326, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: GenyProgrammeProvider", "taskName": "Task-378", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163944.9739418, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[GenyProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-378", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.074782, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: BoturfersProgrammeProvider", "taskName": "Task-378", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.0754092, "severity": "DEBUG", "name": "hippique_orchestrator.programme_provider", "message": "BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.", "taskName": "Task-378", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.075621, "severity": "WARNING", "name": "hippique_orchestrator.programme_provider", "message": "Aucun provider de programme n'a pu fournir de plan.", "taskName": "Task-378", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.0759013, "severity": "WARNING", "name": "hippique_orchestrator.plan", "message": "Failed to fetch programme for 2025-12-20 from any source.", "taskName": "Task-378", "correlation_id": null, "trace_id": null}
------------------------------ Captured log call -------------------------------
INFO     hippique_orchestrator.plan:plan.py:49 Building plan for 2025-12-20 using ProgrammeProvider.
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: PmuProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:63 [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: GenyProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:77 [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: BoturfersProgrammeProvider
DEBUG    hippique_orchestrator.programme_provider:programme_provider.py:46 BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.
WARNING  hippique_orchestrator.programme_provider:programme_provider.py:109 Aucun provider de programme n'a pu fournir de plan.
WARNING  hippique_orchestrator.plan:plan.py:55 Failed to fetch programme for 2025-12-20 from any source.
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163945.085565, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
__________________________ test_build_plan_data_types __________________________

mock_fetch_programme = <AsyncMock name='fetch_programme' id='138885950955616'>

    @pytest.mark.asyncio
    @patch("hippique_orchestrator.plan.source_registry.fetch_programme", new_callable=AsyncMock)
    async def test_build_plan_data_types(mock_fetch_programme):
        """
        Tests that the data types in the returned plan are correct.
        """
        # Arrange
        mock_programme_data = [
            {
                "rc": "R1 C1",
                "name": "Test Race",
                "start_time": "10:00",
                "url": "http://example.com/r1c1",
                "runners_count": "10",  # runners_count is a string
            }
        ]
        mock_fetch_programme.return_value = mock_programme_data
    
        # Act
        result_plan = await plan.build_plan_async("2025-12-20")
    
        # Assert
>       assert len(result_plan) == 1
E       assert 0 == 1
E        +  where 0 = len([])

tests/test_plan_extended.py:76: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163945.0898108, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
----------------------------- Captured stdout call -----------------------------
{"timestamp": 1768163945.0921109, "severity": "INFO", "name": "hippique_orchestrator.plan", "message": "Building plan for 2025-12-20 using ProgrammeProvider.", "taskName": "Task-379", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.0926983, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: PmuProgrammeProvider", "taskName": "Task-379", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.093028, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[PmuProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-379", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.1937873, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: GenyProgrammeProvider", "taskName": "Task-379", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.1945786, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[GenyProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-379", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.2963574, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: BoturfersProgrammeProvider", "taskName": "Task-379", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.2970214, "severity": "DEBUG", "name": "hippique_orchestrator.programme_provider", "message": "BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.", "taskName": "Task-379", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.2972817, "severity": "WARNING", "name": "hippique_orchestrator.programme_provider", "message": "Aucun provider de programme n'a pu fournir de plan.", "taskName": "Task-379", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.2975667, "severity": "WARNING", "name": "hippique_orchestrator.plan", "message": "Failed to fetch programme for 2025-12-20 from any source.", "taskName": "Task-379", "correlation_id": null, "trace_id": null}
------------------------------ Captured log call -------------------------------
INFO     hippique_orchestrator.plan:plan.py:49 Building plan for 2025-12-20 using ProgrammeProvider.
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: PmuProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:63 [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: GenyProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:77 [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: BoturfersProgrammeProvider
DEBUG    hippique_orchestrator.programme_provider:programme_provider.py:46 BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.
WARNING  hippique_orchestrator.programme_provider:programme_provider.py:109 Aucun provider de programme n'a pu fournir de plan.
WARNING  hippique_orchestrator.plan:plan.py:55 Failed to fetch programme for 2025-12-20 from any source.
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163945.3064194, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
____________________ test_build_plan_invalid_runners_count _____________________

mock_fetch_programme = <AsyncMock name='fetch_programme' id='138885950945232'>

    @pytest.mark.asyncio
    @patch("hippique_orchestrator.plan.source_registry.fetch_programme", new_callable=AsyncMock)
    async def test_build_plan_invalid_runners_count(mock_fetch_programme):
        """
        Tests that `partants` is None when `runners_count` is not a valid integer.
        """
        # Arrange
        mock_programme_data = [
            {
                "rc": "R1 C1",
                "name": "Test Race",
                "start_time": "10:00",
                "url": "http://example.com/r1c1",
                "runners_count": "N/A",
            }
        ]
        mock_fetch_programme.return_value = mock_programme_data
    
        # Act
        result_plan = await plan.build_plan_async("2025-12-20")
    
        # Assert
>       assert len(result_plan) == 1
E       assert 0 == 1
E        +  where 0 = len([])

tests/test_plan_extended.py:109: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163945.3109636, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
----------------------------- Captured stdout call -----------------------------
{"timestamp": 1768163945.3133187, "severity": "INFO", "name": "hippique_orchestrator.plan", "message": "Building plan for 2025-12-20 using ProgrammeProvider.", "taskName": "Task-380", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.3138905, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: PmuProgrammeProvider", "taskName": "Task-380", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.314195, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[PmuProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-380", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.414928, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: GenyProgrammeProvider", "taskName": "Task-380", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.4155562, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[GenyProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-380", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.5164635, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: BoturfersProgrammeProvider", "taskName": "Task-380", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.5171592, "severity": "DEBUG", "name": "hippique_orchestrator.programme_provider", "message": "BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.", "taskName": "Task-380", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.5174096, "severity": "WARNING", "name": "hippique_orchestrator.programme_provider", "message": "Aucun provider de programme n'a pu fournir de plan.", "taskName": "Task-380", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.5177193, "severity": "WARNING", "name": "hippique_orchestrator.plan", "message": "Failed to fetch programme for 2025-12-20 from any source.", "taskName": "Task-380", "correlation_id": null, "trace_id": null}
------------------------------ Captured log call -------------------------------
INFO     hippique_orchestrator.plan:plan.py:49 Building plan for 2025-12-20 using ProgrammeProvider.
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: PmuProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:63 [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: GenyProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:77 [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: BoturfersProgrammeProvider
DEBUG    hippique_orchestrator.programme_provider:programme_provider.py:46 BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.
WARNING  hippique_orchestrator.programme_provider:programme_provider.py:109 Aucun provider de programme n'a pu fournir de plan.
WARNING  hippique_orchestrator.plan:plan.py:55 Failed to fetch programme for 2025-12-20 from any source.
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163945.527109, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
________________________ test_build_plan_mandatory_keys ________________________

mock_fetch_programme = <AsyncMock name='fetch_programme' id='138885950786736'>

    @pytest.mark.asyncio
    @patch("hippique_orchestrator.plan.source_registry.fetch_programme", new_callable=AsyncMock)
    async def test_build_plan_mandatory_keys(mock_fetch_programme):
        """
        Tests that all mandatory keys are present in the returned plan.
        """
        # Arrange
        mock_programme_data = [
            {
                "rc": "R1 C1",
                "name": "Test Race",
                "start_time": "10:00",
                "url": "http://example.com/r1c1",
                "runners_count": "10",
            }
        ]
        mock_fetch_programme.return_value = mock_programme_data
    
        # Act
        result_plan = await plan.build_plan_async("2025-12-20")
    
        # Assert
>       assert len(result_plan) == 1
E       assert 0 == 1
E        +  where 0 = len([])

tests/test_plan_extended.py:135: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163945.5332112, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
----------------------------- Captured stdout call -----------------------------
{"timestamp": 1768163945.5364337, "severity": "INFO", "name": "hippique_orchestrator.plan", "message": "Building plan for 2025-12-20 using ProgrammeProvider.", "taskName": "Task-381", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.5370326, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: PmuProgrammeProvider", "taskName": "Task-381", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.5373538, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[PmuProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-381", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.6380062, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: GenyProgrammeProvider", "taskName": "Task-381", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.6385543, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "[GenyProgrammeProvider] Tentative de r\u00e9cup\u00e9ration pour le 2025-12-20 (impl\u00e9mentation factice).", "taskName": "Task-381", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.7393558, "severity": "INFO", "name": "hippique_orchestrator.programme_provider", "message": "Tentative avec le provider de programme: BoturfersProgrammeProvider", "taskName": "Task-381", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.7399879, "severity": "DEBUG", "name": "hippique_orchestrator.programme_provider", "message": "BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.", "taskName": "Task-381", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.7402196, "severity": "WARNING", "name": "hippique_orchestrator.programme_provider", "message": "Aucun provider de programme n'a pu fournir de plan.", "taskName": "Task-381", "correlation_id": null, "trace_id": null}
{"timestamp": 1768163945.7404757, "severity": "WARNING", "name": "hippique_orchestrator.plan", "message": "Failed to fetch programme for 2025-12-20 from any source.", "taskName": "Task-381", "correlation_id": null, "trace_id": null}
------------------------------ Captured log call -------------------------------
INFO     hippique_orchestrator.plan:plan.py:49 Building plan for 2025-12-20 using ProgrammeProvider.
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: PmuProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:63 [PmuProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: GenyProgrammeProvider
INFO     hippique_orchestrator.programme_provider:programme_provider.py:77 [GenyProgrammeProvider] Tentative de récupération pour le 2025-12-20 (implémentation factice).
INFO     hippique_orchestrator.programme_provider:programme_provider.py:101 Tentative avec le provider de programme: BoturfersProgrammeProvider
DEBUG    hippique_orchestrator.programme_provider:programme_provider.py:46 BoturfersProgrammeProvider ne supporte pas la date 2025-12-20.
WARNING  hippique_orchestrator.programme_provider:programme_provider.py:109 Aucun provider de programme n'a pu fournir de plan.
WARNING  hippique_orchestrator.plan:plan.py:55 Failed to fetch programme for 2025-12-20 from any source.
--------------------------- Captured stdout teardown ---------------------------
{"timestamp": 1768163945.749185, "severity": "DEBUG", "name": "asyncio", "message": "Using selector: EpollSelector", "taskName": null, "correlation_id": null, "trace_id": null}
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
___________ TestZoneTurfIdResolution.test_resolve_entity_id_scraping ___________

self = <tests.test_stats_provider.TestZoneTurfIdResolution object at 0x7e50ed411400>
zt_provider = <hippique_orchestrator.stats_provider.ZoneTurfProvider object at 0x7e50ec5494f0>
mocker = <pytest_mock.plugin.MockerFixture object at 0x7e50dfef2d20>

    def test_resolve_entity_id_scraping(self, zt_provider: ZoneTurfProvider, mocker):
        """Tests the successful scraping of an ID from the index."""
        # 1. Setup mocks
        mocker.patch.object(zt_provider, '_get_id_from_cache', return_value=None)
        mock_set_to_cache = mocker.patch.object(zt_provider, '_set_id_to_cache')
    
        fixture_path = Path(__file__).parent / "fixtures" / "zoneturf_index_page.html"
>       mock_html = fixture_path.read_text(encoding="utf-8")

tests/test_stats_provider.py:432: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/pathlib.py:1029: in read_text
    with self.open(mode='r', encoding=encoding, errors=errors) as f:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = PosixPath('/home/francoisosmozis/hippique-orchestrator/tests/fixtures/zoneturf_index_page.html')
mode = 'r', buffering = -1, encoding = 'utf-8', errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
E       FileNotFoundError: [Errno 2] No such file or directory: '/home/francoisosmozis/hippique-orchestrator/tests/fixtures/zoneturf_index_page.html'

/usr/lib/python3.12/pathlib.py:1015: FileNotFoundError
---------------------------- Captured stdout setup -----------------------------
{"timestamp": 1768163964.117502, "severity": "INFO", "name": "hippique_orchestrator.stats_provider", "message": "ZoneTurfProvider initialized.", "taskName": null, "correlation_id": null, "trace_id": null}
------------------------------ Captured log setup ------------------------------
INFO     hippique_orchestrator.stats_provider:stats_provider.py:131 ZoneTurfProvider initialized.
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.3-final-0 ________________

Name                                                         Stmts   Miss Branch BrPart  Cover   Missing
--------------------------------------------------------------------------------------------------------
hippique_orchestrator/__init__.py                                1      0      0      0   100%
hippique_orchestrator/analysis_pipeline.py                     107     49     18      3    54%   51, 66-108, 113-119, 131-146, 186-200, 229-255
hippique_orchestrator/analysis_utils.py                        195     16     90     11    88%   64-65, 71-72, 79, 83-89, 122->124, 126-127, 128->131, 243->271, 248->254, 266, 334->342, 361, 391
hippique_orchestrator/api/__init__.py                            1      0      0      0   100%
hippique_orchestrator/api/tasks.py                              62      1      4      1    97%   55
hippique_orchestrator/auth.py                                   28      3      8      1    89%   31, 64-65
hippique_orchestrator/config.py                                 21      0      0      0   100%
hippique_orchestrator/data_contract.py                          49      0      6      0   100%
hippique_orchestrator/data_source.py                            12      2      0      0    83%   46-51
hippique_orchestrator/ev_calculator.py                         522     36    208     13    91%   164->171, 171->161, 291, 340, 417, 479, 498-499, 540->543, 643-687, 731, 897, 923, 957-962
hippique_orchestrator/fetch_je_stats.py                        265    143     66      4    43%   56-69, 73, 86-93, 122-140, 144-163, 181->183, 191-192, 197, 203-206, 223-237, 255-381, 422
hippique_orchestrator/firestore_client.py                      130     68     44      1    43%   26-29, 35-42, 106-147, 163-248
hippique_orchestrator/gcs_client.py                            159     22     44     10    84%   35-40, 53, 54->56, 67, 105, 111-113, 126, 150, 171-172, 205-207, 221, 257, 289-291
hippique_orchestrator/gcs_utils.py                              52      0     10      0   100%
hippique_orchestrator/kelly.py                                  42      6     18      4    83%   12, 14-15, 48, 59, 61
hippique_orchestrator/logging_io.py                             39     13     10      1    63%   36-56
hippique_orchestrator/logging_middleware.py                     22      4      0      0    82%   50-61
hippique_orchestrator/logging_utils.py                          32      1      6      3    89%   18->20, 20->exit, 32->35, 60
hippique_orchestrator/overround.py                              25      0     10      0   100%
hippique_orchestrator/p_finale.py                               41      0     22      0   100%
hippique_orchestrator/pipeline_run.py                          354     19    142     14    92%   100, 171-172, 240, 242, 315-337, 367->369, 379->385, 437->425, 460, 495->491, 500->504, 504->532, 596->583, 609->583, 681-682
hippique_orchestrator/plan.py                                   49     17     14      1    59%   44-46, 58-94
hippique_orchestrator/post_course_payload.py                   181      6     62     10    93%   85->84, 125-128, 245->247, 249->251, 252, 292->299, 294->296, 298, 301->305, 303->305
hippique_orchestrator/programme_provider.py                     59      7     12      3    86%   26, 43, 53, 104-107
hippique_orchestrator/runner.py                                 32      2      4      1    92%   30-31
hippique_orchestrator/scheduler.py                             107      1     32      1    99%   115
hippique_orchestrator/schemas.py                                35      0      0      0   100%
hippique_orchestrator/scrapers/__init__.py                       0      0      0      0   100%
hippique_orchestrator/scrapers/boturfers.py                    235     13     86     10    93%   137-142, 147, 175->173, 183, 195->197, 202, 232, 249, 304-308, 317->321, 335->339, 370-375
hippique_orchestrator/scrapers/geny.py                          61      1     14      4    93%   87, 92->98, 95->98, 98->107
hippique_orchestrator/scrapers/zeturf.py                        26      0      6      0   100%
hippique_orchestrator/scripts/__init__.py                        0      0      0      0   100%
hippique_orchestrator/scripts/backup_restore.py                202     10     48     10    92%   59, 67, 71, 170->173, 174->177, 178->121, 301-304, 313-314, 325, 343
hippique_orchestrator/scripts/concat_je_month.py               108      4     48      6    94%   70->69, 73->78, 79->78, 89-90, 110->112, 206, 212
hippique_orchestrator/scripts/cron_decider.py                   66      1     20      1    98%   133
hippique_orchestrator/scripts/drive_sync.py                      8      8      2      0     0%   7-20
hippique_orchestrator/scripts/enrich_requirements.py            49     49     20      0     0%   4-100
hippique_orchestrator/scripts/fetch_je_chrono.py                84     84     22      0     0%   3-189
hippique_orchestrator/scripts/fetch_je_stats.py                248    248     62      0     0%   3-404
hippique_orchestrator/scripts/gcs_utils.py                      14     14      8      0     0%   3-23
hippique_orchestrator/scripts/guardrails.py                     39      0     14      0   100%
hippique_orchestrator/scripts/lint_sources.py                   94     94     32      0     0%   3-190
hippique_orchestrator/scripts/merge_all_data.py                 21     21      2      0     0%   1-42
hippique_orchestrator/scripts/monitor_roi.py                   204     21     44      8    88%   43-44, 59, 67, 83, 305-308, 317-318, 329, 333-341, 347
hippique_orchestrator/scripts/online_fetch_zeturf.py          1049    373    576    112    60%   57-66, 87, 99-100, 104, 114, 120-121, 125->128, 154, 168-171, 173->163, 187, 221-232, 242, 261-273, 277->275, 282-283, 284->279, 287, 313, 333->335, 336, 338, 345-348, 355-356, 360, 372, 374, 391->394, 397->400, 412->421, 414->416, 416->421, 421->388, 444, 472-473, 477, 479, 483, 488, 501, 509, 518, 549->558, 554->558, 559-565, 582-583, 601->607, 613-626, 639-685, 707, 710, 714-721, 725-728, 745, 748, 778-806, 814-822, 832, 841, 864->860, 876, 879-885, 929->932, 947->952, 950->952, 953, 989->985, 1015-1022, 1027-1031, 1044->1051, 1046->1045, 1048->1045, 1051->1088, 1056-1060, 1063-1068, 1073-1074, 1076->1070, 1098-1102, 1105-1109, 1112-1116, 1118->1134, 1125->1132, 1135-1140, 1143, 1170, 1172-1175, 1187, 1189, 1196-1199, 1213-1236, 1245, 1250-1251, 1257, 1266->1262, 1272-1273, 1277-1279, 1282, 1288->1290, 1290->1292, 1293, 1305, 1311, 1335->1303, 1339-1374, 1385-1387, 1393->1420, 1398, 1406, 1418, 1421-1423, 1430, 1433, 1436, 1452, 1459->1463, 1461->1460, 1506->1508, 1508->1510, 1556->1559, 1568->1593, 1612-1615, 1620, 1623-1624, 1632, 1639-1640, 1647-1648, 1651->1660, 1658, 1696-1855, 1860, 1864
hippique_orchestrator/scripts/p_finale_export.py                80     30     30     10    56%   15-17, 28-38, 44, 49-50, 69-70, 80->87, 81->80, 84->80, 88-89, 97-100, 103-104, 110, 123-125
hippique_orchestrator/scripts/resolve_course_id.py             141     52     64     13    59%   41, 44, 47-48, 52, 60, 82->88, 84->88, 89-94, 106, 120-170, 178, 182, 204->209, 206->209, 210-213, 226-256
hippique_orchestrator/scripts/restore_from_drive.py             33     33     12      0     0%   3-56
hippique_orchestrator/scripts/simulate_ev.py                   221     57     98     13    72%   64, 76-77, 88-89, 102-103, 112-113, 122-123, 143, 162, 182, 186->188, 195, 225, 268-284, 297-326, 332->340, 336, 340->353, 348-349, 353->360, 357, 360->exit, 364
hippique_orchestrator/scripts/simulate_wrapper.py              468    128    238     52    67%   45-46, 105-107, 118, 126->129, 127->126, 149-155, 162-171, 184-189, 195-200, 229, 235, 246, 259, 266, 269-271, 282, 286-288, 290, 295-296, 311, 313->308, 329-332, 344, 352->354, 366->342, 380, 398, 400, 404, 422, 474, 477, 481-500, 504->508, 505->504, 537-538, 544, 546, 552, 558, 561, 564, 574, 577, 611-616, 631, 643-644, 664-670, 683, 692, 697-704, 741-745, 748-749, 756-757, 759-762, 787, 791-793, 796-797, 812-818
hippique_orchestrator/scripts/snapshot_enricher.py              16     16      2      0     0%   1-31
hippique_orchestrator/scripts/update_excel_planning.py         424     40    226     46    86%   46, 50, 84, 96->94, 110-111, 122, 125, 130-131, 148-154, 157->159, 166->163, 186, 195, 197, 203, 233->235, 237->239, 253->261, 258-259, 267->269, 271->262, 339, 343, 357, 378, 391, 396->395, 412, 415, 418, 423, 429, 437, 448, 462, 479->481, 481->483, 484->486, 491, 493->446, 551, 555, 558, 581, 610->609, 616, 682
hippique_orchestrator/scripts/update_excel_with_results.py     183     29     66     16    82%   120, 127, 156, 191, 195, 204, 247, 253->255, 287, 293, 309, 315-319, 322, 338, 352->358, 386->390, 395-426
hippique_orchestrator/service.py                               236     14     46      7    93%   147-148, 150-151, 153, 164->136, 262-263, 355->354, 360->354, 362, 389-397, 453, 486
hippique_orchestrator/simulate_ev.py                           221     58     98     19    71%   19-20, 22, 34-35, 37, 41, 64, 76-77, 88-89, 102-103, 112-113, 122-123, 143, 162, 182, 186->188, 190-191, 198, 270, 272, 281, 297-326, 332->340, 336, 340->353, 348-349, 353->360, 357, 360->exit, 364
hippique_orchestrator/simulate_wrapper.py                      474     79    236     47    79%   108, 120, 128->131, 129->128, 153-157, 165, 171, 188, 190, 199, 201, 248, 261, 268, 284, 313, 333-336, 338, 345->373, 348, 351->358, 356->358, 370->346, 384, 388, 402, 404, 408, 426, 446, 459-460, 482-501, 505->509, 506->505, 546, 577, 605-610, 625, 637-638, 658-664, 686, 690, 693, 696-698, 758-762, 787, 805, 808, 814->813, 830-836
hippique_orchestrator/snapshot_manager.py                       34      0      6      0   100%
hippique_orchestrator/source_registry.py                        76     49     18      0    29%   50-51, 69-105, 116-136, 150-184
hippique_orchestrator/sources/__init__.py                        0      0      0      0   100%
hippique_orchestrator/sources/boturfers_provider.py            183    160     68      0     9%   30-45, 53-136, 147-193, 201-204, 207-261, 264-320, 335-339
hippique_orchestrator/sources/france_galop_provider.py          21      9      2      0    52%   24-28, 39-43, 57-70
hippique_orchestrator/sources/geny_provider.py                  73     14     18      4    80%   40-48, 63->83, 67, 76->64, 85-86, 135->138, 144, 155
hippique_orchestrator/sources/letrot_provider.py                73     50     20      0    25%   39-50, 57-87, 105-138, 142, 145
hippique_orchestrator/sources/zeturf_provider.py               132     27     44     13    73%   38-39, 60->65, 61->65, 96-102, 116-120, 126, 129->131, 131->135, 135->143, 136->139, 139->143, 145-153, 169->172, 178, 182, 189-191, 196-197
hippique_orchestrator/sources/zoneturf_chrono_provider.py      164    136     72      0    12%   43-47, 58-62, 76-102, 106-113, 117-126, 129-165, 171-227, 231-237, 241
hippique_orchestrator/sources_interfaces.py                     20      3      0      0    85%   76, 92, 107
hippique_orchestrator/stats_fetcher.py                          45      3      8      0    94%   114-118
hippique_orchestrator/stats_provider.py                        299     27    102     16    89%   153, 159, 166-167, 178, 190, 214-215, 237-243, 248-251, 254-256, 288-289, 312->310, 317->310, 328, 331->324, 389->387, 394-395, 401->387, 453->451, 458-459, 465->451
hippique_orchestrator/tickets_store.py                          67      0      6      1    99%   137->131
hippique_orchestrator/time_utils.py                             14      0      2      0   100%
hippique_orchestrator/validator_ev.py                          320     32    142     13    88%   29, 39-41, 54-55, 384->388, 387, 404-405, 415-421, 432->441, 435, 450, 471, 481, 485, 518, 565-566, 582-589
hippique_orchestrator/zoneturf_client.py                       252     29    116     22    86%   48-49, 59, 87-90, 115->130, 127, 135->173, 142->169, 160->166, 163->166, 167, 170, 186, 194-195, 217-223, 262->286, 267->272, 274->279, 281->286, 297, 312, 333-335, 348, 370-372
--------------------------------------------------------------------------------------------------------
TOTAL                                                         9400   2432   3574    525    71%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_analysis_drift.py::test_drift_is_detected_and_applied - Att...
FAILED tests/test_api_endpoints.py::test_api_pronostics_default_date_is_today
FAILED tests/test_api_endpoints.py::test_api_pronostics_etag_304_not_modified
FAILED tests/test_api_endpoints.py::test_api_pronostics_rich_response_structure
FAILED tests/test_data_source.py::test_fetch_race_details_routes_to_boturfers[https://www.boturfers.fr/c/2025-01-01/r1c1-hippique_orchestrator.data_source.source_registry.fetch_snapshot]
FAILED tests/test_data_source.py::test_fetch_race_details_routes_to_boturfers[http://some-other-site.com/race-hippique_orchestrator.data_source.source_registry.fetch_snapshot]
FAILED tests/test_data_source.py::test_fetch_race_details_routes_to_zeturf[https://www.zeturf.fr/fr/course/2025-12-25/R1C2-test-hippique_orchestrator.data_source.source_registry.fetch_snapshot]
FAILED tests/test_data_source.py::test_fetch_race_details_routes_to_zeturf[http://zeturf.com/R1C1-hippique_orchestrator.data_source.source_registry.fetch_snapshot]
FAILED tests/test_firestore_client.py::test_get_races_for_date_success - Type...
FAILED tests/test_firestore_client.py::test_get_races_for_date_empty - assert...
FAILED tests/test_firestore_client.py::test_get_races_for_date_handles_exception
FAILED tests/test_firestore_client.py::test_get_races_for_date_skips_if_db_not_available
FAILED tests/test_firestore_client.py::test_get_processing_status_for_date_success
FAILED tests/test_firestore_client.py::test_get_processing_status_for_date_db_not_available
FAILED tests/test_firestore_client.py::test_get_processing_status_for_date_empty_daily_plan
FAILED tests/test_firestore_client.py::test_get_processing_status_for_date_explicit_empty_plan_reason
FAILED tests/test_firestore_client.py::test_get_processing_status_for_date_unprocessed_races
FAILED tests/test_firestore_client.py::test_get_processing_status_for_date_error_decision
FAILED tests/test_firestore_client.py::test_get_processing_status_for_date_unknown_decision
FAILED tests/test_firestore_client.py::test_get_races_for_date_db_unavailable
FAILED tests/test_firestore_client_extended.py::test_get_processing_status_for_date_processing_stalled
FAILED tests/test_firestore_client_extended.py::test_get_processing_status_for_date_db_empty
FAILED tests/test_gcs_client_extended.py::test_gcs_manager_list_files_success
FAILED tests/test_plan.py::test_build_plan_nominal_case - assert 0 == 2
FAILED tests/test_plan.py::test_build_plan_scraper_fails - assert 'Failed to ...
FAILED tests/test_plan.py::test_build_plan_handles_malformed_data - assert 0 ...
FAILED tests/test_plan.py::test_build_plan_partants_non_digit_string - assert...
FAILED tests/test_plan.py::test_build_plan_handles_compact_rc_format - assert...
FAILED tests/test_plan_extended.py::test_build_plan_handles_various_invalid_rc_formats
FAILED tests/test_plan_extended.py::test_build_plan_data_types - assert 0 == 1
FAILED tests/test_plan_extended.py::test_build_plan_invalid_runners_count - a...
FAILED tests/test_plan_extended.py::test_build_plan_mandatory_keys - assert 0...
FAILED tests/test_stats_provider.py::TestZoneTurfIdResolution::test_resolve_entity_id_scraping
ERROR tests/scripts/test_online_fetch_zeturf.py::test_fallback_parse_html_extracts_data
ERROR tests/scripts/test_online_fetch_zeturf_extended.py::test_fallback_parse_html_no_runners_table
ERROR tests/scripts/test_online_fetch_zeturf_extended.py::test_fallback_parse_html_runner_missing_data
ERROR tests/test_fetch_je_stats.py::test_extract_links_from_horse_page - File...
ERROR tests/test_fetch_je_stats.py::test_extract_rate_from_profile - FileNotF...
ERROR tests/test_fetch_je_stats.py::test_discover_horse_url_by_name - FileNot...
ERROR tests/test_fetch_je_stats.py::test_parse_horse_percentages_success - Fi...
ERROR tests/test_fetch_je_stats.py::test_collect_stats_edge_cases[h5_data0-0-0-None]
ERROR tests/test_fetch_je_stats.py::test_collect_stats_edge_cases[h5_data1-0-1-]
ERROR tests/test_fetch_je_stats.py::test_collect_stats_edge_cases[h5_data2-0-1-]
ERROR tests/test_fetch_je_stats.py::test_collect_stats_edge_cases[h5_data3-100-1-]
ERROR tests/test_fetch_je_stats.py::test_collect_stats_local_filesystem - Fil...
ERROR tests/test_fetch_je_stats.py::test_collect_stats_integration - FileNotF...
ERROR tests/test_scraper_boturfers.py::test_fetcher_parse_programme_success
ERROR tests/test_scraper_boturfers.py::test_fetcher_parse_programme_no_reunion_tabs
ERROR tests/test_scraper_boturfers.py::test_fetcher_parse_distance_success - ...
ERROR tests/test_scraper_boturfers.py::test_fetcher_parse_race_metadata_success
ERROR tests/test_scraper_boturfers.py::test_fetcher_parse_race_runners_from_details_page_success
ERROR tests/test_scraper_boturfers.py::test_fetcher_parse_race_runners_from_details_page_malformed_row
ERROR tests/test_scraper_boturfers.py::test_fetcher_get_snapshot_success - As...
ERROR tests/test_scraper_boturfers.py::test_fetcher_get_race_snapshot_success
ERROR tests/test_scraper_boturfers.py::test_fetch_boturfers_programme_success
ERROR tests/test_scraper_boturfers.py::test_fetch_boturfers_programme_no_races_returned
ERROR tests/test_scraper_boturfers.py::test_fetch_boturfers_race_details_success
ERROR tests/test_scraper_boturfers.py::test_fetcher_parse_race_metadata_missing_conditions
ERROR tests/test_scraper_boturfers_robustness.py::test_parse_programme_handles_broken_reunion_class
ERROR tests/test_scraper_boturfers_robustness.py::test_parse_programme_handles_missing_race_table
ERROR tests/test_scraper_boturfers_robustness.py::test_parse_programme_from_static_fixture
ERROR tests/test_scraper_boturfers_robustness.py::test_parse_race_details_from_static_fixture
ERROR tests/test_scraper_boturfers_robustness.py::test_programme_fixture_has_expected_structure
ERROR tests/test_scraper_geny.py::test_fetch_geny_programme_success - FileNot...
ERROR tests/test_zoneturf_client.py::test_resolve_horse_id_success - Failed: ...
ERROR tests/test_zoneturf_client.py::test_resolve_horse_id_not_found - Failed...
ERROR tests/test_zoneturf_client.py::test_resolve_person_id_success - Failed:...
ERROR tests/test_zoneturf_client.py::test_resolve_person_id_not_found - Faile...
ERROR tests/test_zoneturf_client.py::test_fetch_chrono_from_html_with_jullou_page
ERROR tests/test_zoneturf_client.py::test_fetch_person_stats_from_html_success
ERROR tests/test_zoneturf_client.py::test_get_chrono_stats_success - Failed: ...
ERROR tests/test_zoneturf_client.py::test_get_jockey_trainer_stats_success - ...
================= 33 failed, 1072 passed, 39 errors in 52.88s ==================
